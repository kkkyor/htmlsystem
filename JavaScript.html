const loader = document.getElementById('loader');
let currentAssignmentId = null; 

const PAGE_SIZE = 30;
let currentFilters = {};
let currentOffset = 0;
let totalCustomerCount = 0;

// [ì œê±°] BroadcastChannel

function showLoader() { 
  loader.classList.remove('hidden'); 
  document.querySelectorAll('button, input, select, textarea').forEach(el => {
    if (el.closest('.modal-content') || el.closest('.error-modal-content')) return; 
    el.disabled = true;
  });
}

function escapeHtml(text) {
  if (text === null || text === undefined) return '';
  const str = String(text);
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function hideLoader() { 
  loader.classList.add('hidden'); 
  document.querySelectorAll('button, input, select, textarea').forEach(el => {
    el.disabled = false;
  });
}

function showErrorModal(message, actions) {
  const existingErrorModal = document.querySelector('.error-modal-overlay');
  if (existingErrorModal) existingErrorModal.remove();

  const modal = document.createElement('div');
  modal.className = 'modal-overlay error-modal-overlay';
  modal.style.zIndex = '100003';

  const contentDiv = document.createElement('div');
  contentDiv.className = 'error-modal-content';
  contentDiv.innerHTML = `<h3>âš ï¸ ì˜¤ë¥˜ ë°œìƒ</h3>`;
  
  const messageP = document.createElement('p');
  messageP.textContent = message; 
  messageP.style.margin = '20px 0';
  messageP.style.fontSize = '1.1rem';
  contentDiv.appendChild(messageP);

  const actionsDiv = document.createElement('div');
  actionsDiv.className = 'modal-actions';
  actionsDiv.style.justifyContent = 'flex-end';
  actionsDiv.style.gap = '10px'; 

  if (!actions || actions.length === 0) {
    const okButton = document.createElement('button');
    okButton.className = 'error-modal-btn'; 
    okButton.textContent = 'í™•ì¸';
    okButton.onclick = () => modal.remove();
    actionsDiv.appendChild(okButton);
  } else {
    actions.forEach(action => {
      const button = document.createElement('button');
      button.textContent = action.text;
      
      if (action.isPrimary) {
        button.className = 'error-modal-btn'; 
      } else {
        button.className = 'secondary'; 
      }
      
      button.onclick = () => {
        if (action.action) {
          action.action(); 
        }
        modal.remove(); 
      };
      actionsDiv.appendChild(button);
    });
  }

  contentDiv.appendChild(actionsDiv);
  modal.appendChild(contentDiv);
  document.body.appendChild(modal);
}

function handleFailure(error) {
  hideLoader();
  console.error("Apps Script Error:", error);
  
  const msg = error.message;
  let userMessage = `ì˜¤ë¥˜ ë°œìƒ: ${msg}`; 
  let actions = []; 

  if (msg.includes("ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")) {
    userMessage = "ìš”ì²­í•˜ì‹  ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.";
    actions = [
      { text: 'ìƒˆë¡œê³ ì¹¨', action: () => window.location.reload(), isPrimary: true }
    ];
  } else if (msg.includes("ê¶Œí•œ")) {
    userMessage = "ì´ ì‘ì—…ì„ ìˆ˜í–‰í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ì˜ˆ: ë³¸ì¸ ê³ ê°ì´ ì•„ë‹™ë‹ˆë‹¤.)";
  } else if (msg.includes("ì‹œìŠ¤í…œì´") && msg.includes("í˜¼ì¡í•©ë‹ˆë‹¤")) {
    userMessage = "ì‹œìŠ¤í…œì´ í˜„ì¬ ë§¤ìš° í˜¼ì¡í•©ë‹ˆë‹¤. (ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë™ì‹œ ì €ì¥ ì¤‘) ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
  } else if (msg.includes("ìƒë‹´ ê¸°ë¡ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤")) {
    userMessage = msg; 
  } else if (msg.includes("timeout") || msg.includes("ì‹œê°„") || msg.includes("NetworkError")) {
    userMessage = "ì„œë²„ ì‘ë‹µ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆê±°ë‚˜ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
  } else {
    userMessage = "ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì‹œìŠ¤í…œì„ ì¬ì‹œì‘í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.";
    actions = [
      { text: 'ì·¨ì†Œ', action: null, isPrimary: false }, 
      { text: 'ìƒˆë¡œê³ ì¹¨', action: () => window.location.reload(), isPrimary: true }
    ];
  }
  
  showErrorModal(userMessage, actions);
}
 
  function formatPhoneNumber_Client(phone) {
    if (!phone) return "";
    const digits = phone.replace(/\D/g, "");
    if (digits.length === 11) return `${digits.substring(0, 3)}-${digits.substring(3, 7)}-${digits.substring(7)}`;
    if (digits.length === 10) return `${digits.substring(0, 3)}-${digits.substring(3, 6)}-${digits.substring(6)}`;
    return phone;
  }

function populateSelectOptions(config) {
  const optionsMap = config.selectOptions; 
  if (!optionsMap) {
    console.error("Select options not found in config object.");
    return;
  }

  // Helper function to populate a single select element
  const populate = (elementId, optionsArray) => {
    const selectElement = document.getElementById(elementId);
    if (selectElement) {
      const firstOption = selectElement.options[0]?.value === "" ? selectElement.options[0] : null;
      selectElement.innerHTML = ''; 
      if (firstOption) {
        selectElement.appendChild(firstOption); 
      }
      optionsArray.forEach(optionValue => {
        const option = document.createElement('option');
        option.value = optionValue;
        option.textContent = optionValue;
        selectElement.appendChild(option);
      });
    }
  };

  // --- ê° select ìš”ì†Œì— ì˜µì…˜ ì±„ìš°ê¸° ---
  populate('filterDbType', config.dbTypes || []); 
  populate('newDbType', config.dbTypes || []);
  populate('leadSource', optionsMap.leadSource || []);
  populate('ageGroup', optionsMap.ageGroup || []);
  populate('addressCity', optionsMap.addressCities || []); 
  populate('incomeType', optionsMap.incomeType || []);
  populate('creditInfo', optionsMap.creditInfo || []);
  populate('carUsage', optionsMap.carUsage || []);
  populate('expectedContractTiming', optionsMap.expectedContractTiming || []);
  populate('desiredContractTerm', optionsMap.desiredContractTerm || []);
  populate('desiredInitialCostType', optionsMap.desiredInitialCostType || []);
  populate('maintenanceServiceLevel', optionsMap.maintenanceServiceLevel || []);
  populate('customerStatus', optionsMap.customerStatus || []);
}

  function getStatusClass(consultStatus, contractStatus) {
    if (contractStatus === 'ê³„ì•½ ì²´ê²°') return 'contracted';
    if (contractStatus === 'ê³„ì•½ ë¬´ì‚°') return 'failed';
    if (consultStatus === 'ìƒë‹´ ì™„ë£Œ') return 'completed';
    if (consultStatus === 'ìƒë‹´ ì§„í–‰ ì¤‘' || consultStatus === 'ì—°ë½ ì‹œë„ ì¤‘') return 'consulting';
    return '';
  }

  function buildCustomerLi(customer) {
      const li = document.createElement('li');
      li.tabIndex = 0;
      li.dataset.assignmentId = customer.assignmentId;
      
      // --- ë°ì´í„° í¬ë§·íŒ… ---
      const phone = customer.customerPhoneNumber ? formatPhoneNumber_Client(customer.customerPhoneNumber) : 'ë²ˆí˜¸ ì—†ìŒ';
      
      let lastLogText = 'ê¸°ë¡ ì—†ìŒ'; // ìµœì¢… ë¡œê·¸ *ì‹œê°„*
      if (customer.lastLogDate) {
      try {
        const logDate = new Date(customer.lastLogDate);
        if (!isNaN(logDate.getTime())) {
          lastLogText = "ìµœì¢…: " + logDate.toLocaleString('ko-KR', {
            month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
          });
        } else {
          lastLogText = 'ê¸°ë¡ (ë‚ ì§œì˜¤ë¥˜)';
        }
      } catch (e) {
        lastLogText = 'ê¸°ë¡ (ë³€í™˜ì˜¤ë¥˜)';
      }
      }

      const consult = customer.consultationStatus || 'ë¯¸ì •';
      const contract = customer.contractStatus || 'ë¯¸ì •';
      const statusName = (contract !== 'ë¯¸í•´ë‹¹' && contract !== 'ë¯¸ì •') ? contract : consult;
      const statusClass = getStatusClass(consult, contract);
      
      const dbType = customer.dbType || 'ê¸°íƒ€';
      
      // â–¼â–¼â–¼ [ìˆ˜ì •] 'ê´€ì‹¬ ì°¨ì¢…' ëŒ€ì‹  'ê³ ê° ë©”ëª¨' ë°ì´í„° ì¶”ì¶œ â–¼â–¼â–¼
      const memo = customer.customerMemo || '...'; // 'ë©”ëª¨'ê°€ ì—†ìœ¼ë©´ '...' í‘œì‹œ
      
      // â–¼â–¼â–¼ [ìˆ˜ì •] HTML êµ¬ì¡° ë³€ê²½ (model -> memo) â–¼â–¼â–¼
      li.innerHTML = `
        <span class="li-item dbtype" title="${escapeHtml(dbType)}">
          ${escapeHtml(dbType)}
        </span>
        <span class="li-item status">
          <span class="status-badge ${statusClass}">${escapeHtml(statusName)}</span>
        </span>
        <span class="li-item name" title="${escapeHtml(customer.customerName)}">
          ${escapeHtml(customer.customerName)}
        </span>
        <span class="li-item phone" title="${escapeHtml(phone)}">
          ${escapeHtml(phone)}
        </span>
        
        <span class="li-item memo" title="${escapeHtml(memo)}">
          ${escapeHtml(memo)}
        </span>
        
        <span class="li-item log" title="${escapeHtml(lastLogText)}">
          ${escapeHtml(lastLogText)}
        </span>
      `;
      // â–²â–²â–² [ìˆ˜ì •] â–²â–²â–²
      
      return li;
  }

  function displayAssignedCustomers(customers, isNewSearch) {
    const ul = document.getElementById('assignedCustomersList');
    if (!ul) return; 

    const loadMoreBtn = document.getElementById('loadMoreBtn');
    
    if (isNewSearch) {
      ul.innerHTML = '';
    }
    
    const loadingLi = ul.querySelector('.skeleton-li'); 
    if (loadingLi) {
      ul.innerHTML = ''; 
    }

    if (customers.length === 0 && isNewSearch) {
      ul.innerHTML = '<li>ì¡°ê±´ì— ë§ëŠ” ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
    } else {
      customers.forEach(customer => {
        const li = buildCustomerLi(customer);
        ul.appendChild(li);
      });
    }

    const currentLoadedCount = ul.querySelectorAll('li[data-assignment-id]').length;
    if (currentLoadedCount < totalCustomerCount) {
      loadMoreBtn.classList.remove('hidden');
    } else {
      loadMoreBtn.classList.add('hidden');
    }
    loadMoreBtn.disabled = false;
  }

function updateListItem(assignment) {
  try {
    const liToUpdate = document.querySelector(`#assignedCustomersList li[data-assignment-id="${assignment.assignmentId}"]`);
    if (!liToUpdate) return;
    
    const newLi = buildCustomerLi(assignment);
    liToUpdate.innerHTML = newLi.innerHTML;
    
    // ToDo ëª©ë¡ì—ì„œë„ ì—…ë°ì´íŠ¸ (ì„ íƒ ì‚¬í•­, ì¶”í›„ êµ¬í˜„)
    // const todoLi = document.querySelector(`#todoCustomersList li[data-assignment-id="${assignment.assignmentId}"]`);
    // if (todoLi) { ... }
    
    liToUpdate.classList.remove('flash-success');
    void liToUpdate.offsetWidth; 
    liToUpdate.classList.add('flash-success');
    
  } catch (e) {
    console.error("Failed to update list item:", e);
  }
}

// â˜… [ìˆ˜ì •] rootElementëŠ” ì´ì œ '.detail-log-pane'ì´ ë©ë‹ˆë‹¤.
function renderConsultationLogs_Dynamic(logs, rootElement) {
  const logsDiv = rootElement.querySelector('#consultationLogs');
  if (!logsDiv) {
      console.error("Could not find #consultationLogs div in rootElement", rootElement);
      return;
  }
  
  logsDiv.innerHTML = (!logs || logs.length === 0) ? '<p style="padding: 20px; text-align: center; color: #777;">ìƒë‹´ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>' : '';
  if (!logs) return;

  logs.sort((a, b) => new Date(b.logTimestamp) - new Date(a.logTimestamp));
  
  logs.forEach(log => {
    const logEntryDiv = document.createElement('div');
    logEntryDiv.className = 'log-entry';

    const dateStrong = document.createElement('strong');
    dateStrong.textContent = log.logTimestamp ? 
      new Date(log.logTimestamp).toLocaleString('ko-KR') : 'ë‚ ì§œ ì—†ìŒ'; 

    const contentDiv = document.createElement('div');
    contentDiv.textContent = log.logContent || ''; 
    contentDiv.style.whiteSpace = 'pre-wrap'; 

    logEntryDiv.appendChild(dateStrong);
    logEntryDiv.appendChild(document.createElement('br'));
    logEntryDiv.appendChild(contentDiv);
    
    logsDiv.appendChild(logEntryDiv);
  });
}

function showSaveFeedback(buttonElement) {
  const originalText = buttonElement.textContent;
  buttonElement.textContent = "âœ… ì €ì¥ ì™„ë£Œ";
  buttonElement.disabled = true;
  setTimeout(() => {
    buttonElement.textContent = originalText;
    buttonElement.disabled = false;
  }, 2000);
}

// â˜… [ìˆ˜ì •] panelElementëŠ” ì´ì œ '.detail-panel'ì´ ë©ë‹ˆë‹¤.
function handleSavePhoneNumber(panelElement, assignmentId, saveBtn) {
  if (!assignmentId) return;
  // .detail-info-pane ë‚´ë¶€ì˜ ìš”ì†Œë¥¼ ì°¾ìŠµë‹ˆë‹¤.
  const phoneInput = panelElement.querySelector('#detailCustomerPhoneNumber');
  phoneInput.value = formatPhoneNumber_Client(phoneInput.value);
  
  showLoader();
  google.script.run
    .withSuccessHandler(result => {
      hideLoader();
      displayAssignmentDetails_Dynamic(result, panelElement); // â˜… ì •ë³´ íŒ¨ë„(ì¢Œì¸¡)ë§Œ ë¦¬í”„ë ˆì‹œ
      showSaveFeedback(saveBtn); 
      updateListItem(result.assignment);
    })
    .withFailureHandler(handleFailure)
    .saveCustomerDetails(assignmentId, { customerPhoneNumber: phoneInput.value });
}

// â˜… [ìˆ˜ì •] panelElementëŠ” .detail-panel
function handleSaveCustomerDetails(panelElement, assignmentId, saveBtn) {
  if (!assignmentId) return;

  const detailFields = [
    'leadSource', 'customerType', 'gender', 'ageGroup', 'addressCity', 'addressDistrict',
    'incomeType', 'creditInfo', 
    'interestedCarModel', 'comparisonCarModel', 'ownedCarModel', 'carUsage', 'driverScope',
    'expectedContractTiming', 'desiredContractTerm', 'desiredInitialCostType',
    'maintenanceServiceLevel', 'salesCondition', 'isRepurchase', 'paymentMethod',
    'customerStatus', 'consultationStatus', 'contractStatus','customerMemo'
  ];

  const details = {};
  detailFields.forEach(fieldId => {
    // â˜… [ìˆ˜ì •] panelElement(.detail-panel) ë‚´ë¶€ì—ì„œ ID ê²€ìƒ‰
    const element = panelElement.querySelector('#' + fieldId);
    if (element) {
        if ('value' in element) {
             details[fieldId] = element.value.trim();
        }
    }
  });

  console.log("Saving details:", details); 

  showLoader();
  google.script.run
    .withSuccessHandler(result => {
      hideLoader();
      displayAssignmentDetails_Dynamic(result, panelElement); // â˜… ì •ë³´ íŒ¨ë„(ì¢Œì¸¡)ë§Œ ë¦¬í”„ë ˆì‹œ
      showSaveFeedback(saveBtn);
      updateListItem(result.assignment); 
    })
    .withFailureHandler(handleFailure)
    .saveCustomerDetails(assignmentId, details); 
}

// â˜… [ìˆ˜ì •] panelElementëŠ” .detail-panel
function handleSaveContractDetails(panelElement, assignmentId, saveBtn) {
  if (!assignmentId) return;
  const contractDetails = {};
  const fields = ['contractDate', 'contractSummary', 'contractAmount', 'contractFileInfo', 'contractReview'];
  fields.forEach(field => { contractDetails[field] = panelElement.querySelector('#' + field).value.trim(); });
  contractDetails.contractAmount = contractDetails.contractAmount ? parseFloat(contractDetails.contractAmount) : null;

  showLoader();
  google.script.run
    .withSuccessHandler(result => {
      hideLoader();
      displayAssignmentDetails_Dynamic(result, panelElement); // â˜… ì •ë³´ íŒ¨ë„(ì¢Œì¸¡)ë§Œ ë¦¬í”„ë ˆì‹œ
      showSaveFeedback(saveBtn); 
      updateListItem(result.assignment);
    })
    .withFailureHandler(handleFailure)
    .saveContractDetails(assignmentId, contractDetails);
}

// â˜… [ìˆ˜ì •] panelElementëŠ” ì´ì œ '.detail-log-pane'ì´ ë©ë‹ˆë‹¤.
function handleAddLog(panelElement, assignmentId) {
  if (!assignmentId) return;
  const contentEl = panelElement.querySelector('#newLogContent');
  const content = contentEl.value.trim();
  if (!content) {
    showErrorModal("ê¸°ë¡ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }
  
  showLoader();
  google.script.run
    .withSuccessHandler(result => { 
      hideLoader();
      renderConsultationLogs_Dynamic(result.logs, panelElement); // â˜… ë¡œê·¸ íŒ¨ë„(ìš°ì¸¡)ë§Œ ë¦¬í”„ë ˆì‹œ
      contentEl.value = ''; 
      updateListItem(result.assignment); // ëª©ë¡ì˜ 'ìµœì¢…ìƒë‹´ì¼' ì—…ë°ì´íŠ¸
    })
    .withFailureHandler(handleFailure)
    .addConsultationLog(assignmentId, content);
}

// â˜… [ìˆ˜ì •] ë·° ì „í™˜ ë¡œì§ì— ë§ê²Œ ë¦¬ìŠ¤ë„ˆ ì¬êµ¬ì„±
function attachDetailPanelListeners() {
  const panelElement = document.getElementById('customerDetailPanel');
  if (!panelElement) {
    return;
  }

  // â˜… ì´ë²¤íŠ¸ ìœ„ì„ì„ ì‚¬ìš©í•˜ì—¬ .detail-panel(.detail-info-pane + .detail-log-pane) ì „ì²´ì— ë¦¬ìŠ¤ë„ˆ ë¶€ì°©
  panelElement.addEventListener('click', e => {
    const target = e.target;
    const targetId = target.id;
    const assignmentId = currentAssignmentId; 

    // ê³µí†µ: assignmentIdê°€ ì—†ìœ¼ë©´ ì €ì¥/ì¶”ê°€ë¥˜ ë™ì‘ ë°©ì§€
    if (!assignmentId && (targetId === 'savePhoneNumberBtn' || targetId === 'saveCustomerDetailsBtn' || targetId === 'saveContractBtn' || targetId === 'addLogBtn')) {
      // 'ë’¤ë¡œê°€ê¸°'ëŠ” ì˜ˆì™¸
      if (targetId === 'backToListBtn') {
         // pass
      } else {
        console.error("No currentAssignmentId set for save/add action.");
        return;
      }
    }

    switch (targetId) {
      // --- ë·° ì „í™˜ ---
      case 'backToListBtn':
        e.preventDefault();
        panelElement.classList.add('hidden'); // ìƒì„¸ ë·° ìˆ¨ê¸°ê¸°
        document.getElementById('listPanel').classList.remove('hidden'); // ëª©ë¡ ë·° í‘œì‹œ
        
        // ëª©ë¡ í™œì„±í™” í•´ì œ
        const currentActive = document.querySelector('#assignedCustomersList li.active');
        if (currentActive) currentActive.classList.remove('active');
        currentAssignmentId = null; 
        break;
        
      // --- ì •ë³´ íŒ¨ë„(.detail-info-pane) ë²„íŠ¼ ---
      case 'savePhoneNumberBtn':
        handleSavePhoneNumber(panelElement, assignmentId, target);
        break;
      
      case 'saveCustomerDetailsBtn':
        handleSaveCustomerDetails(panelElement, assignmentId, target);
        break;
      
      case 'saveContractBtn':
        handleSaveContractDetails(panelElement, assignmentId, target);
        break;

      case 'toggleCustomerInfoBtn':
        e.preventDefault();
        // â˜… panelElement ë‚´ë¶€ì—ì„œ #customerInfoGroup ì°¾ê¸°
        const infoGroup = panelElement.querySelector('#customerInfoGroup');
        if (infoGroup) {
          const isHidden = infoGroup.classList.toggle('hidden');
          target.textContent = isHidden ? 'ìƒì„¸ ì •ë³´ ë³´ì´ê¸°' : 'ìƒì„¸ ì •ë³´ ìˆ¨ê¸°ê¸°';
        }
        break; 

      // --- ë¡œê·¸ íŒ¨ë„(.detail-log-pane) ë²„íŠ¼ ---
      case 'addLogBtn':
         // â˜… handleAddLogëŠ” .detail-log-paneì„ ì¸ìë¡œ ë°›ì•„ì•¼ í•¨
         const logPanel = panelElement.querySelector('.detail-log-pane');
         if (logPanel) {
           handleAddLog(logPanel, assignmentId);
         }
        break;
    }
  });

  // ê³„ì•½ ìƒíƒœ <select> ë¦¬ìŠ¤ë„ˆ (detail-info-pane ì†Œì†)
  const contractStatusSelect = panelElement.querySelector('#contractStatus');
  if (contractStatusSelect) {
    contractStatusSelect.addEventListener('change', e => {
        panelElement.querySelector('#contractInfoSection').classList.toggle('hidden', e.target.value !== 'ê³„ì•½ ì²´ê²°');
    });
  }
}

// â˜… [ìˆ˜ì •] ë·° ì „í™˜ ë¡œì§ ë³µì›
function selectCustomer(assignmentId) {
  showLoader();

  google.script.run
    .withSuccessHandler(result => {
      console.log("ì„œë²„ì—ì„œ ë°›ì€ ì‘ë‹µ:", result); 
      
      // â˜… [ìˆ˜ì •] ë·° ì „í™˜
      document.getElementById('listPanel').classList.add('hidden');
      
      const panelElement = document.getElementById('customerDetailPanel');
      
      // 1. ìƒì„¸ ì •ë³´ íŒ¨ë„(ì¢Œì¸¡) ì±„ìš°ê¸°
      displayAssignmentDetails_Dynamic(result, panelElement); 
      
      // 2. ìƒë‹´ ê¸°ë¡ íŒ¨ë„(ìš°ì¸¡) ì±„ìš°ê¸°
      const logPanel = panelElement.querySelector('.detail-log-pane');
      if(logPanel) {
        renderConsultationLogs_Dynamic(result.logs, logPanel);
        
        // 3. ìƒˆ ìƒë‹´ ê¸°ë¡ ì…ë ¥ì°½ ë¹„ìš°ê¸° (logPanel ë‚´ë¶€)
        const newLogContentEl = logPanel.querySelector('#newLogContent');
        if (newLogContentEl) newLogContentEl.value = '';
      }

      panelElement.classList.remove('hidden'); // â˜… ìƒì„¸ ë·° í‘œì‹œ

      // ëª©ë¡ í™œì„±í™” (ì „í™˜ í›„ì—ë„ ìœ ì§€)
      document.querySelectorAll('#assignedCustomersList li').forEach(item => {
        item.classList.toggle('active', item.dataset.assignmentId === assignmentId);
      });
      
      // â˜… [ì‹ ê·œ] ì¢Œì¸¡ ì •ë³´ íŒ¨ë„ì˜ ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ ì´ë™
      const infoPane = panelElement.querySelector('.detail-info-pane');
      if (infoPane) infoPane.scrollTop = 0;
      
      hideLoader();
    })
    .withFailureHandler(handleFailure)
    .getAssignmentDetails(assignmentId);
}

  function fetchCustomers(isNewSearch = false) {
    if (!document.getElementById('loadMoreBtn')) return;

    if (isNewSearch) {
      currentOffset = 0; 
      document.getElementById('loadMoreBtn').classList.add('hidden'); 
      showSkeletonLoader(); 
      currentFilters = {
      searchTerm: document.getElementById('filterSearchTerm').value,
      dateFrom: document.getElementById('filterAssignmentDateFrom').value,
      dateTo: document.getElementById('filterAssignmentDateTo').value,
      consultStatus: document.getElementById('filterConsultationStatus').value,
      contractStatus: document.getElementById('filterContractStatus').value,
      dbType: document.getElementById('filterDbType').value
      };
    } else {
      currentOffset += PAGE_SIZE;
      document.getElementById('loadMoreBtn').disabled = true; 
    }

    const filtersToSend = {
      ...currentFilters,
      limit: PAGE_SIZE,
      offset: currentOffset 
    };

    if (!isNewSearch) {
      showLoader();
    }
    
    google.script.run
      .withSuccessHandler(result => {
        if (isNewSearch) {
        } else {
          hideLoader();
        }
        
        totalCustomerCount = result.totalCount; 
        displayAssignedCustomers(result.customers, isNewSearch);
      })
      .withFailureHandler(error => {
        handleFailure(error);
        if (isNewSearch) {
          document.getElementById('assignedCustomersList').innerHTML = '<li>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í•„í„°ë¥¼ ë‹¤ì‹œ ì ìš©í•´ì£¼ì„¸ìš”.</li>';
        }
        if (!isNewSearch) document.getElementById('loadMoreBtn').disabled = false;
      })
      .getAssignedCustomers(filtersToSend);
  }
  
  function showSkeletonLoader() {
    const ul = document.getElementById('assignedCustomersList');
    if (!ul) return; 
    ul.innerHTML = ''; 
    for (let i = 0; i < 5; i++) { 
      const li = document.createElement('li');
      li.className = 'skeleton-li';
      li.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <div class="skeleton-item line-1"></div>
          <div class="skeleton-item" style="height: 20px; width: 60px;"></div>
        </div>
        <div class="skeleton-item line-2"></div>
        <div class="skeleton-item line-3"></div>
      `;
      ul.appendChild(li);
    }
  }

document.addEventListener('DOMContentLoaded', () => {

  const SCRIPT_URL = document.body.dataset.scriptUrl; 

  // â˜… [ìˆ˜ì •] ìƒì„¸ íŒ¨ë„ ë¦¬ìŠ¤ë„ˆ (ë·° ì „í™˜ ë¡œì§ í¬í•¨)
  attachDetailPanelListeners(); 

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      // â˜… [ì‹ ê·œ] Escape í‚¤ë¡œ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
      const dynamicPanel = document.getElementById('customerDetailPanel');
      if (dynamicPanel && !dynamicPanel.classList.contains('hidden')) { 
        dynamicPanel.querySelector('#backToListBtn').click();
      }
    }
    
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      const searchBox = document.getElementById('filterSearchTerm');
      if (searchBox) searchBox.focus(); 
    }
  });
  
  window.addEventListener('offline', () => {
    showErrorModal("ì¸í„°ë„· ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ë³€ê²½ ì‚¬í•­ì´ ì €ì¥ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
  });

  // -----------------------------------
  // â˜… [ìˆ˜ì •] ë·° 1: ëª©ë¡ í™”ë©´ (List View) ë¡œì§
  // -----------------------------------
  
  const listUl = document.getElementById('assignedCustomersList');
  const filterBtn = document.getElementById('applyFilterBtn');
  const resetBtn = document.getElementById('resetFilterBtn');
  const loadMoreBtn = document.getElementById('loadMoreBtn');
  const addCustomerModal = document.getElementById('addCustomerModal');
  const addCustomerBtn = document.getElementById('openAddCustomerModalBtn');
  const cancelAddBtn = document.getElementById('cancelAddCustomerBtn');
  const saveNewBtn = document.getElementById('saveNewCustomerBtn');
  const newNameInput = document.getElementById('newCustomerName');
  const newPhoneInput = document.getElementById('newCustomerPhoneNumber');

  // 1. ë©”ì¸ ëª©ë¡(ìš°ì¸¡) í´ë¦­
  listUl.addEventListener('click', e => {
    const li = e.target.closest('li');
    if (li && li.dataset.assignmentId) {
      const assignmentId = li.dataset.assignmentId;
      selectCustomer(assignmentId); // â˜… ë·° ì „í™˜ í•¨ìˆ˜ í˜¸ì¶œ
    }
  });
  
  listUl.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') {
      const li = e.target.closest('li');
      if (li && li.dataset.assignmentId) {
        e.preventDefault();
        const assignmentId = li.dataset.assignmentId;
        selectCustomer(assignmentId); // â˜… ë·° ì „í™˜ í•¨ìˆ˜ í˜¸ì¶œ
      }
    }
  });
  
  // 2. [ì‹ ê·œ] ToDo ëª©ë¡(ì¢Œì¸¡) í´ë¦­ (ê¸°ëŠ¥ì€ ë™ì¼í•˜ê²Œ selectCustomer í˜¸ì¶œ)
  const todoListUl = document.getElementById('todoCustomersList');
  if (todoListUl) {
      todoListUl.addEventListener('click', e => {
        const li = e.target.closest('li[data-assignment-id]'); // â˜… data-assignment-idê°€ ìˆëŠ” lië§Œ
        if (li) {
            const assignmentId = li.dataset.assignmentId;
            selectCustomer(assignmentId);
        }
      });
      // (ToDo ëª©ë¡ì— ëŒ€í•œ í‚¤ë³´ë“œ íƒìƒ‰ë„ ë™ì¼í•˜ê²Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)
  }


  // --- í•„í„°, ë”ë³´ê¸°, ì‹ ê·œ ê³ ê° ì¶”ê°€ ë¦¬ìŠ¤ë„ˆ (ë³€ê²½ ì—†ìŒ) ---
  filterBtn.addEventListener('click', () => fetchCustomers(true));

  resetBtn.addEventListener('click', () => {
    document.getElementById('filterSearchTerm').value = '';
    document.getElementById('filterDbType').value = '';
    document.getElementById('filterConsultationStatus').value = '';
    document.getElementById('filterContractStatus').value = '';
    const dateFromInput = document.getElementById('filterAssignmentDateFrom');
    const today = new Date();
    dateFromInput.value = new Date(today.setMonth(today.getMonth() - 3)).toISOString().split('T')[0];
    document.getElementById('filterAssignmentDateTo').value = '';
    fetchCustomers(true); 
  });
  
  loadMoreBtn.addEventListener('click', () => fetchCustomers(false));

  newPhoneInput.addEventListener('blur', (event) => {
    event.target.value = formatPhoneNumber_Client(event.target.value);
  });
  addCustomerBtn.addEventListener('click', () => addCustomerModal.classList.remove('hidden'));
  cancelAddBtn.addEventListener('click', () => {
    addCustomerModal.classList.add('hidden');
    newNameInput.value = ''; newPhoneInput.value = '';
  });

  saveNewBtn.addEventListener('click', () => {
    const name = newNameInput.value.trim();
    const phone = newPhoneInput.value.trim();
    if (!name) { showErrorModal("ê³ ê°ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }
    if (phone) {
    const digits = phone.replace(/\D/g, '');
    if (digits.length > 0 && (digits.length < 9 || digits.length > 11)) {
      showErrorModal("ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. (9~11ìë¦¬ ìˆ«ì)"); return;
    }
    }
    showLoader();
    google.script.run
    .withSuccessHandler(newCustomer => {
        hideLoader();
        const ul = document.getElementById('assignedCustomersList');
        const li = buildCustomerLi(newCustomer); 
        ul.prepend(li); 
        const noCustomerLi = ul.querySelector('li:first-child:not([data-assignment-id])');
        if (noCustomerLi && ul.children.length > 1) { 
          noCustomerLi.remove();
        }
        addCustomerModal.classList.add('hidden');
        newNameInput.value = '';
        newPhoneInput.value = '';
        // â˜… [ì‹ ê·œ] TODO: ToDo ëª©ë¡ì—ë„ ì¦‰ì‹œ ì¶”ê°€/ì œê±° ë¡œì§ í•„ìš”
    })
    .withFailureHandler(handleFailure)
    .addNewCustomer({
      customerName: name,
      customerPhoneNumber: phone,
      dbType: document.getElementById('newDbType').value
    });
  });

  // --- ì´ˆê¸° ë¡œë“œ (ë³€ê²½ ì—†ìŒ) ---
  // â˜… ì°¸ê³ : data-view ì†ì„±ì€ Code.gsì˜ doGetì—ì„œ 'list' ë˜ëŠ” 'detail'ì„ ë°›ì§€ë§Œ,
  // ì´ JSëŠ” í•´ë‹¹ ê°’ì„ ë¬´ì‹œí•˜ê³  í•­ìƒ 'list' ë·°ë¥¼ ë¨¼ì € ë¡œë“œí•˜ë„ë¡ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
  const dateFromInput = document.getElementById('filterAssignmentDateFrom');
  const today = new Date();
  dateFromInput.value = new Date(new Date().setMonth(today.getMonth() - 3)).toISOString().split('T')[0];
  showSkeletonLoader(); 

  console.log("ğŸš€ [Client] Calling getConfigurations..."); 

  google.script.run
    .withSuccessHandler(config => {
      console.log("âœ… getConfigurations SUCCESS:", config); 
      populateSelectOptions(config); 
      fetchCustomers(true); 
      // â˜… [ì‹ ê·œ] TODO: ì—¬ê¸°ì— fetchTodoCustomers() í˜¸ì¶œ ì¶”ê°€ í•„ìš”
      // ì˜ˆ: fetchTodoCustomers();
    })
    .withFailureHandler(error => {
      handleFailure(error);
      document.getElementById('assignedCustomersList').innerHTML = '<li>ì‹œìŠ¤í…œ ì„¤ì •(Config) ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</li>';
    })
    .getConfigurations();
  
  // ì£¼ì†Œ(ì‹œ/ë„) ë³€ê²½ ì‹œ ì‹œ/êµ°/êµ¬ ë¡œë“œ ë¦¬ìŠ¤ë„ˆ ë¶€ì°©
  attachAddressListeners();
});


/**
 * ì„œë²„ì—ì„œ íŠ¹ì • ì‹œ/ë„ì— í•´ë‹¹í•˜ëŠ” ì‹œ/êµ°/êµ¬ ëª©ë¡ì„ ê°€ì ¸ì™€ ë“œë¡­ë‹¤ìš´ì„ ì±„ì›ë‹ˆë‹¤.
 * @param {string} selectedCity - ì„ íƒëœ ì‹œ/ë„ ì´ë¦„
 * @param {string} [valueToSelect] - (ì„ íƒ) ë¡œë“œ í›„ ìë™ìœ¼ë¡œ ì„ íƒí•  ì‹œ/êµ°/êµ¬ ê°’
 */
function loadDistricts(selectedCity, valueToSelect) {
  // â˜… [ìˆ˜ì •] #customerDetailPanel ë‚´ë¶€ì—ì„œ #addressDistrict ì°¾ê¸°
  const districtSelect = document.getElementById('addressDistrict');
  if (!districtSelect) return;

  if (!selectedCity) {
    districtSelect.innerHTML = '<option value="">-- ì‹œ/ë„ë¥¼ ë¨¼ì € ì„ íƒ --</option>';
    districtSelect.disabled = true;
    return;
  }

  districtSelect.disabled = true; 
  districtSelect.innerHTML = '<option value="">ë¡œë”© ì¤‘...</option>';

  google.script.run
    .withSuccessHandler(districts => {
      districtSelect.innerHTML = '<option value="">-- ì„ íƒ --</option>'; 
      if (districts && districts.length > 0) {
        districts.forEach(district => {
          const option = document.createElement('option');
          option.value = district;
          option.textContent = district;
          districtSelect.appendChild(option);
        });
        if (valueToSelect) {
          districtSelect.value = valueToSelect;
        }
      } else {
         districtSelect.innerHTML = '<option value="">-- ì‹œ/êµ°/êµ¬ ì •ë³´ ì—†ìŒ --</option>';
      }
      districtSelect.disabled = false; 
    })
    .withFailureHandler(error => {
      console.error("Failed to load districts:", error);
      districtSelect.innerHTML = '<option value="">-- ë¡œë“œ ì‹¤íŒ¨ --</option>';
      districtSelect.disabled = false;
    })
    .getDistrictsForCity(selectedCity);
}

/**
 * ì£¼ì†Œ(ì‹œ/ë„) select ìš”ì†Œì— change ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
 */
function attachAddressListeners() {
    // â˜… [ìˆ˜ì •] #customerDetailPanel ë‚´ë¶€ì—ì„œ #addressCity ì°¾ê¸°
    const citySelect = document.getElementById('addressCity');
    if (citySelect) {
        citySelect.addEventListener('change', (event) => {
            const selectedCity = event.target.value;
            loadDistricts(selectedCity); 
        });
    }
}

/**
 * [ìˆ˜ì •ë¨] ì„œë²„ì—ì„œ ë°›ì€ ìƒì„¸ ë°ì´í„°ë¥¼ ìƒì„¸ ì •ë³´ íŒ¨ë„(ì¢Œì¸¡)ì˜ ê° UI ìš”ì†Œì— í‘œì‹œí•©ë‹ˆë‹¤.
 * (ë¡œê·¸ ë Œë”ë§ ë¡œì§ì€ ì œê±°ë¨ -> selectCustomerë¡œ ì´ë™)
 * @param {object} result - ì„œë²„ì˜ getAssignmentDetails í•¨ìˆ˜ê°€ ë°˜í™˜í•˜ëŠ” ê°ì²´ { assignment: {}, logs: [] }
 * @param {HTMLElement} panelElement - ìƒì„¸ ì •ë³´ íŒ¨ë„ ìš”ì†Œ (customerDetailPanel)
 */
function displayAssignmentDetails_Dynamic(result, panelElement) {
  if (!panelElement || !result || !result.assignment) {
    console.error("Invalid data or panel element for displayAssignmentDetails_Dynamic.");
    showErrorModal("ìƒì„¸ ì •ë³´ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë°ì´í„° ì˜¤ë¥˜)");
    return;
  }

  const assignment = result.assignment;
  currentAssignmentId = assignment.assignmentId; 

  console.log("Displaying details for:", assignment.assignmentId, assignment); 

  // --- Helper í•¨ìˆ˜: IDë¡œ ìš”ì†Œ ì°¾ê³  ê°’ ì„¤ì • (ì˜¤ë¥˜ ë°©ì§€ í¬í•¨) ---
  // â˜… [ìˆ˜ì •] panelElement(.detail-panel) ë‚´ë¶€ì—ì„œ ID ê²€ìƒ‰
  const setElementValue = (id, value) => {
    const element = panelElement.querySelector('#' + id);
    if (element) {
      if (element.type === 'date' && value && typeof value === 'string') {
        try {
          element.value = value.split('T')[0];
        } catch (e) {
          console.warn(`Failed to parse date for element #${id}:`, value, e);
          element.value = ''; 
        }
      } else if (element.tagName === 'SPAN') {
        element.textContent = value !== null && value !== undefined ? value : ''; 
      } else {
        element.value = value !== null && value !== undefined ? value : '';
      }
    }
  };

  // --- 1. ê¸°ë³¸ ì •ë³´ ---
  setElementValue('detailAssignmentId', assignment.assignmentId);
  setElementValue('detailCustomerNameSpan', assignment.customerName); 
  setElementValue('detailCustomerPhoneNumber', assignment.customerPhoneNumber ? formatPhoneNumber_Client(assignment.customerPhoneNumber) : ''); 
  setElementValue('detailDbType', assignment.dbType); 
  const assignDateStr = assignment.assignmentDate ? assignment.assignmentDate.split('T')[0] : '';
  setElementValue('detailAssignmentDate', assignDateStr);
  setElementValue('leadSource', assignment.leadSource);
  setElementValue('customerType', assignment.customerType);
  setElementValue('gender', assignment.gender);
  setElementValue('ageGroup', assignment.ageGroup);
  
  // ì£¼ì†Œ ì²˜ë¦¬
  setElementValue('addressCity', assignment.addressCity);
  if (assignment.addressCity) {
    loadDistricts(assignment.addressCity, assignment.addressDistrict); 
  } else {
    loadDistricts(''); 
  }
  
  setElementValue('incomeType', assignment.incomeType);
  setElementValue('creditInfo', assignment.creditInfo);

  // --- 2. ê³ ê° ë‹ˆì¦ˆ ---
  setElementValue('interestedCarModel', assignment.interestedCarModel);
  setElementValue('comparisonCarModel', assignment.comparisonCarModel);
  setElementValue('ownedCarModel', assignment.ownedCarModel);
  setElementValue('carUsage', assignment.carUsage);
  setElementValue('driverScope', assignment.driverScope);

  // --- 3. í¬ë§ ê³„ì•½ ì¡°ê±´ ---
  setElementValue('expectedContractTiming', assignment.expectedContractTiming);
  setElementValue('desiredContractTerm', assignment.desiredContractTerm);
  setElementValue('desiredInitialCostType', assignment.desiredInitialCostType);
  setElementValue('maintenanceServiceLevel', assignment.maintenanceServiceLevel);
  setElementValue('salesCondition', assignment.salesCondition);
  setElementValue('isRepurchase', assignment.isRepurchase);
  setElementValue('paymentMethod', assignment.paymentMethod);

  // --- 4. ìƒë‹´ / ê³„ì•½ ìƒíƒœ ---
  setElementValue('customerStatus', assignment.customerStatus);
  setElementValue('consultationStatus', assignment.consultationStatus);
  setElementValue('contractStatus', assignment.contractStatus);
  // â–¼â–¼â–¼ [ì‹ ê·œ] ê³ ê° ë©”ëª¨ ê°’ ì„¤ì • â–¼â–¼â–¼
  setElementValue('customerMemo', assignment.customerMemo);
  
  const contractSection = panelElement.querySelector('#contractInfoSection');
  if (contractSection) {
    contractSection.classList.toggle('hidden', assignment.contractStatus !== 'ê³„ì•½ ì²´ê²°');
  }

  // --- 5. ê³„ì•½ ìƒì„¸ ì •ë³´ ---
  if (assignment.contractStatus === 'ê³„ì•½ ì²´ê²°') {
    setElementValue('contractDate', assignment.contractDate);
    setElementValue('contractAmount', assignment.contractAmount);
    setElementValue('contractSummary', assignment.contractSummary);
    setElementValue('contractFileInfo', assignment.contractFileInfo);
    setElementValue('contractReview', assignment.contractReview);
  } else {
     const contractFields = ['contractDate', 'contractAmount', 'contractSummary', 'contractFileInfo', 'contractReview'];
     contractFields.forEach(id => setElementValue(id, ''));
  }

  // --- 6. [ì œê±°] ìƒë‹´ ê¸°ë¡ ë Œë”ë§ (selectCustomerì—ì„œ ì²˜ë¦¬) ---
  // --- 7. [ì œê±°] ìƒˆ ìƒë‹´ ê¸°ë¡ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” (selectCustomerì—ì„œ ì²˜ë¦¬) ---

  // --- 8. ê³ ê° ì´ë¦„ ì—…ë°ì´íŠ¸ (íŒ¨ë„ ìƒë‹¨ ì œëª©) ---
  const detailTitle = panelElement.querySelector('#detailCustomerName');
  if (detailTitle) {
      detailTitle.textContent = assignment.customerName ? `${assignment.customerName} ê³ ê° ìƒì„¸ ì •ë³´` : 'ê³ ê° ìƒì„¸ ì •ë³´';
  }
}
