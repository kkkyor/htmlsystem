  const loader = document.getElementById('loader');
  let currentAssignmentId = null; 
  
  const PAGE_SIZE = 30;
  let currentFilters = {};
  let currentOffset = 0;
  let totalCustomerCount = 0;

  const channel = new BroadcastChannel('customer_channel');

  function showLoader() { 
    loader.classList.remove('hidden'); 
    document.querySelectorAll('button, input, select, textarea').forEach(el => {
      if (el.closest('.modal-content') || el.closest('.error-modal-content')) return; 
      el.disabled = true;
    });
  }

  // [ì‹ ê·œ] 10ë²ˆ ì œì•ˆ: XSS ë°©ì§€ë¥¼ ìœ„í•œ HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
  function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    const str = String(text);
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function hideLoader() { 
    loader.classList.add('hidden'); 
  	document.querySelectorAll('button, input, select, textarea').forEach(el => {
  	  el.disabled = false;
  	});
  }

  /**
 * [Issue #5 ì ìš©]
 * ê°œì„ ëœ ì˜¤ë¥˜ ëª¨ë‹¬. ë©”ì‹œì§€ì™€ í•¨ê»˜ 'ë™ì‘(action)' ë²„íŠ¼ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 * @param {string} message - ëª¨ë‹¬ì— í‘œì‹œí•  ë©”ì‹œì§€
 * @param {Array<Object>} [actions] - (ì„ íƒ) ë²„íŠ¼ ê°ì²´ì˜ ë°°ì—´.
 * (ì˜ˆ: [{ text: 'ìƒˆë¡œê³ ì¹¨', action: () => { ... }, isPrimary: true }])
 */
function showErrorModal(message, actions) {
  const existingErrorModal = document.querySelector('.error-modal-overlay');
  if (existingErrorModal) existingErrorModal.remove();

  const modal = document.createElement('div');
  modal.className = 'modal-overlay error-modal-overlay';
  modal.style.zIndex = '100003';

  // ëª¨ë‹¬ ë‚´ìš© (p íƒœê·¸ëŠ” textContentë¡œ ì‚½ì…í•˜ì—¬ XSS ë°©ì§€)
  const contentDiv = document.createElement('div');
  contentDiv.className = 'error-modal-content';
  contentDiv.innerHTML = `<h3>âš ï¸ ì˜¤ë¥˜ ë°œìƒ</h3>`;
  
  const messageP = document.createElement('p');
  messageP.textContent = message; // textContentë¡œ XSS ìë™ ë°©ì§€
  messageP.style.margin = '20px 0';
  messageP.style.fontSize = '1.1rem';
  contentDiv.appendChild(messageP);

  // ë²„íŠ¼ ì˜ì—­
  const actionsDiv = document.createElement('div');
  actionsDiv.className = 'modal-actions';
  actionsDiv.style.justifyContent = 'flex-end';
  actionsDiv.style.gap = '10px'; // ë²„íŠ¼ ì‚¬ì´ ê°„ê²©

  // 1. actions ë°°ì—´ì´ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìœ¼ë©´ 'í™•ì¸' ë²„íŠ¼ë§Œ ì¶”ê°€
  if (!actions || actions.length === 0) {
    const okButton = document.createElement('button');
    okButton.className = 'error-modal-btn'; // (ë¹¨ê°„ìƒ‰)
    okButton.textContent = 'í™•ì¸';
    okButton.onclick = () => modal.remove();
    actionsDiv.appendChild(okButton);
  } else {
    // 2. actions ë°°ì—´ì´ ìˆìœ¼ë©´, ì •ì˜ëœ ë²„íŠ¼ë“¤ ì¶”ê°€
    actions.forEach(action => {
      const button = document.createElement('button');
      button.textContent = action.text;
      
      if (action.isPrimary) {
        button.className = 'error-modal-btn'; // (ë¹¨ê°„ìƒ‰)
      } else {
        // 'secondary' í´ë˜ìŠ¤ëŠ” CSSì— ì •ì˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
        // (ë§Œì•½ ì—†ë‹¤ë©´ 'error-modal-btn'ì˜ íšŒìƒ‰ ë²„ì „ìœ¼ë¡œ ìŠ¤íƒ€ì¼ë§ í•„ìš”)
        button.className = 'secondary'; 
      }
      
      button.onclick = () => {
        if (action.action) {
          action.action(); // ì •ì˜ëœ ë™ì‘ ì‹¤í–‰
        }
        modal.remove(); // ëª¨ë‹¬ ë‹«ê¸°
      };
      actionsDiv.appendChild(button);
    });
  }

  contentDiv.appendChild(actionsDiv);
  modal.appendChild(contentDiv);
  document.body.appendChild(modal);
}

  /**
 * [Issue #5 ì ìš©]
 * ì„œë²„ ì˜¤ë¥˜ë¥¼ ìœ í˜•ë³„ë¡œ ë¶„ì„í•˜ì—¬, ê°œì„ ëœ showErrorModalì„ í†µí•´
 * ì‚¬ìš©ìì—ê²Œ êµ¬ì²´ì ì¸ ë©”ì‹œì§€ì™€ í–‰ë™ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.
 */
function handleFailure(error) {
  hideLoader();
  console.error("Apps Script Error:", error);
  
  const msg = error.message;
  let userMessage = `ì˜¤ë¥˜ ë°œìƒ: ${msg}`; // ê¸°ë³¸ ë©”ì‹œì§€
  let actions = []; // ê¸°ë³¸ 'í™•ì¸' ë²„íŠ¼

  if (msg.includes("ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")) {
    // (1) ë°ì´í„° ì—†ìŒ (ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì‚­ì œ ë“±)
    userMessage = "ìš”ì²­í•˜ì‹  ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.";
    actions = [
      { text: 'ìƒˆë¡œê³ ì¹¨', action: () => window.location.reload(), isPrimary: true }
    ];

  } else if (msg.includes("ê¶Œí•œ")) {
    // (2) ê¶Œí•œ ì—†ìŒ
    userMessage = "ì´ ì‘ì—…ì„ ìˆ˜í–‰í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ì˜ˆ: ë³¸ì¸ ê³ ê°ì´ ì•„ë‹™ë‹ˆë‹¤.)";
    // actions = [] (ê¸°ë³¸ 'í™•ì¸' ë²„íŠ¼)

  } else if (msg.includes("ì‹œìŠ¤í…œì´") && msg.includes("í˜¼ì¡í•©ë‹ˆë‹¤")) {
    // (3) ì‹œìŠ¤í…œ í˜¼ì¡ (LockService ì¶©ëŒ)
    userMessage = "ì‹œìŠ¤í…œì´ í˜„ì¬ ë§¤ìš° í˜¼ì¡í•©ë‹ˆë‹¤. (ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë™ì‹œ ì €ì¥ ì¤‘) ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
    // actions = [] (ê¸°ë³¸ 'í™•ì¸' ë²„íŠ¼)

  } else if (msg.includes("ìƒë‹´ ê¸°ë¡ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤")) {
    // (4) ì»¤ìŠ¤í…€ ì˜¤ë¥˜ (8000ì ì´ˆê³¼)
    userMessage = msg; // ì„œë²„ì˜ ì¹œì ˆí•œ ì˜¤ë¥˜ ë©”ì‹œì§€ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    // actions = [] (ê¸°ë³¸ 'í™•ì¸' ë²„íŠ¼)

  } else if (msg.includes("timeout") || msg.includes("ì‹œê°„") || msg.includes("NetworkError")) {
    // (5) ë„¤íŠ¸ì›Œí¬/íƒ€ì„ì•„ì›ƒ
    userMessage = "ì„œë²„ ì‘ë‹µ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆê±°ë‚˜ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
    // actions = [] (ê¸°ë³¸ 'í™•ì¸' ë²„íŠ¼)

  } else {
    // (6) ê·¸ ì™¸ ëª¨ë“  ì„œë²„ ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜
    userMessage = "ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì‹œìŠ¤í…œì„ ì¬ì‹œì‘í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.";
    actions = [
      { text: 'ì·¨ì†Œ', action: null, isPrimary: false }, // 'secondary' ë²„íŠ¼
      { text: 'ìƒˆë¡œê³ ì¹¨', action: () => window.location.reload(), isPrimary: true }
    ];
  }
  
  showErrorModal(userMessage, actions);
}
 
  function formatPhoneNumber_Client(phone) {
  	if (!phone) return "";
  	const digits = phone.replace(/\D/g, "");
  	if (digits.length === 11) return `${digits.substring(0, 3)}-${digits.substring(3, 7)}-${digits.substring(7)}`;
  	if (digits.length === 10) return `${digits.substring(0, 3)}-${digits.substring(3, 6)}-${digits.substring(6)}`;
  	return phone;
  }

  // [JavaScript.html] - ê¸°ì¡´ populateDbTypeDropdowns í•¨ìˆ˜ë¥¼ ì•„ë˜ ì½”ë“œë¡œ **êµì²´**í•©ë‹ˆë‹¤.

/**
 * [ìˆ˜ì •] ì„œë²„ì—ì„œ ë°›ì€ ì„¤ì •(config) ê°ì²´ë¥¼ ì‚¬ìš©í•˜ì—¬
 * ëª¨ë“  ì •ì  <select> ë“œë¡­ë‹¤ìš´ ë©”ë‰´ì˜ ì˜µì…˜ì„ ì±„ì›ë‹ˆë‹¤.
 * @param {object} config - getConfigurations()ê°€ ë°˜í™˜í•˜ëŠ” ì„¤ì • ê°ì²´
 */
function populateSelectOptions(config) {
  const optionsMap = config.selectOptions; // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ì˜µì…˜ ê°ì²´
  if (!optionsMap) {
    console.error("Select options not found in config object.");
    return;
  }

  // Helper function to populate a single select element
  const populate = (elementId, optionsArray) => {
    const selectElement = document.getElementById(elementId);
    if (selectElement) {
      // ê¸°ì¡´ ì˜µì…˜ ìœ ì§€ ì—¬ë¶€ ê²°ì • (ì˜ˆ: '-- ì„ íƒ --' ì˜µì…˜)
      const firstOption = selectElement.options[0]?.value === "" ? selectElement.options[0] : null;
      selectElement.innerHTML = ''; // ê¸°ì¡´ ì˜µì…˜ ì œê±°
      if (firstOption) {
        selectElement.appendChild(firstOption); // '-- ì„ íƒ --' ë‹¤ì‹œ ì¶”ê°€
      }

      optionsArray.forEach(optionValue => {
        const option = document.createElement('option');
        option.value = optionValue;
        option.textContent = optionValue;
        selectElement.appendChild(option);
      });
    }
  };

  // --- ê° select ìš”ì†Œì— ì˜µì…˜ ì±„ìš°ê¸° ---
  // í•„í„° íŒ¨ë„
  populate('filterDbType', config.dbTypes || []); // DB ìœ í˜•ì€ config ë£¨íŠ¸ì— ìˆìŒ

  // ì‹ ê·œ ê³ ê° ëª¨ë‹¬
  populate('newDbType', config.dbTypes || []);

  // ìƒì„¸ ì •ë³´ íŒ¨ë„
  populate('leadSource', optionsMap.leadSource || []);
  populate('ageGroup', optionsMap.ageGroup || []);
  populate('addressCity', optionsMap.addressCities || []); // ì‹œ/ë„ ëª©ë¡ ì±„ìš°ê¸°
  populate('incomeType', optionsMap.incomeType || []);
  populate('creditInfo', optionsMap.creditInfo || []);
  populate('carUsage', optionsMap.carUsage || []);
  populate('expectedContractTiming', optionsMap.expectedContractTiming || []);
  populate('desiredContractTerm', optionsMap.desiredContractTerm || []);
  populate('desiredInitialCostType', optionsMap.desiredInitialCostType || []);
  populate('maintenanceServiceLevel', optionsMap.maintenanceServiceLevel || []);
  populate('customerStatus', optionsMap.customerStatus || []);

  // ê¸°ì¡´ í•­ëª© (customerType, gender, isRepurchase ë“±)ì˜ ì˜µì…˜ë„
  // í•„ìš”í•˜ë‹¤ë©´ optionsMapì— ì¶”ê°€í•˜ê³  ì—¬ê¸°ì„œ populate í˜¸ì¶œ ê°€ëŠ¥
}

  function getStatusClass(consultStatus, contractStatus) {
  	if (contractStatus === 'ê³„ì•½ ì²´ê²°') return 'contracted';
  	if (contractStatus === 'ê³„ì•½ ë¬´ì‚°') return 'failed';
  	if (consultStatus === 'ìƒë‹´ ì™„ë£Œ') return 'completed';
  	if (consultStatus === 'ìƒë‹´ ì§„í–‰ ì¤‘' || consultStatus === 'ì—°ë½ ì‹œë„ ì¤‘') return 'consulting';
  	return '';
  }

  function buildCustomerLi(customer) {
      const li = document.createElement('li');
      li.tabIndex = 0;
      li.dataset.assignmentId = customer.assignmentId;
      
      const assignDate = (customer.assignmentDate && typeof customer.assignmentDate === 'string') ? customer.assignmentDate.split('T')[0] : 'ë‚ ì§œ ì—†ìŒ';
      const phone = customer.customerPhoneNumber ? formatPhoneNumber_Client(customer.customerPhoneNumber) : 'ë²ˆí˜¸ ì—†ìŒ';
      
      let lastLogText = 'ìƒë‹´ ê¸°ë¡ ì—†ìŒ';
      if (customer.lastLogDate) {
  	try {
  	  const logDate = new Date(customer.lastLogDate);
  	  if (!isNaN(logDate.getTime())) {
  	    lastLogText = "ìµœì¢…: " + logDate.toLocaleString('ko-KR', {
  	      month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
  	    });
  	  } else {
  	    lastLogText = 'ìµœì¢…: (ë‚ ì§œ ì˜¤ë¥˜)';
  	  }
  	} catch (e) {
  	  lastLogText = 'ìµœì¢…: (ë‚ ì§œ ë³€í™˜ ì˜¤ë¥˜)';
  	}
      }

      const consult = customer.consultationStatus || 'ë¯¸ì •';
      const contract = customer.contractStatus || 'ë¯¸ì •';
      const statusClass = getStatusClass(consult, contract);
      
      li.innerHTML = `
  	<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
  	  <strong style="font-size: 1.15em; color: #004085;">${escapeHtml(customer.customerName)}</strong>
  	  <span class="status-badge ${statusClass}">${contract !== 'ë¯¸í•´ë‹¹' ? contract : consult}</span>
  	</div>
  	<div style="font-size: 0.95em; color: #333; margin-bottom: 8px;">
  	  <span>${phone}</span>
  	  <span style="float: right; font-size: 0.9em; color: #555;">(ì¸ì…: ${assignDate} / ${customer.dbType || 'ê¸°íƒ€'})</span>
  	</div>
  	<div class="list-item-status" style="border-top: 1px solid #eee; padding-top: 8px; font-size: 0.9em; color: #0056b3; font-weight: bold;">
  	  ${lastLogText}
  	</div>
      `;
      return li;
  }

  function displayAssignedCustomers(customers, isNewSearch) {
    const ul = document.getElementById('assignedCustomersList');
  	if (!ul) return; 

  	const loadMoreBtn = document.getElementById('loadMoreBtn');
  	
  	if (isNewSearch) {
  	  ul.innerHTML = '';
  	}
  	
  	const loadingLi = ul.querySelector('.skeleton-li'); 
  	if (loadingLi) {
  	  ul.innerHTML = ''; 
  	}

  	if (customers.length === 0 && isNewSearch) {
  	  ul.innerHTML = '<li>ì¡°ê±´ì— ë§ëŠ” ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
  	} else {
  	  customers.forEach(customer => {
  	  	const li = buildCustomerLi(customer);
  	  	ul.appendChild(li);
  	  });
  	}

  	const currentLoadedCount = ul.querySelectorAll('li[data-assignment-id]').length;
  	if (currentLoadedCount < totalCustomerCount) {
  	  loadMoreBtn.classList.remove('hidden');
  	} else {
  	  loadMoreBtn.classList.add('hidden');
  	}
  	loadMoreBtn.disabled = false;
  }

function updateListItem(assignment) {
  try {
    const liToUpdate = document.querySelector(`#assignedCustomersList li[data-assignment-id="${assignment.assignmentId}"]`);
  	if (!liToUpdate) return;
  	
  	const newLi = buildCustomerLi(assignment);
  	liToUpdate.innerHTML = newLi.innerHTML;
  	
  	liToUpdate.classList.remove('flash-success');
  	void liToUpdate.offsetWidth; 
  	liToUpdate.classList.add('flash-success');
  	
  } catch (e) {
  	console.error("Failed to update list item:", e);
  }
}

// [JavaScript.html] - renderConsultationLogs_Dynamic í•¨ìˆ˜ë¥¼ ì•„ë˜ ì½”ë“œë¡œ êµì²´í•©ë‹ˆë‹¤.

function renderConsultationLogs_Dynamic(logs, rootElement) {
  const logsDiv = rootElement.querySelector('#consultationLogs');
  logsDiv.innerHTML = (!logs || logs.length === 0) ? '<p>ê¸°ë¡ ì—†ìŒ</p>' : '';
  if (!logs) return;

  // (ê¸°ì¡´ ì½”ë“œì— ì´ë¯¸ ì •ë ¬ ë¡œì§ì´ ìˆìŠµë‹ˆë‹¤)
  logs.sort((a, b) => new Date(b.logTimestamp) - new Date(a.logTimestamp));
  
  logs.forEach(log => {
    // âœ¨ [Issue #10 ì ìš©] XSS ë°©ì§€ë¥¼ ìœ„í•´ innerHTML ëŒ€ì‹  DOM ìš”ì†Œì™€ textContent ì‚¬ìš©
    
    const logEntryDiv = document.createElement('div');
    logEntryDiv.className = 'log-entry';

    // 1. ë‚ ì§œ (Strong)
    const dateStrong = document.createElement('strong');
    dateStrong.textContent = log.logTimestamp ? 
      new Date(log.logTimestamp).toLocaleString('ko-KR') : 'ë‚ ì§œ ì—†ìŒ'; // ko-KR ì¶”ê°€

    // 2. ìƒë‹´ ë‚´ìš© (Div)
    const contentDiv = document.createElement('div');
    contentDiv.textContent = log.logContent || ''; // textContentëŠ” ìë™ ì´ìŠ¤ì¼€ì´í”„
    contentDiv.style.whiteSpace = 'pre-wrap'; // CSSë¡œ ì¤„ë°”ê¿ˆ(\n)ì„ <br>ì²˜ëŸ¼ ì²˜ë¦¬

    // 3. DOMì— ì¶”ê°€
    logEntryDiv.appendChild(dateStrong);
    logEntryDiv.appendChild(document.createElement('br'));
    logEntryDiv.appendChild(contentDiv);
    
    logsDiv.appendChild(logEntryDiv);
  });
}

function showSaveFeedback(buttonElement) {
  const originalText = buttonElement.textContent;
  buttonElement.textContent = "âœ… ì €ì¥ ì™„ë£Œ";
  buttonElement.disabled = true;
  setTimeout(() => {
    buttonElement.textContent = originalText;
  	buttonElement.disabled = false;
  }, 2000);
}

function handleSavePhoneNumber(panelElement, assignmentId, saveBtn) {
  if (!assignmentId) return;
  const phoneInput = panelElement.querySelector('#detailCustomerPhoneNumber');
  phoneInput.value = formatPhoneNumber_Client(phoneInput.value);
  
  showLoader();
  google.script.run
    .withSuccessHandler(result => {
  	  hideLoader();
  	  displayAssignmentDetails_Dynamic(result, panelElement); 
  	  showSaveFeedback(saveBtn); 
  	  channel.postMessage({ updatedAssignment: result.assignment });
  	  
        updateListItem(result.assignment);
  	})
  	.withFailureHandler(handleFailure)
  	.saveCustomerDetails(assignmentId, { customerPhoneNumber: phoneInput.value });
}

// [JavaScript.html] - handleSaveCustomerDetails í•¨ìˆ˜ë¥¼ ì•„ë˜ ì½”ë“œë¡œ **êµì²´**í•©ë‹ˆë‹¤.

function handleSaveCustomerDetails(panelElement, assignmentId, saveBtn) {
  if (!assignmentId) return;

  // ëª¨ë“  í•„ë“œì˜ ID ëª©ë¡ (Code.gsì˜ EDITABLE_FIELDSì™€ ìœ ì‚¬í•˜ê²Œ ê´€ë¦¬)
  // ì£¼ì˜: ì„œë²„ì˜ saveCustomerDetails í•¨ìˆ˜ ë‚´ EDITABLE_FIELDS ë°°ì—´ê³¼ ì¼ì¹˜í•´ì•¼ í•¨
  const detailFields = [
    // ê¸°ë³¸ ì •ë³´
    'leadSource', 'customerType', 'gender', 'ageGroup', 'addressCity', 'addressDistrict',
    'incomeType', 'creditInfo', 
    // ê³ ê° ë‹ˆì¦ˆ
    'interestedCarModel', 'comparisonCarModel', 'ownedCarModel', 'carUsage', 'driverScope',
    // í¬ë§ ê³„ì•½ ì¡°ê±´
    'expectedContractTiming', 'desiredContractTerm', 'desiredInitialCostType',
    'maintenanceServiceLevel', 'salesCondition', 'isRepurchase', 'paymentMethod',
    // ìƒë‹´/ê´€ë¦¬ ìƒíƒœ
    'customerStatus', 'consultationStatus', 'contractStatus'
    // ì—°ë½ì²˜ëŠ” ë³„ë„ ë²„íŠ¼ìœ¼ë¡œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì œì™¸
    // ê³„ì•½ ê´€ë ¨ í•„ë“œ(contractDate ë“±)ëŠ” saveContractDetailsì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì œì™¸
  ];

  const details = {};
  detailFields.forEach(fieldId => {
    const element = panelElement.querySelector('#' + fieldId);
    if (element) {
        
        // [ìˆ˜ì •] .hasOwnProperty('value') ëŒ€ì‹  'value' in element
        //       (ë˜ëŠ” element.value !== undefined) ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        //       DOM ìš”ì†ŒëŠ” 'value'ë¥¼ í”„ë¡œí† íƒ€ì…ìœ¼ë¡œë¶€í„° ìƒì†ë°›ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
        if ('value' in element) {
             details[fieldId] = element.value.trim();
        }
    }
  });

  // ìˆ«ì í•„ë“œëŠ” ë³€í™˜ (í•„ìš”í•œ ê²½ìš°)
  // ì˜ˆ: details.deposit = details.deposit ? parseFloat(details.deposit) : null;

  console.log("Saving details:", details); // ì „ì†¡ë  ë°ì´í„° í™•ì¸ (ë””ë²„ê¹…ìš©)

  showLoader();
  google.script.run
    .withSuccessHandler(result => {
      hideLoader();
      // âœ¨ ì¤‘ìš”: ì €ì¥ í›„ì—ëŠ” ì „ì²´ ë°ì´í„°ë¥¼ ë‹¤ì‹œ í‘œì‹œí•˜ì—¬ ìµœì‹  ìƒíƒœ ë°˜ì˜
      // (ë‚˜ì¤‘ì— ë Œë”ë§ ìµœì í™” ì‹œ ì´ ë¶€ë¶„ì„ updateAssignmentDetails_Partialë¡œ ë³€ê²½)
      displayAssignmentDetails_Dynamic(result, panelElement);
      showSaveFeedback(saveBtn);
      channel.postMessage({ updatedAssignment: result.assignment });
      updateListItem(result.assignment); // ëª©ë¡ ì•„ì´í…œ ì—…ë°ì´íŠ¸
    })
    .withFailureHandler(handleFailure)
    .saveCustomerDetails(assignmentId, details); // ì„œë²„ í•¨ìˆ˜ í˜¸ì¶œ
}

function handleSaveContractDetails(panelElement, assignmentId, saveBtn) {
  if (!assignmentId) return;
  const contractDetails = {};
  const fields = ['contractDate', 'contractSummary', 'contractAmount', 'contractFileInfo', 'contractReview'];
  fields.forEach(field => { contractDetails[field] = panelElement.querySelector('#' + field).value.trim(); });
  contractDetails.contractAmount = contractDetails.contractAmount ? parseFloat(contractDetails.contractAmount) : null;

  showLoader();
  google.script.run
    .withSuccessHandler(result => {
  	  hideLoader();
  	  displayAssignmentDetails_Dynamic(result, panelElement); 
  	  showSaveFeedback(saveBtn); 
  	  channel.postMessage({ updatedAssignment: result.assignment });

        updateListItem(result.assignment);
  	})
  	.withFailureHandler(handleFailure)
  	.saveContractDetails(assignmentId, contractDetails);
}

function handleAddLog(panelElement, assignmentId) {
  if (!assignmentId) return;
  const contentEl = panelElement.querySelector('#newLogContent');
  const content = contentEl.value.trim();
  if (!content) {
  	showErrorModal("ê¸°ë¡ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  	return;
  }
  
  showLoader();
  google.script.run
    .withSuccessHandler(result => { 
  	  hideLoader();
  	  renderConsultationLogs_Dynamic(result.logs, panelElement); 
  	  contentEl.value = ''; 
  	  channel.postMessage({ updatedAssignment: result.assignment });

        updateListItem(result.assignment);
  	})
  	.withFailureHandler(handleFailure)
  	.addConsultationLog(assignmentId, content);
}

function attachDetailPanelListeners() {
  const panelElement = document.getElementById('customerDetailPanel');
  if (!panelElement) {
    return;
  }

  panelElement.addEventListener('click', e => {
    const target = e.target;
    const targetId = target.id;
  	const assignmentId = currentAssignmentId; 

  	if (!assignmentId && (targetId === 'savePhoneNumberBtn' || targetId === 'saveCustomerDetailsBtn' || targetId === 'saveContractBtn' || targetId === 'addLogBtn')) {
  	  console.error("No currentAssignmentId set for save/add action.");
  	  return;
  	}

  	switch (targetId) {
  	  case 'backToListBtn':
  	  	e.preventDefault();
  	  	panelElement.classList.add('hidden'); 
  	  	
  	  	const listPanel = document.getElementById('listPanel');
  	  	if (listPanel) listPanel.classList.remove('hidden');

  	  	const currentActive = document.querySelector('#assignedCustomersList li.active');
  	  	if (currentActive) currentActive.classList.remove('active');
  	  	currentAssignmentId = null; 
  	  	break;
  	  	
  	  case 'savePhoneNumberBtn':
  	  	handleSavePhoneNumber(panelElement, assignmentId, target);
  	  	break;
  	  
  	  case 'saveCustomerDetailsBtn':
  	  	handleSaveCustomerDetails(panelElement, assignmentId, target);
  	  	break;
  	  
  	  case 'saveContractBtn':
  	  	handleSaveContractDetails(panelElement, assignmentId, target);
  	  	break;

  	  case 'addLogBtn':
  	  	handleAddLog(panelElement, assignmentId);
  	  	break;

      // â–¼â–¼â–¼ [ì‹ ê·œ] ê·¸ë£¹ í† ê¸€ ë²„íŠ¼ ë¡œì§ ì¶”ê°€ â–¼â–¼â–¼
      case 'toggleCustomerInfoBtn':
        e.preventDefault();
        const infoGroup = document.getElementById('customerInfoGroup');
        if (infoGroup) {
          const isHidden = infoGroup.classList.toggle('hidden');
          target.textContent = isHidden ? 'ìƒì„¸ ì •ë³´ ë³´ì´ê¸°' : 'ìƒì„¸ ì •ë³´ ìˆ¨ê¸°ê¸°';
        }
        break; 
      // â–²â–²â–² [ì‹ ê·œ] ê·¸ë£¹ í† ê¸€ ë²„íŠ¼ ë¡œì§ ë â–²â–²â–²
  	}
  });

  const contractStatusSelect = panelElement.querySelector('#contractStatus');
  if (contractStatusSelect) {
    contractStatusSelect.addEventListener('change', e => {
    	panelElement.querySelector('#contractInfoSection').classList.toggle('hidden', e.target.value !== 'ê³„ì•½ ì²´ê²°');
    });
  }
}

  function selectCustomer(assignmentId) {
    showLoader();

  	google.script.run
  	  .withSuccessHandler(result => {
  	  	console.log("ì„œë²„ì—ì„œ ë°›ì€ ì‘ë‹µ:", result); 
  	  	
  	  	document.getElementById('listPanel').classList.add('hidden');
  	  	
  	  	const panelElement = document.getElementById('customerDetailPanel');
  	  	displayAssignmentDetails_Dynamic(result, panelElement); 
  	  	panelElement.classList.remove('hidden'); 

  	  	document.querySelectorAll('#assignedCustomersList li').forEach(item => {
  	  	  item.classList.toggle('active', item.dataset.assignmentId === assignmentId);
  	  	});
  	  	hideLoader();
  	  })
  	  .withFailureHandler(handleFailure)
  	  .getAssignmentDetails(assignmentId);
  }

  function fetchCustomers(isNewSearch = false) {
  	if (!document.getElementById('loadMoreBtn')) return;

  	if (isNewSearch) {
  	  currentOffset = 0; 
  	  document.getElementById('loadMoreBtn').classList.add('hidden'); 
  	  showSkeletonLoader(); 
  	  currentFilters = {
  	  searchTerm: document.getElementById('filterSearchTerm').value,
  	  dateFrom: document.getElementById('filterAssignmentDateFrom').value,
  	  dateTo: document.getElementById('filterAssignmentDateTo').value,
  	  consultStatus: document.getElementById('filterConsultationStatus').value,
  	  contractStatus: document.getElementById('filterContractStatus').value,
  	  dbType: document.getElementById('filterDbType').value
  	  };
  	} else {
  	  currentOffset += PAGE_SIZE;
  	  document.getElementById('loadMoreBtn').disabled = true; 
  	}

  	const filtersToSend = {
  	  ...currentFilters,
  	  limit: PAGE_SIZE,
  	  offset: currentOffset 
  	};

  	if (!isNewSearch) {
  	  showLoader();
  	}
  	
  	google.script.run
  	  .withSuccessHandler(result => {
  	  	if (isNewSearch) {
  	  	} else {
  	  	  hideLoader();
  	  	}
        
  	  	totalCustomerCount = result.totalCount; 
  	  	displayAssignedCustomers(result.customers, isNewSearch);
  	  })
  	  .withFailureHandler(error => {
  	  	handleFailure(error);
  	  	if (isNewSearch) {
  	  	  document.getElementById('assignedCustomersList').innerHTML = '<li>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í•„í„°ë¥¼ ë‹¤ì‹œ ì ìš©í•´ì£¼ì„¸ìš”.</li>';
  	  	}
  	  	if (!isNewSearch) document.getElementById('loadMoreBtn').disabled = false;
  	  })
  	  .getAssignedCustomers(filtersToSend);
  }
  
  function showSkeletonLoader() {
    const ul = document.getElementById('assignedCustomersList');
  	if (!ul) return; 
  	ul.innerHTML = ''; 
  	for (let i = 0; i < 5; i++) { 
  	  const li = document.createElement('li');
  	  li.className = 'skeleton-li';
  	  li.innerHTML = `
  	  	<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
  	  	  <div class="skeleton-item line-1"></div>
  	  	  <div class="skeleton-item" style="height: 20px; width: 60px;"></div>
  	  	</div>
  	  	<div class="skeleton-item line-2"></div>
  	  	<div class="skeleton-item line-3"></div>
  	  `;
  	  ul.appendChild(li);
  	}
  }

document.addEventListener('DOMContentLoaded', () => {

  const currentView = document.body.dataset.view;
  const isDualMode = document.body.dataset.isDualMode === 'true'; 

  // â–¼â–¼â–¼ [ì‹ ê·œ] ì„œë²„ë¡œë¶€í„° /exec URL ì½ê¸° â–¼â–¼â–¼
  const SCRIPT_URL = document.body.dataset.scriptUrl; 
  // â–²â–²â–² [ì‹ ê·œ] â–²â–²â–²

  attachDetailPanelListeners();

  document.addEventListener('keydown', (e) => {
  	if (e.key === 'Escape') {
  	  const dynamicPanel = document.getElementById('customerDetailPanel');
  	  if (dynamicPanel && !dynamicPanel.classList.contains('hidden')) { 
  	    dynamicPanel.querySelector('#backToListBtn').click();
  	  }
  	}
  	
  	if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
  	  e.preventDefault();
  	  const searchBox = document.getElementById('filterSearchTerm');
  	  if (searchBox) searchBox.focus(); 
  	}
  });
  
  window.addEventListener('offline', () => {
  	showErrorModal("ì¸í„°ë„· ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ë³€ê²½ ì‚¬í•­ì´ ì €ì¥ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
  });

  // -----------------------------------
  // [ë¶„ê¸° 1] ëª©ë¡ ë·° (List View) ë¡œì§
  // -----------------------------------
  if (currentView === 'list') {
    
    // â–¼â–¼â–¼â–¼â–¼â–¼ [ì‹ ê·œ] ë“€ì–¼ ëª¨ë“œ ì „í™˜ ë²„íŠ¼ ë¡œì§ â–¼â–¼â–¼â–¼â–¼â–¼
    const dualModeBtn = document.getElementById('switchToDualModeBtn');
    if (isDualMode) {
    const singleModeBtn = document.createElement('button');
    singleModeBtn.textContent = 'ğŸ”„ ë‹¨ì¼ ëª¨ë“œë¡œ';
    singleModeBtn.className = 'secondary'; // ìŠ¤íƒ€ì¼ ì ìš©
    singleModeBtn.style.marginLeft = '10px'; // ê°„ê²© ì¡°ì ˆ
    singleModeBtn.addEventListener('click', () => {
      const SCRIPT_URL = document.body.dataset.scriptUrl;
      window.top.location.href = `${SCRIPT_URL}?view=list`; // ë‹¨ì¼ ëª©ë¡ ë·°ë¡œ ì´ë™
    });

    // ì ì ˆí•œ ìœ„ì¹˜ì— ë²„íŠ¼ ì¶”ê°€ (ì˜ˆ: list-header ì•ˆ)
    const headerActions = document.querySelector('.list-header .add-action-panel');
    if (headerActions) {
      headerActions.prepend(singleModeBtn); // ë‹¤ë¥¸ ë²„íŠ¼ë“¤ ì•ì— ì¶”ê°€
    }
    // ìƒì„¸ ë·°ì—ë„ ìœ ì‚¬í•˜ê²Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  } else {
      dualModeBtn.addEventListener('click', () => {
        // const baseUrl = window.location.href.split('?')[0]; // [ì‚­ì œ]
        
        // 1. ìƒˆ ì°½ì— 'detail' ë·° ë„ìš°ê¸°
        const detailUrl = `${SCRIPT_URL}?view=detail`; // [ìˆ˜ì •]
        window.open(detailUrl, '_blank', 'noopener,noreferrer');

        // 2. í˜„ì¬ ì°½ì€ 'list' ë·° + 'dual=true' íŒŒë¼ë¯¸í„°ë¡œ ìƒˆë¡œê³ ì¹¨
        const listUrl = `${SCRIPT_URL}?view=list&dual=true`; // [ìˆ˜ì •]
        
        // [ìˆ˜ì •] setTimeoutìœ¼ë¡œ ì•½ê°„ì˜ ì§€ì—° í›„ ìƒˆë¡œê³ ì¹¨ ì‹œë„
        setTimeout(() => {
          try {
            window.top.location.href = listUrl; 
          } catch (e) {
            // ë§Œì•½ window.top ì ‘ê·¼ì´ ë§‰í˜€ìˆë‹¤ë©´, í˜„ì¬ iframeë§Œì´ë¼ë„ ìƒˆë¡œê³ ì¹¨ ì‹œë„
            console.error("Failed to redirect top window, trying current window:", e);
            window.location.href = listUrl; 
          }
        }, 100); // 0.1ì´ˆ ì§€ì—°
      });
    }
    // â–²â–²â–² [ìˆ˜ì •] ë“€ì–¼ ëª¨ë“œ ì „í™˜ ë²„íŠ¼ ë¡œì§ ë â–²â–²â–²

    const listUl = document.getElementById('assignedCustomersList');
    const filterBtn = document.getElementById('applyFilterBtn');
  	const resetBtn = document.getElementById('resetFilterBtn');
  	const loadMoreBtn = document.getElementById('loadMoreBtn');
  	const addCustomerModal = document.getElementById('addCustomerModal');
  	const addCustomerBtn = document.getElementById('openAddCustomerModalBtn');
  	const cancelAddBtn = document.getElementById('cancelAddCustomerBtn');
  	const saveNewBtn = document.getElementById('saveNewCustomerBtn');
  	const newNameInput = document.getElementById('newCustomerName');
  	const newPhoneInput = document.getElementById('newCustomerPhoneNumber');

  	listUl.addEventListener('click', e => {
  	  const li = e.target.closest('li');
  	  if (li && li.dataset.assignmentId) {
  	  	const assignmentId = li.dataset.assignmentId;
  	  	
  	  	if (isDualMode) {
  	  	  channel.postMessage({ customerId: assignmentId });
  	  	} else {
  	  	  selectCustomer(assignmentId);
  	  	}

  	  	document.querySelectorAll('#assignedCustomersList li').forEach(item => {
  	  	  item.classList.toggle('active', item.dataset.assignmentId === assignmentId);
  	  	});
  	  }
  	});
  	
  	listUl.addEventListener('keydown', e => {
  	  if (e.key === 'Enter' || e.key === ' ') {
  	  const li = e.target.closest('li');
  	  if (li && li.dataset.assignmentId) {
  	    e.preventDefault();
          const assignmentId = li.dataset.assignmentId;
  	  	  
          if (isDualMode) {
            channel.postMessage({ customerId: assignmentId });
          } else {
            selectCustomer(assignmentId);
          }

  	  	document.querySelectorAll('#assignedCustomersList li').forEach(item => {
  	  	  item.classList.toggle('active', item.dataset.assignmentId === assignmentId);
  	  	});
  	  }
  	  }
  	});

  	channel.addEventListener('message', (event) => {
  	  const assignment = event.data.updatedAssignment;
  	  if (assignment) {
  	  	console.log('List view received update for:', assignment.assignmentId);
  	  	updateListItem(assignment); 
  	  }
  	});

  	// --- í•„í„°, ë”ë³´ê¸°, ì‹ ê·œ ê³ ê° ì¶”ê°€ ë¦¬ìŠ¤ë„ˆ (ë³€ê²½ ì—†ìŒ) ---
  	filterBtn.addEventListener('click', () => fetchCustomers(true));

  	resetBtn.addEventListener('click', () => {
  	  document.getElementById('filterSearchTerm').value = '';
  	  document.getElementById('filterDbType').value = '';
  	  document.getElementById('filterConsultationStatus').value = '';
  	  document.getElementById('filterContractStatus').value = '';
  	  const dateFromInput = document.getElementById('filterAssignmentDateFrom');
  	  const today = new Date();
  	  dateFromInput.value = new Date(today.setMonth(today.getMonth() - 3)).toISOString().split('T')[0];
  	  document.getElementById('filterAssignmentDateTo').value = '';
  	  fetchCustomers(true); 
  	});
  	
  	loadMoreBtn.addEventListener('click', () => fetchCustomers(false));

  	newPhoneInput.addEventListener('blur', (event) => {
  	  event.target.value = formatPhoneNumber_Client(event.target.value);
  	});
  	addCustomerBtn.addEventListener('click', () => addCustomerModal.classList.remove('hidden'));
  	cancelAddBtn.addEventListener('click', () => {
  	  addCustomerModal.classList.add('hidden');
  	  newNameInput.value = ''; newPhoneInput.value = '';
  	});

  	saveNewBtn.addEventListener('click', () => {
  	  const name = newNameInput.value.trim();
  	  const phone = newPhoneInput.value.trim();
  	  if (!name) { showErrorModal("ê³ ê°ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }
  	  if (phone) {
  	  const digits = phone.replace(/\D/g, '');
  	  if (digits.length > 0 && (digits.length < 9 || digits.length > 11)) {
  	    showErrorModal("ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. (9~11ìë¦¬ ìˆ«ì)"); return;
  	  }
  	  }
  	  showLoader();
  	  google.script.run
  	  .withSuccessHandler(newCustomer => {
  	  	  hideLoader();
  	  	  const ul = document.getElementById('assignedCustomersList');
  	  	  const li = buildCustomerLi(newCustomer); 
  	  	  ul.prepend(li); 
  	  	  const noCustomerLi = ul.querySelector('li:first-child:not([data-assignment-id])');
  	  	  if (noCustomerLi && ul.children.length > 1) { 
  	  	  	noCustomerLi.remove();
  	  	  }
  	  	  addCustomerModal.classList.add('hidden');
  	  	  newNameInput.value = '';
  	  	  newPhoneInput.value = '';
  	  })
  	  .withFailureHandler(handleFailure)
  	  .addNewCustomer({
  	  	customerName: name,
  	  	customerPhoneNumber: phone,
  	  	dbType: document.getElementById('newDbType').value
  	  });
  	});

  	// --- 'list' ë·° ì´ˆê¸° ë¡œë“œ (ë³€ê²½ ì—†ìŒ) ---
  	const dateFromInput = document.getElementById('filterAssignmentDateFrom');
  	const today = new Date();
  	dateFromInput.value = new Date(new Date().setMonth(today.getMonth() - 3)).toISOString().split('T')[0];
    // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
    // [!!!] ë°”ë¡œ ì—¬ê¸°ì…ë‹ˆë‹¤! (íŒŒì¼ì—ì„œëŠ” ì•½ 768í–‰ ê·¼ì²˜)
    showSkeletonLoader(); 

    // [!!!] ì´ ì•„ë˜ ì¤„ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.
    console.log("ğŸš€ [Client] Calling getConfigurations..."); // <-- ë¡œê·¸ ì¶”ê°€

    google.script.run
      .withSuccessHandler(config => {
        console.log("âœ… getConfigurations SUCCESS (List View):", config); 
        populateSelectOptions(config); // (ì´ ë¶€ë¶„ì€ ì´ë¯¸ ìˆ˜ì •í•˜ì…¨ìŠµë‹ˆë‹¤)
        fetchCustomers(true); 
      })
      .withFailureHandler(error => {
        handleFailure(error);
        document.getElementById('assignedCustomersList').innerHTML = '<li>ì‹œìŠ¤í…œ ì„¤ì •(Config) ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</li>';
      })
      .getConfigurations();
    //â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

  // -------------------------------------
  // [ë¶„ê¸° 2] ìƒì„¸ ë·° (Detail View) ë¡œì§
  // -------------------------------------
  } else if (currentView === 'detail') {
  	
  	const listPanel = document.getElementById('listPanel');
  	if (listPanel) listPanel.remove();
  	
  	const addCustomerModal = document.getElementById('addCustomerModal');
  	if (addCustomerModal) addCustomerModal.remove();
  	
  	const backBtn = document.getElementById('backToListBtn');
  	if (backBtn) backBtn.remove();
  	
  	const container = document.querySelector('.container');
  	let detailPlaceholder = document.createElement('div');
  	detailPlaceholder.id = 'detailPlaceholder';
  	detailPlaceholder.className = 'detail-panel'; 
  	detailPlaceholder.style.padding = '20px';
  	detailPlaceholder.innerHTML = '<h2>ê³ ê° ìƒì„¸ ì •ë³´</h2><p style="font-size: 1.1rem; color: #555; margin-top: 20px;">ì™¼ìª½ ëª¨ë‹ˆí„°ì˜ ëª©ë¡ ì°½ì—ì„œ ê³ ê°ì„ ì„ íƒí•˜ì„¸ìš”...</p>';
  	container.appendChild(detailPlaceholder);

  	channel.addEventListener('message', (event) => {
  	  const assignmentId = event.data.customerId;
  	  if (assignmentId) {
  	  	console.log('Detail view received customerId:', assignmentId);
  	  	
  	  	showLoader();
  	  	google.script.run
  	  	  .withSuccessHandler(result => {
  	  	  	  const placeholder = document.getElementById('detailPlaceholder');
  	  	  	  if (placeholder) placeholder.remove();

  	  	  	  const panelElement = document.getElementById('customerDetailPanel');
  	  	  	  displayAssignmentDetails_Dynamic(result, panelElement); 
  	  	  	  panelElement.classList.remove('hidden'); 

  	  	  	  hideLoader();
  	  	  })
  	  	  .withFailureHandler(handleFailure)
  	  	  .getAssignmentDetails(assignmentId);
  	  }
  	});

    if (!detailPlaceholder) {
      document.getElementById('customerDetailPanel').classList.remove('hidden');
    }
  }
  // ì£¼ì†Œ(ì‹œ/ë„) ë³€ê²½ ì‹œ ì‹œ/êµ°/êµ¬ ë¡œë“œ ë¦¬ìŠ¤ë„ˆ ë¶€ì°©
  attachAddressListeners();
});



/**
 * ì„œë²„ì—ì„œ íŠ¹ì • ì‹œ/ë„ì— í•´ë‹¹í•˜ëŠ” ì‹œ/êµ°/êµ¬ ëª©ë¡ì„ ê°€ì ¸ì™€ ë“œë¡­ë‹¤ìš´ì„ ì±„ì›ë‹ˆë‹¤.
 * @param {string} selectedCity - ì„ íƒëœ ì‹œ/ë„ ì´ë¦„
 * @param {string} [valueToSelect] - (ì„ íƒ) ë¡œë“œ í›„ ìë™ìœ¼ë¡œ ì„ íƒí•  ì‹œ/êµ°/êµ¬ ê°’
 */
function loadDistricts(selectedCity, valueToSelect) {
  const districtSelect = document.getElementById('addressDistrict');
  if (!districtSelect) return;

  // ì‹œ/ë„ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì‹œ/êµ°/êµ¬ ëª©ë¡ ë¹„ìš°ê¸°
  if (!selectedCity) {
    districtSelect.innerHTML = '<option value="">-- ì‹œ/ë„ë¥¼ ë¨¼ì € ì„ íƒ --</option>';
    districtSelect.disabled = true;
    return;
  }

  districtSelect.disabled = true; // ë¡œë”© ì¤‘ ë¹„í™œì„±í™”
  districtSelect.innerHTML = '<option value="">ë¡œë”© ì¤‘...</option>';

  google.script.run
    .withSuccessHandler(districts => {
      districtSelect.innerHTML = '<option value="">-- ì„ íƒ --</option>'; // ê¸°ë³¸ ì˜µì…˜
      if (districts && districts.length > 0) {
        districts.forEach(district => {
          const option = document.createElement('option');
          option.value = district;
          option.textContent = district;
          districtSelect.appendChild(option);
        });
        // ë§Œì•½ ìë™ìœ¼ë¡œ ì„ íƒí•´ì•¼ í•  ê°’ì´ ìˆë‹¤ë©´ ì„¤ì •
        if (valueToSelect) {
          districtSelect.value = valueToSelect;
        }
      } else {
         districtSelect.innerHTML = '<option value="">-- ì‹œ/êµ°/êµ¬ ì •ë³´ ì—†ìŒ --</option>';
      }
      districtSelect.disabled = false; // ë¡œë”© ì™„ë£Œ í›„ í™œì„±í™”
    })
    .withFailureHandler(error => {
      console.error("Failed to load districts:", error);
      districtSelect.innerHTML = '<option value="">-- ë¡œë“œ ì‹¤íŒ¨ --</option>';
      districtSelect.disabled = false;
      // ì‚¬ìš©ìì—ê²Œ ì˜¤ë¥˜ ì•Œë¦¼ (ì„ íƒ ì‚¬í•­)
      // showErrorModal("ì‹œ/êµ°/êµ¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    })
    .getDistrictsForCity(selectedCity);
}

/**
 * ì£¼ì†Œ(ì‹œ/ë„) select ìš”ì†Œì— change ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
 */
function attachAddressListeners() {
    const citySelect = document.getElementById('addressCity');
    if (citySelect) {
        citySelect.addEventListener('change', (event) => {
            const selectedCity = event.target.value;
            loadDistricts(selectedCity); // ì‹œ/êµ°/êµ¬ ëª©ë¡ ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œ
        });
    }
}

/**
 * [ìˆ˜ì •ë¨] ì„œë²„ì—ì„œ ë°›ì€ ìƒì„¸ ë°ì´í„°ë¥¼ ìƒì„¸ ì •ë³´ íŒ¨ë„ì˜ ê° UI ìš”ì†Œì— í‘œì‹œí•©ë‹ˆë‹¤.
 * @param {object} result - ì„œë²„ì˜ getAssignmentDetails í•¨ìˆ˜ê°€ ë°˜í™˜í•˜ëŠ” ê°ì²´ { assignment: {}, logs: [] }
 * @param {HTMLElement} panelElement - ìƒì„¸ ì •ë³´ íŒ¨ë„ ìš”ì†Œ (customerDetailPanel)
 */
function displayAssignmentDetails_Dynamic(result, panelElement) {
  if (!panelElement || !result || !result.assignment) {
    console.error("Invalid data or panel element for displayAssignmentDetails_Dynamic.");
    showErrorModal("ìƒì„¸ ì •ë³´ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë°ì´í„° ì˜¤ë¥˜)");
    return;
  }

  const assignment = result.assignment;
  currentAssignmentId = assignment.assignmentId; // í˜„ì¬ ë³´ê³  ìˆëŠ” ê³ ê° ID ì—…ë°ì´íŠ¸

  console.log("Displaying details for:", assignment.assignmentId, assignment); // ë””ë²„ê¹… ë¡œê·¸

  // --- Helper í•¨ìˆ˜: IDë¡œ ìš”ì†Œ ì°¾ê³  ê°’ ì„¤ì • (ì˜¤ë¥˜ ë°©ì§€ í¬í•¨) ---
  const setElementValue = (id, value) => {
    const element = panelElement.querySelector('#' + id);
    if (element) {
      // ë‚ ì§œ ì…ë ¥ í•„ë“œëŠ” YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì„¤ì •
      if (element.type === 'date' && value && typeof value === 'string') {
        try {
          // ISO ë¬¸ìì—´ (YYYY-MM-DDTHH:mm:ss.sssZ) ì—ì„œ ë‚ ì§œ ë¶€ë¶„ë§Œ ì¶”ì¶œ
          element.value = value.split('T')[0];
        } catch (e) {
          console.warn(`Failed to parse date for element #${id}:`, value, e);
          element.value = ''; // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë¹„ì›€
        }
      } else if (element.tagName === 'SPAN') {
        element.textContent = value !== null && value !== undefined ? value : ''; // SPAN íƒœê·¸ ì²˜ë¦¬
      } else {
        element.value = value !== null && value !== undefined ? value : '';
      }
    } else {
      // console.warn(`Element with ID #${id} not found in detail panel.`); // ìš”ì†Œë¥¼ ëª»ì°¾ëŠ” ê²½ìš° ê²½ê³  (ì„ íƒ ì‚¬í•­)
    }
  };

  // --- 1. ê¸°ë³¸ ì •ë³´ ---
  setElementValue('detailAssignmentId', assignment.assignmentId);
  setElementValue('detailCustomerNameSpan', assignment.customerName); // SPAN ìš”ì†Œ
  setElementValue('detailCustomerPhoneNumber', assignment.customerPhoneNumber ? formatPhoneNumber_Client(assignment.customerPhoneNumber) : ''); // ì „í™”ë²ˆí˜¸ í˜•ì‹ ì ìš©
  setElementValue('detailDbType', assignment.dbType); // SPAN ìš”ì†Œ
  // ìˆ˜ì •ëœ ì½”ë“œ
  const assignDateStr = assignment.assignmentDate ? assignment.assignmentDate.split('T')[0] : '';
  setElementValue('detailAssignmentDate', assignDateStr);
  setElementValue('leadSource', assignment.leadSource);
  setElementValue('customerType', assignment.customerType);
  setElementValue('gender', assignment.gender);
  setElementValue('ageGroup', assignment.ageGroup);
  
  // ì£¼ì†Œ ì²˜ë¦¬: ì‹œ/ë„ ì„¤ì • í›„, ì‹œ/êµ°/êµ¬ ë¡œë“œ ë° ì„¤ì •
  setElementValue('addressCity', assignment.addressCity);
  if (assignment.addressCity) {
    // ì‹œ/ë„ê°€ ìˆìœ¼ë©´, ì‹œ/êµ°/êµ¬ ëª©ë¡ ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œ (ë¡œë“œ ì™„ë£Œ í›„ ê°’ ì„ íƒí•˜ë„ë¡)
    loadDistricts(assignment.addressCity, assignment.addressDistrict); 
  } else {
    // ì‹œ/ë„ê°€ ì—†ìœ¼ë©´, ì‹œ/êµ°/êµ¬ ëª©ë¡ ë¹„ìš°ê¸°
    loadDistricts(''); 
  }
  
  setElementValue('incomeType', assignment.incomeType);
  setElementValue('creditInfo', assignment.creditInfo);

  // --- 2. ê³ ê° ë‹ˆì¦ˆ ---
  setElementValue('interestedCarModel', assignment.interestedCarModel);
  setElementValue('comparisonCarModel', assignment.comparisonCarModel);
  setElementValue('ownedCarModel', assignment.ownedCarModel);
  setElementValue('carUsage', assignment.carUsage);
  setElementValue('driverScope', assignment.driverScope);

  // --- 3. í¬ë§ ê³„ì•½ ì¡°ê±´ ---
  setElementValue('expectedContractTiming', assignment.expectedContractTiming);
  setElementValue('desiredContractTerm', assignment.desiredContractTerm);
  setElementValue('desiredInitialCostType', assignment.desiredInitialCostType);
  setElementValue('maintenanceServiceLevel', assignment.maintenanceServiceLevel);
  setElementValue('salesCondition', assignment.salesCondition);
  setElementValue('isRepurchase', assignment.isRepurchase);
  setElementValue('paymentMethod', assignment.paymentMethod);

  // --- 4. ìƒë‹´ / ê³„ì•½ ìƒíƒœ ---
  setElementValue('customerStatus', assignment.customerStatus);
  setElementValue('consultationStatus', assignment.consultationStatus);
  setElementValue('contractStatus', assignment.contractStatus);

  // ê³„ì•½ ìƒíƒœì— ë”°ë¼ ê³„ì•½ ì •ë³´ ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
  const contractSection = panelElement.querySelector('#contractInfoSection');
  if (contractSection) {
    contractSection.classList.toggle('hidden', assignment.contractStatus !== 'ê³„ì•½ ì²´ê²°');
  }

  // --- 5. ê³„ì•½ ìƒì„¸ ì •ë³´ (ê³„ì•½ ìƒíƒœê°€ 'ê³„ì•½ ì²´ê²°'ì¼ ë•Œë§Œ) ---
  if (assignment.contractStatus === 'ê³„ì•½ ì²´ê²°') {
    setElementValue('contractDate', assignment.contractDate);
    setElementValue('contractAmount', assignment.contractAmount);
    setElementValue('contractSummary', assignment.contractSummary);
    setElementValue('contractFileInfo', assignment.contractFileInfo);
    setElementValue('contractReview', assignment.contractReview);
  } else {
     // ê³„ì•½ ìƒíƒœê°€ ì•„ë‹ˆë©´ ê³„ì•½ ì •ë³´ í•„ë“œ ë¹„ìš°ê¸° (ì„ íƒ ì‚¬í•­)
     const contractFields = ['contractDate', 'contractAmount', 'contractSummary', 'contractFileInfo', 'contractReview'];
     contractFields.forEach(id => setElementValue(id, ''));
  }

  // --- 6. ìƒë‹´ ê¸°ë¡ ë Œë”ë§ ---
  renderConsultationLogs_Dynamic(result.logs, panelElement);

  // --- 7. ìƒˆ ìƒë‹´ ê¸°ë¡ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” ---
  const newLogContentEl = panelElement.querySelector('#newLogContent');
  if (newLogContentEl) {
    newLogContentEl.value = ''; // í•­ìƒ ë¹„ì›Œì¤Œ
  }
  
  // --- 8. ê³ ê° ì´ë¦„ ì—…ë°ì´íŠ¸ (íŒ¨ë„ ìƒë‹¨ ì œëª©) ---
  const detailTitle = panelElement.querySelector('#detailCustomerName');
  if (detailTitle) {
      detailTitle.textContent = assignment.customerName ? `${assignment.customerName} ê³ ê° ìƒì„¸ ì •ë³´` : 'ê³ ê° ìƒì„¸ ì •ë³´';
  }
}

