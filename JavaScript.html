  // ============================================================================
  // [1] Supabase 설정 및 전역 변수
  // ============================================================================
  const SUPABASE_URL = 'https://chooqydalmudfaprrevg.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNob29xeWRhbG11ZGZhcHJyZXZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NzM1MDUsImV4cCI6MjA3OTI0OTUwNX0.kgqtg9UXE-PNrgTSSCHcj9bgI0PYPmVPGV4jOF9_beI';

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let session = null;
  let currentUserEmail = null;
  let currentUserName = "사용자";
  
  // 고객 목록용 변수
  let currentAssignmentId = null;
  let currentFilters = {};
  let currentOffset = 0;
  let totalCustomerCount = 0;
  
  // 계약 목록용 변수
  let currentContractOffset = 0;
  const PAGE_SIZE = 30;

  const CONFIG = {
    selectOptions: {
      leadSource: ['홈페이지', '네이버검색', '다음검색', '구글검색', 'SNS 광고', '유튜브 광고', '소개', '기존고객 재렌트', '파트너사 전달', '오프라인 광고', '기타'],
      ageGroup: ['20대(만21~25)', '20대(만26~)', '30대', '40대', '50대', '60대 이상', '미확인'],
      incomeType: ['4대보험 직장인', '4대보험 제외 직장인', '전문직', '프리랜서', '일용직', '무직/학생', '미확인'],
      creditInfo: ['1~3 등급(상)', '4~6 등급(중)', '7~9 등급(하)', '심사 불가', '심사 전', '미확인'],
      carUsage: ['출퇴근용', '업무용(영업/출장)', '레저/패밀리용', '법인 임원용', '개인 사업장 운영', '기타', '미확인'],
      drivingDistance: ['1만km', '1.5만km', '2만km', '2.5만km', '3만km', '3.5만km', '4만km', '4.5만km', '5만km', '5만km 이상', '미정'],
      expectedContractTiming: ['즉시(1개월 내)', '3개월 내', '6개월 내', '미정'],
      desiredContractTerm: ['12개월', '24개월', '36개월', '48개월', '60개월', '미정'],
      desiredInitialCostType: ['무보증', '보증금', '선납금', '보증증권', '미정'],
      maintenanceServiceLevel: ['미포함(Self)', '포함(기본)', '포함(고급)', '미정'],
      customerStatus: ['배정됨', '연락 시도 중', '상담 진행 중', '견적 발송', '추가 정보 요청', '가망 고객', '심사 진행중', '심사 완료', '계약 진행중', '계약 완료', '출고 완료', '기존 고객', '상담 보류', '상담 이탈'],
      addressCities: ['서울특별시', '부산광역시', '대구광역시', '인천광역시', '광주광역시', '대전광역시', '울산광역시', '세종특별자치시', '경기도', '강원특별자치도', '충청북도', '충청남도', '전북특별자치도', '전라남도', '경상북도', '경상남도', '제주특별자치도']
    }
  };

  const loader = document.getElementById('loader');

  // ============================================================================
  // [2] UI 및 유틸리티 함수
  // ============================================================================
  function showLoader() { if(loader) loader.classList.remove('hidden'); }
  function hideLoader() { if(loader) loader.classList.add('hidden'); }
  
  function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
  }

  function formatPhoneNumber_Client(phone) {
    if (!phone) return "";
    const digits = phone.replace(/\D/g, "");
    if (digits.length === 11) return `${digits.substring(0, 3)}-${digits.substring(3, 7)}-${digits.substring(7)}`;
    if (digits.length === 10) return `${digits.substring(0, 3)}-${digits.substring(3, 6)}-${digits.substring(6)}`;
    return phone;
  }

  function formatDate(isoString) {
    if (!isoString) return '';
    try {
      return isoString.split('T')[0];
    } catch (e) {
      return isoString;
    }
  }

  function showErrorModal(message) { alert(message); }
  
  function handleFailure(error) {
    hideLoader();
    console.error(error);
    alert(`오류 발생: ${error.message || error}`);
  }
  
  function showSaveFeedback(btn) {
    const origin = btn.textContent;
    btn.textContent = "✅ 저장됨";
    btn.disabled = true;
    setTimeout(() => { btn.textContent = origin; btn.disabled = false; }, 1500);
  }

  // [1] 탭 전환 함수 (모던 스타일 적용 & 패널 제어)
  function switchTab(mode) {
    const customerPanel = document.getElementById('listPanel');
    const contractPanel = document.getElementById('contractListPanel');
    const custDetailPanel = document.getElementById('customerDetailPanel');
    const contDetailPanel = document.getElementById('contractDetailPanel');
    
    // 1. 상세 패널들 모두 닫기
    custDetailPanel.classList.add('hidden');
    contDetailPanel.classList.add('hidden');
    
    const btnCust = document.getElementById('tabCustomerBtn');
    const btnCont = document.getElementById('tabContractBtn');

    if (mode === 'customer') {
      customerPanel.classList.remove('hidden');
      if(contractPanel) contractPanel.classList.add('hidden');
      
      // 클래스 토글 (CSS active 클래스 활용)
      btnCust.classList.add('active'); 
      btnCont.classList.remove('active');
      
      fetchCustomers(true); // 고객 목록 갱신
      
    } else {
      customerPanel.classList.add('hidden');
      if(contractPanel) contractPanel.classList.remove('hidden');
      
      btnCust.classList.remove('active');
      btnCont.classList.add('active');
      
      fetchGlobalContracts(true); // 계약 목록 갱신
    }
  }

  // ============================================================================
  // [3] 데이터 변환 및 UI 렌더링
  // ============================================================================
  function toUiData(dbData) {
    if (!dbData) return null;
    return {
      assignmentId: dbData.assignment_id,
      customerName: dbData.customer_name,
      customerPhoneNumber: dbData.customer_phone,
      assignedTo: dbData.assigned_to,
      dbType: dbData.db_type,
      assignmentDate: dbData.assignment_date,
      customerStatus: dbData.customer_status,
      // 상세 정보들
      leadSource: dbData.lead_source,
      customerType: dbData.customer_type,
      gender: dbData.gender,
      ageGroup: dbData.age_group,
      addressCity: dbData.address_city,
      // addressDistrict 제거됨
      incomeType: dbData.income_type,
      creditInfo: dbData.credit_info,
      interestedCarModel: dbData.interested_car_model,
      comparisonCarModel: dbData.comparison_car_model,
      ownedCarModel: dbData.owned_car_model,
      carUsage: dbData.car_usage,
      driverScope: dbData.driver_scope,
      driving_distance: dbData.driving_distance,
      expectedContractTiming: dbData.expected_contract_timing,
      desiredContractTerm: dbData.desired_contract_term,
      desiredInitialCostType: dbData.desired_initial_cost_type,
      maintenanceServiceLevel: dbData.maintenance_service_level,
      salesCondition: dbData.sales_condition,
      isRepurchase: dbData.is_repurchase,
      paymentMethod: dbData.payment_method,
      customerMemo: dbData.customer_memo,
      quoteNumber: dbData.quote_number,
      approvalNumber: dbData.approval_number,
      occupation: dbData.occupation,
      lastLogDate: dbData.last_log_date || dbData.updated_at 
    };
  }

  async function populateSelectOptions() {
    const { data: dbTypeData } = await supabase.from('db_types').select('type_name').eq('is_active', true).order('sort_order', { ascending: true });
    let dbTypes = dbTypeData ? dbTypeData.map(i => i.type_name) : ['기타'];
    
    const populate = (id, opts) => {
      const el = document.getElementById(id);
      if (!el || el.tagName !== 'SELECT') return;
      const first = el.options[0]; el.innerHTML = ''; if (first) el.appendChild(first);
      opts.forEach(v => { const op = document.createElement('option'); op.value = v; op.textContent = v; el.appendChild(op); });
    };

    populate('filterDbType', dbTypes);
    populate('newDbType', dbTypes);

    const opts = CONFIG.selectOptions;
    populate('leadSource', opts.leadSource);
    populate('ageGroup', opts.ageGroup);
    populate('incomeType', opts.incomeType);
    populate('creditInfo', opts.creditInfo);
    populate('carUsage', opts.carUsage);
    populate('drivingDistance', opts.drivingDistance);
    populate('expectedContractTiming', opts.expectedContractTiming);
    populate('desiredContractTerm', opts.desiredContractTerm);
    populate('desiredInitialCostType', opts.desiredInitialCostType);
    populate('maintenanceServiceLevel', opts.maintenanceServiceLevel);
    populate('customerStatus', opts.customerStatus);

    Object.keys(opts).forEach(key => {
        // ID와 키 매핑이 필요할 수 있음 (예: customerStatus -> filterCustomerStatus)
        populate(key, opts[key]);
    });
    // 별도 매핑
    populate('filterCustomerStatus', opts.customerStatus);
    populate('addressCity', opts.addressCities);

  }

  function getStatusClass(status) {
    if (status === '상담 완료') return 'completed';
    if (status === '상담 진행 중' || status === '연락 시도 중') return 'consulting';
    return '';
  }

  // 목록 렌더링 함수
  function displayAssignedCustomers(customers, isNew) {
    const ul = document.getElementById('assignedCustomersList');
    const btn = document.getElementById('loadMoreBtn');
    if (isNew) ul.innerHTML = '';
    
    if (customers.length === 0 && isNew) {
      ul.innerHTML = '<li style="padding:10px;">조건에 맞는 고객이 없습니다.</li>';
    } else {
      customers.forEach(c => {
        const li = document.createElement('li');
        li.dataset.assignmentId = c.assignmentId;
        
        const statusClass = getStatusClass(c.customerStatus);
        
        let combinedMemo = c.interestedCarModel || '';
        if(c.customerMemo) {
            combinedMemo = combinedMemo ? `${combinedMemo} | ${c.customerMemo}` : c.customerMemo;
        }
        if(!combinedMemo) combinedMemo = '...';

        const dateStr = formatDate(c.lastLogDate);

        li.innerHTML = `
          <span class="li-item dbtype" title="${escapeHtml(c.dbType)}">${escapeHtml(c.dbType)}</span>
          <span class="li-item status"><span class="status-badge ${statusClass}">${escapeHtml(c.customerStatus)}</span></span>
          <span class="li-item name" title="${escapeHtml(c.customerName)}">${escapeHtml(c.customerName)}</span>
          <span class="li-item phone" title="${escapeHtml(formatPhoneNumber_Client(c.customerPhoneNumber))}">${escapeHtml(formatPhoneNumber_Client(c.customerPhoneNumber))}</span>
          <span class="li-item memo" title="${escapeHtml(combinedMemo)}">${escapeHtml(combinedMemo)}</span>
          <span class="li-item date">${escapeHtml(dateStr)}</span>
        `;
        ul.appendChild(li);
      });
    }
    if (totalCustomerCount > (currentOffset + customers.length)) btn.classList.remove('hidden');
    else btn.classList.add('hidden');
    btn.disabled = false;
  }

  // 상세 정보 렌더링
  function displayAssignmentDetails(result) {
    const data = result.assignment;
    currentAssignmentId = data.assignmentId;
    
    const setVal = (id, v) => {
      const el = document.getElementById(id);
      if(el) {
        if(el.type === 'date' && v) {
            el.value = formatDate(v);
        }
        else if(el.tagName === 'SPAN') {
            if(id.includes('Date') || id.includes('Time')) {
                el.textContent = formatDate(v);
            } else {
                el.textContent = v || '';
            }
        }
        else el.value = v || '';
      }
    };

    setVal('detailAssignmentId', data.assignmentId);
    setVal('detailDbType', data.dbType);
    setVal('detailAssignmentDate', data.assignmentDate);
    setVal('detailCustomerPhoneNumber', data.customerPhoneNumber);
    
    setVal('leadSource', data.leadSource);
    setVal('customerType', data.customerType);
    setVal('gender', data.gender);
    setVal('ageGroup', data.ageGroup);
    setVal('addressCity', data.addressCity);
    // addressDistrict 로직 삭제됨
    
    setVal('incomeType', data.incomeType);
    setVal('creditInfo', data.creditInfo);
    setVal('occupation', data.occupation);
    setVal('interestedCarModel', data.interestedCarModel);
    setVal('comparisonCarModel', data.comparisonCarModel);
    setVal('ownedCarModel', data.ownedCarModel);
    setVal('carUsage', data.carUsage);
    setVal('driverScope', data.driverScope);
    setVal('drivingDistance', data.drivingDistance);
    setVal('expectedContractTiming', data.expectedContractTiming);
    setVal('desiredContractTerm', data.desiredContractTerm);
    setVal('desiredInitialCostType', data.desiredInitialCostType);
    setVal('maintenanceServiceLevel', data.maintenanceServiceLevel);
    setVal('isRepurchase', data.isRepurchase);
    setVal('paymentMethod', data.paymentMethod);
    setVal('customerStatus', data.customerStatus);
    setVal('customerMemo', data.customerMemo);
    setVal('quoteNumber', data.quoteNumber);
    setVal('approvalNumber', data.approvalNumber);

    document.getElementById('detailCustomerNameText').textContent = data.customerName;
  }

  // ★ [추가 수정] 상담 로그 렌더링 (카드 디자인 적용)
  function renderLogs(logs) {
    const div = document.getElementById('consultationLogs');
    div.innerHTML = '';
    if(!logs || logs.length === 0) {
      div.innerHTML = '<p style="text-align:center; padding:20px; color:#777;">기록 없음</p>';
      return;
    }
    logs.forEach(l => {
      const card = document.createElement('div');
      card.className = 'log-entry-card'; // CSS에서 정의한 카드 스타일
      
      const timeStr = new Date(l.logTimestamp).toLocaleString();
      card.innerHTML = `
        <span class="log-time">${timeStr}</span>
        <div class="log-content">${escapeHtml(l.logContent)}</div>
      `;
      div.appendChild(card);
    });
  }

  // [수정] 계약 이력 렌더링 (데이터 바인딩 오류 수정 및 클릭 이벤트)
  function renderContracts(contracts) {
    const ul = document.getElementById('contractList');
    ul.innerHTML = '';
    if(!contracts || contracts.length === 0) {
      ul.innerHTML = '<li style="text-align:center; padding:10px; color:#777; font-size:0.9rem;">이력 없음</li>';
      return;
    }
    contracts.forEach(c => {
      const li = document.createElement('li');
      li.style.cssText = "padding:10px; border-bottom:1px solid #eee; cursor:pointer; background:white; margin-bottom:5px; border-radius:4px;";
      
      li.onmouseover = () => li.style.background = '#f1f8ff';
      li.onmouseout = () => li.style.background = 'white';
      
      li.onclick = (e) => {
         e.stopPropagation();
         const currentCustomerNameEl = document.getElementById('detailCustomerNameText');
         const fallbackCustomerName = currentCustomerNameEl ? currentCustomerNameEl.textContent.trim() : '고객';

         const contractDataWithCustomer = {
             ...c,
             // ★ 중요: DB 컬럼명 그대로 사용 (렌더링 오류의 주원인이었던 CamelCase 변환 제거)
             customers: c.customers || { customer_name: fallbackCustomerName }
         };
         // ★ 중요: 두 번째 파라미터로 'customer_detail'을 넘겨서, 뒤로가기 시 고객 상세로 오게 함
         viewContractDetail(contractDataWithCustomer, 'customer_detail');
      };

      const cDate = formatDate(c.contract_date); // Snake case 확인
      const cModel = c.contract_car_model || '(차종 미입력)';
      const cStatus = c.contract_status || '-';

      li.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <b style="color:#333;">${escapeHtml(cModel)}</b> 
            <span class="status-badge">${escapeHtml(cStatus)}</span>
        </div>
        <div style="font-size:0.8rem; color:#888; margin-top:4px;">${cDate}</div>
      `;
      ul.appendChild(li);
    });
  }



  // [2] 계약 목록 렌더링 (카드 리스트 스타일)
  function renderGlobalContracts(contracts) {
    const div = document.getElementById('globalContractList');
    if(!div) return; 
    div.innerHTML = '';
    
    if (!contracts || contracts.length === 0) {
      div.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">조회된 계약 내역이 없습니다.</div>';
      return;
    }

    contracts.forEach(c => {
      // 1. 데이터 가공
      const custName = (c.customers && c.customers.customer_name) ? c.customers.customer_name : '(미확인)';
      const cDate = formatDate(c.contract_date);
      let statusBadge = `<span class="status-badge">${escapeHtml(c.contract_status)}</span>`;
      if(c.contract_status === '진행중') statusBadge = `<span class="status-badge consulting">진행중</span>`;
      if(c.contract_status === '계약 완료') statusBadge = `<span class="status-badge completed">계약 완료</span>`;

      // 2. 요소 생성 (div 기반 row)
      const row = document.createElement('div');
      row.className = 'contract-row';
      
      // ★ 클릭 시 '계약 상세 화면'으로 이동 (바로 고객정보 아님)
      row.onclick = () => viewContractDetail(c);

      row.innerHTML = `
        <span class="col-date">${cDate}</span>
        <span class="col-car">${escapeHtml(c.contract_car_model)}</span>
        <span class="col-customer">${escapeHtml(custName)}</span>
        <span class="col-status">${statusBadge}</span>
      `;
      div.appendChild(row);
    });
  }
  
  
  // [3] ★ 신규: 계약 상세 화면 보기 함수
  let currentViewingContract = null; // 현재 보고 있는 계약 데이터 임시 저장

  // [수정] 계약 상세 보기 (진입 경로 처리 추가)
  // source: 'contract_list' (기본값) 또는 'customer_detail'
  let currentContractSource = 'contract_list'; 
  
  function viewContractDetail(contractData, source = 'contract_list') {
    currentViewingContract = contractData;
    currentContractSource = source; // 진입 경로 저장

    // 패널 제어
    document.getElementById('listPanel').classList.add('hidden');
    document.getElementById('contractListPanel').classList.add('hidden');
    document.getElementById('customerDetailPanel').classList.add('hidden');
    document.getElementById('contractDetailPanel').classList.remove('hidden');

    // ★ 뒤로가기 버튼 텍스트 변경
    const backBtn = document.getElementById('dynamicBackBtn');
    if(source === 'customer_detail') {
        backBtn.innerHTML = '&larr; 고객 상세로 돌아가기';
    } else {
        backBtn.innerHTML = '&larr; 계약 목록으로 돌아가기';
    }

    const setTxt = (id, txt) => document.getElementById(id).textContent = txt || '-';
    setTxt('viewContStatus', contractData.contract_status);
    setTxt('viewContDate', formatDate(contractData.contract_date));
    setTxt('viewContCar', contractData.contract_car_model);
    setTxt('viewContAmount', Number(contractData.contract_amount).toLocaleString() + '원');
    setTxt('viewContTerm', contractData.contract_term);
    setTxt('viewContSummary', contractData.contract_summary);
    
    // 명의자/이용자 구분 표시
    const custName = (contractData.customers && contractData.customers.customer_name) ? contractData.customers.customer_name : '알 수 없음';
    const relation = contractData.relationship || '본인';
    
    setTxt('viewContCustomerName', custName); // 이용자 (상담 고객)
    
    // 관계에 따라 명의자 표시 로직
    if (relation === '본인') {
       setTxt('viewContRealName', custName);
    } else {
       // 대리 계약인 경우, 명의자 정보가 별도로 저장되어 있다면 그것을 표시해야 함.
       // 현재 DB 구조상으로는 명의자 이름이 별도 컬럼이 아닐 수 있으므로 (상담 시 입력한 로직 참고)
       // 우선은 "대리인 (관계)" 형태로 표기하거나, 로직을 더 고도화해야 함.
       // 여기서는 직관적으로 관계를 보여줌
       setTxt('viewContRealName', `(명의자 별도)`); 
    }
    setTxt('viewContRelation', relation);
  }

  // [수정] 이벤트 리스너 (뒤로가기 버튼 로직)
  // setupGlobalEventListeners 함수 안의 기존 backToContractListBtn 리스너를 이걸로 교체하세요.
  const backBtn = document.getElementById('dynamicBackBtn');
  if(backBtn) {
      backBtn.addEventListener('click', (e) => {
          e.preventDefault();
          document.getElementById('contractDetailPanel').classList.add('hidden');
          
          if(currentContractSource === 'customer_detail') {
              // 고객 상세로 복귀
              document.getElementById('customerDetailPanel').classList.remove('hidden');
          } else {
              // 계약 목록으로 복귀
              document.getElementById('contractListPanel').classList.remove('hidden');
          }
      });
  }


  // ============================================================================
  // [4] 비즈니스 로직 (API 호출)
  // ============================================================================
  
  // 4-1. 고객 목록 조회 (검색 기능 복구)
  async function fetchCustomers(isNew = false) {
    if(isNew) {
      currentOffset = 0;
      const getSafeVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };
      currentFilters = {
        searchTerm: getSafeVal('filterSearchTerm'),
        dbType: getSafeVal('filterDbType'),
        status: getSafeVal('filterCustomerStatus'),
        dateFrom: getSafeVal('filterAssignmentDateFrom'),
        dateTo: getSafeVal('filterAssignmentDateTo')
      };
    } else {
      currentOffset += PAGE_SIZE;
    }

    showLoader();
    try {
      let query = supabase.from('customers').select('*', { count: 'exact' })
        .range(currentOffset, currentOffset + PAGE_SIZE - 1)
        .order('assignment_date', { ascending: false });

      if (currentUserName) {
        query = query.eq('assigned_to', currentUserName);
      }

      // ★ [복구 완료] 이름/번호 + 메모/관심차종까지 검색되도록 수정
      if(currentFilters.searchTerm) {
         const term = currentFilters.searchTerm;
         // .or() 문법: 컬럼명.ilike.%검색어% 형태를 콤마로 연결
         query = query.or(`customer_name.ilike.%${term}%,customer_phone.ilike.%${term}%,customer_memo.ilike.%${term}%,interested_car_model.ilike.%${term}%`);
      }
      
      if(currentFilters.status) query = query.eq('customer_status', currentFilters.status);
      if(currentFilters.dbType) query = query.eq('db_type', currentFilters.dbType);
      if(currentFilters.dateFrom) query = query.gte('assignment_date', currentFilters.dateFrom);
      if(currentFilters.dateTo) {
        const d = new Date(currentFilters.dateTo); d.setDate(d.getDate()+1);
        query = query.lt('assignment_date', d.toISOString());
      }

      const { data, count, error } = await query;
      if(error) throw error;
      
      totalCustomerCount = count;
      displayAssignedCustomers(data.map(toUiData), isNew);
    } catch(e) {
      handleFailure(e);
    } finally {
      hideLoader();
    }
  }

  // 4-2. 계약 목록 조회 (Join 사용)
  async function fetchGlobalContracts(isNew = false) {
    showLoader();
    try {
      // customers 테이블과 조인하여 고객명 가져오기
      let query = supabase
        .from('contracts')
        .select('*, customers(customer_name, customer_phone)')
        .order('contract_date', { ascending: false });

      // 필터 적용
      const statusEl = document.getElementById('filterContractStatus');
      const termEl = document.getElementById('contractSearchTerm');
      const dateEl = document.getElementById('filterContractDateFrom');
      
      if (statusEl && statusEl.value) query = query.eq('contract_status', statusEl.value);
      if (termEl && termEl.value) query = query.ilike('contract_car_model', `%${termEl.value}%`);
      if (dateEl && dateEl.value) query = query.gte('contract_date', dateEl.value);

      const { data, error } = await query;
      if (error) throw error;

      renderGlobalContracts(data);
    } catch (e) {
      handleFailure(e);
    } finally {
      hideLoader();
    }
  }

  async function selectCustomer(id) {
    showLoader();
    try {
      const { data: cust, error: e1 } = await supabase.from('customers').select('*').eq('assignment_id', id).single();
      if(e1) throw e1;
      
      const { data: logs, error: e2 } = await supabase.from('consultation_logs').select('*').eq('assignment_id', id).order('log_timestamp', {ascending:false});
      if(e2) throw e2;

      const { data: contracts, error: e3 } = await supabase.from('contracts').select('*')
        .or(`assignment_id.eq.${id},consultant_id.eq.${id}`)
        .order('contract_date', {ascending:false});
      if(e3) throw e3;

      document.getElementById('listPanel').classList.add('hidden');
      if(document.getElementById('contractListPanel')) document.getElementById('contractListPanel').classList.add('hidden');
      document.getElementById('customerDetailPanel').classList.remove('hidden');

      displayAssignmentDetails({ assignment: toUiData(cust) });
      renderLogs(logs.map(l => ({ logTimestamp: l.log_timestamp, logContent: l.log_content })));
      // DB에서 가져온 전체 데이터를 그대로 넘겨줘야 상세 화면에서 보입니다.
      renderContracts(contracts);

    } catch(e) {
      handleFailure(e);
    } finally {
      hideLoader();
    }
  }

  // ============================================================================
  // [5] 메인 실행 (DOMContentLoaded)
  // ============================================================================
  document.addEventListener('DOMContentLoaded', async () => {
    
    // URL 해시 체크 (로그인 팝업)
    google.script.url.getLocation(async function(location) {
        const hash = location.hash; 
        
        if (hash && hash.includes('access_token')) {
            const loginModal = document.getElementById('loginModal');
            if(loginModal) loginModal.classList.add('hidden');

            const params = new URLSearchParams(hash.startsWith('#') ? hash.substring(1) : hash);
            const accessToken = params.get('access_token');
            const refreshToken = params.get('refresh_token');

            if (accessToken) {
                const { error } = await supabase.auth.setSession({
                    access_token: accessToken,
                    refresh_token: refreshToken || ''
                });

                if (!error) {
                    document.body.innerHTML = `
                        <div style="height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; font-family:sans-serif; background:#f9f9f9;">
                            <h2 style="color:#28a745;">✅ 로그인 성공!</h2>
                            <p style="color:#555;">인증이 완료되었습니다.</p>
                            <p>이 탭을 닫고 <b>원래 창을 새로고침</b> 하세요.</p>
                            <button id="closeBtn" style="padding:12px 24px; background:#007bff; color:white; border:none; border-radius:5px; font-size:16px; cursor:pointer; margin-top:20px;">창 닫기</button>
                        </div>
                    `;
                    document.getElementById('closeBtn').onclick = function() {
                        window.open('', '_self').close(); 
                        alert("창이 닫히지 않으면 수동으로 닫아주세요.");
                    };
                    setTimeout(() => window.open('', '_self').close(), 1000);
                    return; 
                }
            }
        }
        initApp();
    });
  });

  async function initApp() {
    await populateSelectOptions();
    
    // 기본 날짜 설정 (최근 3개월)
    const dateFromEl = document.getElementById('filterAssignmentDateFrom');
    if (dateFromEl) {
      const today = new Date();
      const prev = new Date(); prev.setMonth(today.getMonth()-3);
      dateFromEl.value = prev.toISOString().split('T')[0];
    }

    setupGlobalEventListeners();

    const { data } = await supabase.auth.getSession();
    if (data.session) onSessionValid(data.session);
    else document.getElementById('loginModal').classList.remove('hidden');

    supabase.auth.onAuthStateChange((event, sess) => {
        if (event === 'SIGNED_IN' && sess) onSessionValid(sess);
        else if (event === 'SIGNED_OUT') document.getElementById('loginModal').classList.remove('hidden');
    });
  }

  async function onSessionValid(sess) {
    session = sess;
    currentUserEmail = sess.user.email;
    document.getElementById('loginModal').classList.add('hidden');
    
    // ★ [수정] .maybeSingle()로 변경하여 406 에러 방지
    const { data } = await supabase.from('profiles').select('korean_name').eq('email', currentUserEmail).maybeSingle();
    currentUserName = data ? data.korean_name : currentUserEmail;
    console.log("Logged in as:", currentUserName);
    
    fetchCustomers(true);
  }

  // ============================================================================
  // [6] 이벤트 리스너 모음
  // ============================================================================
  function setupGlobalEventListeners() {
    
    // ★ 탭 버튼 리스너 추가
    const tabCustomerBtn = document.getElementById('tabCustomerBtn');
    const tabContractBtn = document.getElementById('tabContractBtn');
    
    if(tabCustomerBtn) {
        tabCustomerBtn.addEventListener('click', () => switchTab('customer'));
    }
    if(tabContractBtn) {
        tabContractBtn.addEventListener('click', () => switchTab('contract'));
    }
    
    // ★ 계약 검색 버튼
    const searchContractBtn = document.getElementById('searchContractBtn');
    if(searchContractBtn) {
        searchContractBtn.addEventListener('click', () => fetchGlobalContracts(true));
    }

    const loginBtn = document.getElementById('googleLoginBtn');
    if(loginBtn) {
      loginBtn.addEventListener('click', async () => {
        const redirectUrl = document.body.dataset.scriptUrl || "https://script.google.com/macros/s/AKfycbwV96l1hMuWCUMn4vLHPxvC6XM0NeKh1YREjZp1sYMgYqHL0F2JohW63NI0Rf5vWI5a/exec";
        const { data, error } = await supabase.auth.signInWithOAuth({
          provider: 'google',
          options: { 
            redirectTo: redirectUrl, 
            skipBrowserRedirect: true, 
            queryParams: { access_type: 'offline', prompt: 'consent' } 
          }
        });
        if (error) alert(error.message);
        else if (data.url) window.open(data.url, '_blank');
      });
    }

    document.getElementById('applyFilterBtn').addEventListener('click', () => fetchCustomers(true));
    document.getElementById('loadMoreBtn').addEventListener('click', () => fetchCustomers(false));
    document.getElementById('resetFilterBtn').addEventListener('click', () => {
        const setVal = (id, v) => { const el = document.getElementById(id); if(el) el.value = v; };
        setVal('filterSearchTerm', '');
        setVal('filterDbType', '');
        setVal('filterCustomerStatus', '');
        setVal('filterAssignmentDateFrom', ''); // 날짜도 초기화 (전체 보기)
        setVal('filterAssignmentDateTo', '');
        
        fetchCustomers(true);
    });

    document.getElementById('assignedCustomersList').addEventListener('click', e => {
      const li = e.target.closest('li');
      if(li) selectCustomer(li.dataset.assignmentId);
    });

    document.getElementById('backToListBtn').addEventListener('click', e => {
      e.preventDefault();
      // 현재 탭 상태에 따라 돌아갈 곳 결정
      const isContractTab = document.getElementById('tabContractBtn').classList.contains('secondary') === false;
      document.getElementById('customerDetailPanel').classList.add('hidden');
      
      if(isContractTab) {
          document.getElementById('contractListPanel').classList.remove('hidden');
      } else {
          document.getElementById('listPanel').classList.remove('hidden');
      }
      currentAssignmentId = null;
    });

    // ★ 안전한 getVal 함수
    const getVal = (id) => {
        const el = document.getElementById(id);
        return el ? el.value : ''; 
    };

    // 계약 상세 화면 -> 목록으로 돌아가기
    const backToContListBtn = document.getElementById('backToContractListBtn');
    if(backToContListBtn) {
        backToContListBtn.addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('contractDetailPanel').classList.add('hidden');
            document.getElementById('contractListPanel').classList.remove('hidden');
        });
    }

    // 계약 상세 화면 -> 고객 정보 보러가기
    const goToCustBtn = document.getElementById('goToCustomerDetailBtn');
    if(goToCustBtn) {
        goToCustBtn.addEventListener('click', () => {
             if(currentViewingContract && currentViewingContract.assignment_id) {
                 // 계약 상세 닫고 -> 고객 상세 열기
                 document.getElementById('contractDetailPanel').classList.add('hidden');
                 selectCustomer(currentViewingContract.assignment_id);
             } else {
                 alert("연결된 고객 정보를 찾을 수 없습니다.");
             }
        });
    }

    document.getElementById('saveCustomerDetailsBtn').addEventListener('click', async (e) => {
      if(!currentAssignmentId) return;
      
      const updates = {
        customer_type: getVal('customerType'),
        gender: getVal('gender'),
        age_group: getVal('ageGroup'),
        address_city: getVal('addressCity'),
        // address_district 삭제됨
        income_type: getVal('incomeType'),
        credit_info: getVal('creditInfo'),
        interested_car_model: getVal('interestedCarModel'),
        comparison_car_model: getVal('comparisonCarModel'),
        owned_car_model: getVal('ownedCarModel'),
        car_usage: getVal('carUsage'),
        driver_scope: getVal('driverScope'),
        driving_distance: getVal('drivingDistance'),
        expected_contract_timing: getVal('expectedContractTiming'),
        desired_contract_term: getVal('desiredContractTerm'),
        desired_initial_cost_type: getVal('desiredInitialCostType'),
        maintenance_service_level: getVal('maintenanceServiceLevel'),
        is_repurchase: getVal('isRepurchase'),
        payment_method: getVal('paymentMethod'),
        customer_status: getVal('customerStatus'),
        customer_memo: getVal('customerMemo'),
        quote_number: getVal('quoteNumber'),
        approval_number: getVal('approvalNumber'),
        lead_source: getVal('leadSource'),
        occupation: getVal('occupation'),
        updated_at: new Date().toISOString()
      };
      
      showLoader();
      const { error } = await supabase.from('customers').update(updates).eq('assignment_id', currentAssignmentId);
      hideLoader();
      if(error) handleFailure(error);
      else showSaveFeedback(e.target);
    });

    document.getElementById('addLogBtn').addEventListener('click', async () => {
      if(!currentAssignmentId) return;
      const txt = document.getElementById('newLogContent').value.trim();
      if(!txt) return alert('내용을 입력하세요');
      
      showLoader();
      const newLog = {
        log_id: 'LOG_' + Date.now(),
        assignment_id: currentAssignmentId,
        log_content: txt,
        user_name: currentUserName,
        log_timestamp: new Date().toISOString()
      };
      const { error } = await supabase.from('consultation_logs').insert([newLog]);
      if(error) {
        handleFailure(error);
      } else {
        document.getElementById('newLogContent').value = '';
        selectCustomer(currentAssignmentId);
      }
    });

    document.getElementById('savePhoneNumberBtn').addEventListener('click', async(e) => {
        if(!currentAssignmentId) return;
        const ph = document.getElementById('detailCustomerPhoneNumber').value;
        showLoader();
        const { error } = await supabase.from('customers').update({customer_phone: formatPhoneNumber_Client(ph)}).eq('assignment_id', currentAssignmentId);
        hideLoader();
        if(error) handleFailure(error);
        else showSaveFeedback(e.target);
    });

    document.getElementById('openAddCustomerModalBtn').addEventListener('click', () => document.getElementById('addCustomerModal').classList.remove('hidden'));
    document.getElementById('cancelAddCustomerBtn').addEventListener('click', () => document.getElementById('addCustomerModal').classList.add('hidden'));
    
    document.getElementById('saveNewCustomerBtn').addEventListener('click', async () => {
      const name = document.getElementById('newCustomerName').value;
      const phone = document.getElementById('newCustomerPhoneNumber').value;
      const dbType = document.getElementById('newDbType').value;
      if(!name) return alert('이름 필수');

      showLoader();
      const ts = Date.now();
      const { error } = await supabase.from('customers').insert([{
        assignment_id: "A_" + ts,
        customer_id: "C_" + ts,
        customer_name: name,
        customer_phone: formatPhoneNumber_Client(phone),
        db_type: dbType,
        assigned_to: currentUserName,
        assignment_date: new Date().toISOString(),
        customer_status: "배정됨"
      }]);
      hideLoader();
      if(error) handleFailure(error);
      else {
        document.getElementById('addCustomerModal').classList.add('hidden');
        fetchCustomers(true);
      }
    });

    document.getElementById('openAddContractModalBtn').addEventListener('click', () => {
        if(!currentAssignmentId) return;
        document.getElementById('addContractModal').classList.remove('hidden');
        document.getElementById('isDifferentContractor').checked = false;
        document.getElementById('realContractorForm').classList.add('hidden');
        document.getElementById('realContractorName').value = '';
        document.getElementById('realContractorPhone').value = '';
    });
    document.getElementById('cancelAddContractBtn').addEventListener('click', () => document.getElementById('addContractModal').classList.add('hidden'));

    document.getElementById('isDifferentContractor').addEventListener('change', (e) => {
        const form = document.getElementById('realContractorForm');
        if(e.target.checked) form.classList.remove('hidden');
        else form.classList.add('hidden');
    });

    document.getElementById('saveNewContractBtn').addEventListener('click', async () => {
        const date = document.getElementById('modalContractDate').value;
        const car = document.getElementById('modalContractCarModel').value;
        if(!date || !car) return alert('날짜와 차종은 필수입니다.');

        const isProxy = document.getElementById('isDifferentContractor').checked;
        const realName = document.getElementById('realContractorName').value.trim();
        const realPhone = document.getElementById('realContractorPhone').value.trim().replace(/\D/g, "");
        const relation = document.getElementById('contractorRelation').value;

        if(isProxy && (!realName || !realPhone)) return alert('실계약자 정보를 입력하세요.');

        showLoader();
        try {
            let targetAssignmentId = currentAssignmentId;
            let actualContractorId = currentAssignmentId;
            let consultantId = currentAssignmentId;
            let relationshipVal = '본인';

            if (isProxy) {
                relationshipVal = relation;
                // 실계약자 존재 여부 확인
                const { data: existUser } = await supabase.from('customers').select('assignment_id').eq('customer_phone', realPhone).maybeSingle();
                
                if (existUser) {
                    targetAssignmentId = existUser.assignment_id;
                    actualContractorId = existUser.assignment_id;
                } else {
                    const ts = Date.now();
                    const newId = "A_" + ts;
                    await supabase.from('customers').insert([{
                        assignment_id: newId,
                        customer_id: "C_" + ts,
                        customer_name: realName,
                        customer_phone: realPhone,
                        assigned_to: currentUserName,
                        customer_status: '계약 완료',
                        lead_source: '지인/소개',
                        customer_memo: `[자동생성] ${document.getElementById('detailCustomerNameText').textContent}님의 소개건`
                    }]);
                    targetAssignmentId = newId;
                    actualContractorId = newId;
                }
            }

            const { error } = await supabase.from('contracts').insert([{
                contract_id: "CN_" + Date.now(),
                assignment_id: targetAssignmentId,
                contract_date: date,
                contract_car_model: car,
                contract_amount: document.getElementById('modalContractAmount').value || 0,
                contract_term: document.getElementById('modalContractTerm').value,
                contract_summary: document.getElementById('modalContractSummary').value,
                contract_status: '진행중',
                actual_contractor_id: actualContractorId,
                consultant_id: consultantId,
                relationship: relationshipVal
            }]);

            if(error) throw error;

            hideLoader();
            document.getElementById('addContractModal').classList.add('hidden');
            selectCustomer(currentAssignmentId); 
            alert("계약 저장 완료");

        } catch(e) {
            handleFailure(e);
        }
    });

    // 이벤트 리스너에서 addressCity change 이벤트 삭제됨
    
    document.getElementById('newCustomerPhoneNumber').addEventListener('blur', (e) => {
      e.target.value = formatPhoneNumber_Client(e.target.value);
    });
  }
