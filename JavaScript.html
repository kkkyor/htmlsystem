  // ============================================================================
  // [1] Supabase ì„¤ì • ë° ì „ì—­ ë³€ìˆ˜
  // ============================================================================
  const SUPABASE_URL = 'https://chooqydalmudfaprrevg.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNob29xeWRhbG11ZGZhcHJyZXZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NzM1MDUsImV4cCI6MjA3OTI0OTUwNX0.kgqtg9UXE-PNrgTSSCHcj9bgI0PYPmVPGV4jOF9_beI';

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let session = null;
  let currentUserEmail = null;
  let currentUserName = "ì‚¬ìš©ì";

  let currentSortColumn = 'assignment_date'; // ê¸°ë³¸ ì •ë ¬ ê¸°ì¤€
  let currentSortAscending = false;          // ê¸°ë³¸: ë‚´ë¦¼ì°¨ìˆœ (ìµœì‹ ìˆœ)
  
  // ê³ ê° ëª©ë¡ìš© ë³€ìˆ˜
  let currentAssignmentId = null;
  let currentFilters = {};
  let currentOffset = 0;
  let totalCustomerCount = 0;
  
  // ê³„ì•½ ëª©ë¡ìš© ë³€ìˆ˜
  let currentContractOffset = 0;
  const PAGE_SIZE = 30;

  const CONFIG = {
    selectOptions: {
      leadSource: ['í™ˆí˜ì´ì§€', 'ë„¤ì´ë²„ê²€ìƒ‰', 'ë‹¤ìŒê²€ìƒ‰', 'êµ¬ê¸€ê²€ìƒ‰', 'SNS ê´‘ê³ ', 'ìœ íŠœë¸Œ ê´‘ê³ ', 'ì†Œê°œ', 'ê¸°ì¡´ê³ ê° ì¬ë ŒíŠ¸', 'íŒŒíŠ¸ë„ˆì‚¬ ì „ë‹¬', 'ì˜¤í”„ë¼ì¸ ê´‘ê³ ', 'ê¸°íƒ€'],
      ageGroup: ['20ëŒ€(ë§Œ21~25)', '20ëŒ€(ë§Œ26~)', '30ëŒ€', '40ëŒ€', '50ëŒ€', '60ëŒ€ ì´ìƒ', 'ë¯¸í™•ì¸'],
      incomeType: ['4ëŒ€ë³´í—˜ ì§ì¥ì¸', '4ëŒ€ë³´í—˜ ì œì™¸ ì§ì¥ì¸', 'ì „ë¬¸ì§', 'í”„ë¦¬ëœì„œ', 'ì¼ìš©ì§', 'ë¬´ì§/í•™ìƒ', 'ë¯¸í™•ì¸'],
      creditInfo: ['1~3 ë“±ê¸‰(ìƒ)', '4~6 ë“±ê¸‰(ì¤‘)', '7~9 ë“±ê¸‰(í•˜)', 'ì‹¬ì‚¬ ë¶ˆê°€', 'ì‹¬ì‚¬ ì „', 'ë¯¸í™•ì¸'],
      carUsage: ['ì¶œí‡´ê·¼ìš©', 'ì—…ë¬´ìš©(ì˜ì—…/ì¶œì¥)', 'ë ˆì €/íŒ¨ë°€ë¦¬ìš©', 'ë²•ì¸ ì„ì›ìš©', 'ê°œì¸ ì‚¬ì—…ì¥ ìš´ì˜', 'ê¸°íƒ€', 'ë¯¸í™•ì¸'],
      drivingDistance: ['1ë§Œkm', '1.5ë§Œkm', '2ë§Œkm', '2.5ë§Œkm', '3ë§Œkm', '3.5ë§Œkm', '4ë§Œkm', '4.5ë§Œkm', '5ë§Œkm', '5ë§Œkm ì´ìƒ', 'ë¯¸ì •'],
      expectedContractTiming: ['ì¦‰ì‹œ(1ê°œì›” ë‚´)', '3ê°œì›” ë‚´', '6ê°œì›” ë‚´', 'ë¯¸ì •'],
      desiredContractTerm: ['12ê°œì›”', '24ê°œì›”', '36ê°œì›”', '48ê°œì›”', '60ê°œì›”', 'ë¯¸ì •'],
      desiredInitialCostType: ['ë¬´ë³´ì¦', 'ë³´ì¦ê¸ˆ', 'ì„ ë‚©ê¸ˆ', 'ë³´ì¦ì¦ê¶Œ', 'ë¯¸ì •'],
      maintenanceServiceLevel: ['ë¯¸í¬í•¨(Self)', 'í¬í•¨(ê¸°ë³¸)', 'í¬í•¨(ê³ ê¸‰)', 'ë¯¸ì •'],
      customerStatus: ['ë°°ì •ë¨', 'ì—°ë½ ì‹œë„ ì¤‘', 'ìƒë‹´ ì§„í–‰ ì¤‘', 'ê²¬ì  ë°œì†¡', 'ì¶”ê°€ ì •ë³´ ìš”ì²­', 'ê°€ë§ ê³ ê°', 'ì‹¬ì‚¬ ì§„í–‰ì¤‘', 'ì‹¬ì‚¬ ì™„ë£Œ', 'ê³„ì•½ ì§„í–‰ì¤‘', 'ê³„ì•½ ì™„ë£Œ', 'ì¶œê³  ì™„ë£Œ', 'ê¸°ì¡´ ê³ ê°', 'ìƒë‹´ ë³´ë¥˜', 'ìƒë‹´ ì´íƒˆ'],
      addressCities: ['ì„œìš¸íŠ¹ë³„ì‹œ', 'ë¶€ì‚°ê´‘ì—­ì‹œ', 'ëŒ€êµ¬ê´‘ì—­ì‹œ', 'ì¸ì²œê´‘ì—­ì‹œ', 'ê´‘ì£¼ê´‘ì—­ì‹œ', 'ëŒ€ì „ê´‘ì—­ì‹œ', 'ìš¸ì‚°ê´‘ì—­ì‹œ', 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ', 'ê²½ê¸°ë„', 'ê°•ì›íŠ¹ë³„ìì¹˜ë„', 'ì¶©ì²­ë¶ë„', 'ì¶©ì²­ë‚¨ë„', 'ì „ë¶íŠ¹ë³„ìì¹˜ë„', 'ì „ë¼ë‚¨ë„', 'ê²½ìƒë¶ë„', 'ê²½ìƒë‚¨ë„', 'ì œì£¼íŠ¹ë³„ìì¹˜ë„']
    }
  };

  const loader = document.getElementById('loader');

  // ============================================================================
  // [2] UI ë° ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
  // ============================================================================
  function showLoader() { if(loader) loader.classList.remove('hidden'); }
  function hideLoader() { if(loader) loader.classList.add('hidden'); }
  
  function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
  }

  function formatPhoneNumber_Client(phone) {
    if (!phone) return "";
    const digits = phone.replace(/\D/g, "");
    if (digits.length === 11) return `${digits.substring(0, 3)}-${digits.substring(3, 7)}-${digits.substring(7)}`;
    if (digits.length === 10) return `${digits.substring(0, 3)}-${digits.substring(3, 6)}-${digits.substring(6)}`;
    return phone;
  }

  function formatDate(isoString) {
    if (!isoString) return '';
    try {
      return isoString.split('T')[0];
    } catch (e) {
      return isoString;
    }
  }

  function showErrorModal(message) { alert(message); }
  
  function handleFailure(error) {
    hideLoader();
    console.error(error);
    alert(`ì˜¤ë¥˜ ë°œìƒ: ${error.message || error}`);
  }
  
  function showSaveFeedback(btn) {
    const origin = btn.textContent;
    btn.textContent = "âœ… ì €ì¥ë¨";
    btn.disabled = true;
    setTimeout(() => { btn.textContent = origin; btn.disabled = false; }, 1500);
  }

  // [1] íƒ­ ì „í™˜ í•¨ìˆ˜ (ëª¨ë˜ ìŠ¤íƒ€ì¼ ì ìš© & íŒ¨ë„ ì œì–´)
  function switchTab(mode) {
    const customerPanel = document.getElementById('listPanel');
    const contractPanel = document.getElementById('contractListPanel');
    const custDetailPanel = document.getElementById('customerDetailPanel');
    const contDetailPanel = document.getElementById('contractDetailPanel');
    
    // 1. ìƒì„¸ íŒ¨ë„ë“¤ ëª¨ë‘ ë‹«ê¸°
    custDetailPanel.classList.add('hidden');
    contDetailPanel.classList.add('hidden');
    
    const btnCust = document.getElementById('tabCustomerBtn');
    const btnCont = document.getElementById('tabContractBtn');

    // íƒ­ ì „í™˜ ì‹œ ìƒì„¸ í™”ë©´ì˜ ì¶œì²˜(Source) ìƒíƒœ ì´ˆê¸°í™”
    window.customerDetailSource = null;
    currentContractSource = 'contract_list';

    if (mode === 'customer') {
      customerPanel.classList.remove('hidden');
      if(contractPanel) contractPanel.classList.add('hidden');
      
      // í´ë˜ìŠ¤ í† ê¸€ (CSS active í´ë˜ìŠ¤ í™œìš©)
      btnCust.classList.add('active'); 
      btnCont.classList.remove('active');
      
      fetchCustomers(true); // ê³ ê° ëª©ë¡ ê°±ì‹ 
      
    } else {
      customerPanel.classList.add('hidden');
      if(contractPanel) contractPanel.classList.remove('hidden');
      
      btnCust.classList.remove('active');
      btnCont.classList.add('active');
      
      fetchGlobalContracts(true); // ê³„ì•½ ëª©ë¡ ê°±ì‹ 
    }
  }

  // ============================================================================
  // [3] ë°ì´í„° ë³€í™˜ ë° UI ë Œë”ë§
  // ============================================================================
  function toUiData(dbData) {
    if (!dbData) return null;
    return {
      assignmentId: dbData.assignment_id,
      customerName: dbData.customer_name,
      customerPhoneNumber: dbData.customer_phone,
      assignedTo: dbData.assigned_to,
      dbType: dbData.db_type,
      assignmentDate: dbData.assignment_date,
      customerStatus: dbData.customer_status,
      // ìƒì„¸ ì •ë³´ë“¤
      leadSource: dbData.lead_source,
      customerType: dbData.customer_type,
      gender: dbData.gender,
      ageGroup: dbData.age_group,
      addressCity: dbData.address_city,
      // addressDistrict ì œê±°ë¨
      incomeType: dbData.income_type,
      creditInfo: dbData.credit_info,
      interestedCarModel: dbData.interested_car_model,
      comparisonCarModel: dbData.comparison_car_model,
      ownedCarModel: dbData.owned_car_model,
      carUsage: dbData.car_usage,
      driverScope: dbData.driver_scope,
      driving_distance: dbData.driving_distance,
      expectedContractTiming: dbData.expected_contract_timing,
      desiredContractTerm: dbData.desired_contract_term,
      desiredInitialCostType: dbData.desired_initial_cost_type,
      maintenanceServiceLevel: dbData.maintenance_service_level,
      salesCondition: dbData.sales_condition,
      isRepurchase: dbData.is_repurchase,
      paymentMethod: dbData.payment_method,
      customerMemo: dbData.customer_memo,
      quoteNumber: dbData.quote_number,
      approvalNumber: dbData.approval_number,
      occupation: dbData.occupation,
      lastLogDate: dbData.last_log_date
    };
  }

  async function populateSelectOptions() {
    const { data: dbTypeData } = await supabase.from('db_types').select('type_name').eq('is_active', true).order('sort_order', { ascending: true });
    let dbTypes = dbTypeData ? dbTypeData.map(i => i.type_name) : ['ê¸°íƒ€'];
    
    const populate = (id, opts) => {
      const el = document.getElementById(id);
      if (!el || el.tagName !== 'SELECT') return;
      const first = el.options[0]; el.innerHTML = ''; if (first) el.appendChild(first);
      opts.forEach(v => { const op = document.createElement('option'); op.value = v; op.textContent = v; el.appendChild(op); });
    };

    populate('filterDbType', dbTypes);
    populate('newDbType', dbTypes);

    const opts = CONFIG.selectOptions;
    populate('leadSource', opts.leadSource);
    populate('ageGroup', opts.ageGroup);
    populate('incomeType', opts.incomeType);
    populate('creditInfo', opts.creditInfo);
    populate('carUsage', opts.carUsage);
    populate('drivingDistance', opts.drivingDistance);
    populate('expectedContractTiming', opts.expectedContractTiming);
    populate('desiredContractTerm', opts.desiredContractTerm);
    populate('desiredInitialCostType', opts.desiredInitialCostType);
    populate('maintenanceServiceLevel', opts.maintenanceServiceLevel);
    populate('customerStatus', opts.customerStatus);

    Object.keys(opts).forEach(key => {
        // IDì™€ í‚¤ ë§¤í•‘ì´ í•„ìš”í•  ìˆ˜ ìˆìŒ (ì˜ˆ: customerStatus -> filterCustomerStatus)
        populate(key, opts[key]);
    });
    // ë³„ë„ ë§¤í•‘
    populate('filterCustomerStatus', opts.customerStatus);
    populate('addressCity', opts.addressCities);

  }

  function getStatusClass(status) {
    if (status === 'ìƒë‹´ ì™„ë£Œ') return 'completed';
    if (status === 'ìƒë‹´ ì§„í–‰ ì¤‘' || status === 'ì—°ë½ ì‹œë„ ì¤‘') return 'consulting';
    return '';
  }

  // ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜
  // [ìˆ˜ì •] ê³ ê° ëª©ë¡ ë Œë”ë§ (í—¤ë”ì™€ ì¤„ ë§ì¶¤ ì ìš©)
  function displayAssignedCustomers(customers, isNew) {
    const ul = document.getElementById('assignedCustomersList');
    const btn = document.getElementById('loadMoreBtn');
    if (isNew) ul.innerHTML = '';
    
    if (customers.length === 0 && isNew) {
      ul.innerHTML = '<li style="padding:20px; justify-content:center; color:#666;">ì¡°ê±´ì— ë§ëŠ” ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
    } else {
      customers.forEach(c => {
        const li = document.createElement('li');
        
        li.onclick = () => {
            window.customerDetailSource = 'listPanel'; 
            selectCustomer(c.assignmentId);
        };
        
        const statusClass = getStatusClass(c.customerStatus);
        
        // ë©”ëª¨ ê²°í•© ë¡œì§
        let combinedMemo = c.interestedCarModel || '';
        if(c.customerMemo) combinedMemo = combinedMemo ? `${combinedMemo} | ${c.customerMemo}` : c.customerMemo;
        if(!combinedMemo) combinedMemo = ''; // ë‚´ìš© ì—†ìœ¼ë©´ ê³µë€

        // ë‚ ì§œ í¬ë§·
        const dateStr = formatDate(c.assignmentDate);
        const lastLogStr = c.lastLogDate ? formatDate(c.lastLogDate) : '-';

        // â˜… [í•µì‹¬] í—¤ë”ì™€ ë™ì¼í•œ í´ë˜ìŠ¤(.col-*) ì‚¬ìš©ìœ¼ë¡œ ë„ˆë¹„ ê°•ì œ ì¼ì¹˜
        li.innerHTML = `
          <span class="col-db">${escapeHtml(c.dbType)}</span>
          <span class="col-status"><span class="status-badge ${statusClass}">${escapeHtml(c.customerStatus)}</span></span>
          <span class="col-name" title="${escapeHtml(c.customerName)}">${escapeHtml(c.customerName)}</span>
          <span class="col-phone">${escapeHtml(formatPhoneNumber_Client(c.customerPhoneNumber))}</span>
          <span class="col-memo" title="${escapeHtml(combinedMemo)}">${escapeHtml(combinedMemo)}</span>
          <span class="col-last">${lastLogStr}</span>
          <span class="col-date">${dateStr}</span>
        `;
        ul.appendChild(li);
      });
    }
    
    if (totalCustomerCount > (currentOffset + customers.length)) btn.classList.remove('hidden');
    else btn.classList.add('hidden');
    btn.disabled = false;
  }

  // ìƒì„¸ ì •ë³´ ë Œë”ë§
  function displayAssignmentDetails(result) {
    const data = result.assignment;
    currentAssignmentId = data.assignmentId;
    
    const setVal = (id, v) => {
      const el = document.getElementById(id);
      if(el) {
        if(el.type === 'date' && v) {
            el.value = formatDate(v);
        }
        else if(el.tagName === 'SPAN') {
            if(id.includes('Date') || id.includes('Time')) {
                el.textContent = formatDate(v);
            } else {
                el.textContent = v || '';
            }
        }
        else el.value = v || '';
      }
    };

    setVal('detailAssignmentId', data.assignmentId);
    setVal('detailDbType', data.dbType);
    setVal('detailAssignmentDate', data.assignmentDate);
    setVal('detailCustomerPhoneNumber', data.customerPhoneNumber);
    
    setVal('leadSource', data.leadSource);
    setVal('customerType', data.customerType);
    setVal('gender', data.gender);
    setVal('ageGroup', data.ageGroup);
    setVal('addressCity', data.addressCity);
    // addressDistrict ë¡œì§ ì‚­ì œë¨
    
    setVal('incomeType', data.incomeType);
    setVal('creditInfo', data.creditInfo);
    setVal('occupation', data.occupation);
    setVal('interestedCarModel', data.interestedCarModel);
    setVal('comparisonCarModel', data.comparisonCarModel);
    setVal('ownedCarModel', data.ownedCarModel);
    setVal('carUsage', data.carUsage);
    setVal('driverScope', data.driverScope);
    setVal('drivingDistance', data.drivingDistance);
    setVal('expectedContractTiming', data.expectedContractTiming);
    setVal('desiredContractTerm', data.desiredContractTerm);
    setVal('desiredInitialCostType', data.desiredInitialCostType);
    setVal('maintenanceServiceLevel', data.maintenanceServiceLevel);
    setVal('isRepurchase', data.isRepurchase);
    setVal('paymentMethod', data.paymentMethod);
    setVal('customerStatus', data.customerStatus);
    setVal('customerMemo', data.customerMemo);
    setVal('quoteNumber', data.quoteNumber);
    setVal('approvalNumber', data.approvalNumber);

    document.getElementById('detailCustomerNameText').textContent = data.customerName;
  }

  // â˜… [ìˆ˜ì •ë¨] ìƒë‹´ ë¡œê·¸ ë Œë”ë§ (ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ì¶”ê°€)
  function renderLogs(logs) {
    const div = document.getElementById('consultationLogs');
    div.innerHTML = '';
    
    if(!logs || logs.length === 0) {
      div.innerHTML = '<p style="text-align:center; padding:20px; color:#777;">ê¸°ë¡ ì—†ìŒ</p>';
      return;
    }

    logs.forEach(l => {
      const card = document.createElement('div');
      card.className = 'log-entry-card';
      
      const timeStr = new Date(l.logTimestamp).toLocaleString();
      // ì‘ì„±ì í‘œì‹œ (ì—†ìœ¼ë©´ 'ì‹œìŠ¤í…œ' ë“±ìœ¼ë¡œ ì²˜ë¦¬)
      const writer = l.userName || 'ìƒë‹´ì›'; 
      
      // ë³¸ì¸ ê¸€ì¸ì§€ í™•ì¸ (í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ëŒê³¼ ì‘ì„±ìê°€ ê°™ìœ¼ë©´ ë²„íŠ¼ í‘œì‹œ)
      // (currentUserName ë³€ìˆ˜ëŠ” ì „ì—­ë³€ìˆ˜ì— ìˆìŠµë‹ˆë‹¤)
      const isMyLog = (l.userName === currentUserName);
      
      let buttonsHtml = '';
      if (isMyLog) {
          buttonsHtml = `
            <div class="log-actions" style="display:flex; gap:8px; margin-top:8px; justify-content:flex-end;">
                <button onclick="editLog('${l.logId}', this)" class="secondary" style="padding:2px 8px; font-size:0.8rem;">ìˆ˜ì •</button>
                <button onclick="deleteLog('${l.logId}')" class="secondary" style="padding:2px 8px; font-size:0.8rem; background:#dc3545; border:none;">ì‚­ì œ</button>
            </div>
          `;
      }

      card.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
            <span class="log-time" style="color:#007bff; font-weight:bold; font-size:0.8rem;">${timeStr}</span>
            <span style="font-size:0.75rem; color:#999;">${escapeHtml(writer)}</span>
        </div>
        <div class="log-content" id="content-${l.logId}" style="white-space: pre-wrap; line-height:1.4;">${escapeHtml(l.logContent)}</div>
        ${buttonsHtml}
      `;
      div.appendChild(card);
    });
  }

  // [ìˆ˜ì • 1] ìƒì„¸í™”ë©´ìš© ê³„ì•½ ì´ë ¥ (ê³ ê°ëª… ì œì™¸)
  function renderContracts(contracts) {
    const ul = document.getElementById('contractList');
    ul.innerHTML = '';
    if(!contracts || contracts.length === 0) {
      ul.innerHTML = '<li style="text-align:center; padding:15px; color:#999; font-size:0.9rem;">ê³„ì•½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
      return;
    }
    contracts.forEach(c => {
      const li = document.createElement('li');
      // í´ë¦­ ì´ë²¤íŠ¸
      li.onclick = (e) => {
         e.stopPropagation();
         const currentName = document.getElementById('detailCustomerNameText').textContent;
         const contractData = { ...c, customers: c.customers || { customer_name: currentName } };
         viewContractDetail(contractData, 'customer_detail');
      };

      const cDate = formatDate(c.contract_date);
      const cModel = c.contract_car_model || '-';
      const cStatus = c.contract_status || '-';
      
      // â˜… [í•µì‹¬] CSS .col-cont-* í´ë˜ìŠ¤ ì‚¬ìš© (í—¤ë”ì™€ ë„ˆë¹„ ì¼ì¹˜)
      li.innerHTML = `
        <span class="col-cont-date" style="flex:0 0 90px;">${cDate}</span>
        <span class="col-cont-car" style="flex:1; padding-left:10px;" title="${escapeHtml(cModel)}">${escapeHtml(cModel)}</span>
        <span class="col-cont-status" style="flex:0 0 80px;"><span class="status-badge">${escapeHtml(cStatus)}</span></span>
      `;
      ul.appendChild(li);
    });
  }



  // [ìˆ˜ì • 2] ê³„ì•½ ê´€ë¦¬ íƒ­ìš© ì „ì²´ ëª©ë¡ (ê³ ê°ëª… í¬í•¨)
  function renderGlobalContracts(contracts) {
    const div = document.getElementById('globalContractList');
    if(!div) return; 
    div.innerHTML = '';
    if (!contracts || contracts.length === 0) {
      div.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">ì¡°íšŒëœ ê³„ì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }
    contracts.forEach(c => {
      const custName = (c.customers && c.customers.customer_name) ? c.customers.customer_name : '(ë¯¸í™•ì¸)';
      const cDate = formatDate(c.contract_date);
      const cStatus = c.contract_status || '-';
      
      const row = document.createElement('div');
      row.className = 'contract-row';
      row.onclick = () => viewContractDetail(c);

      // â˜… [í•µì‹¬] CSS .col-cont-* í´ë˜ìŠ¤ ì‚¬ìš© (í—¤ë”ì™€ ë„ˆë¹„ ì¼ì¹˜)
      row.innerHTML = `
        <span class="col-cont-date">${cDate}</span>
        <span class="col-cont-car">${escapeHtml(c.contract_car_model)}</span>
        <span class="col-cont-cust">${escapeHtml(custName)}</span>
        <span class="col-cont-status"><span class="status-badge">${escapeHtml(cStatus)}</span></span>
      `;
      div.appendChild(row);
    });
  }
  
  
  // [3] â˜… ì‹ ê·œ: ê³„ì•½ ìƒì„¸ í™”ë©´ ë³´ê¸° í•¨ìˆ˜
  let currentViewingContract = null; // í˜„ì¬ ë³´ê³  ìˆëŠ” ê³„ì•½ ë°ì´í„° ì„ì‹œ ì €ì¥

  // [ìˆ˜ì •] ê³„ì•½ ìƒì„¸ ë³´ê¸° (ì§„ì… ê²½ë¡œ ì²˜ë¦¬ ì¶”ê°€)
  // source: 'contract_list' (ê¸°ë³¸ê°’) ë˜ëŠ” 'customer_detail'
  let currentContractSource = 'contract_list'; 
  
  // [JavaScript.html] viewContractDetail í•¨ìˆ˜ (ì™„ë²½ ìˆ˜ì • ë²„ì „)
  
  async function viewContractDetail(contractData, source = 'contract_list') {
    currentViewingContract = contractData;
    currentContractSource = source;

    // íŒ¨ë„ ì „í™˜
    document.getElementById('listPanel').classList.add('hidden');
    if(document.getElementById('contractListPanel')) document.getElementById('contractListPanel').classList.add('hidden');
    document.getElementById('customerDetailPanel').classList.add('hidden');
    document.getElementById('contractDetailPanel').classList.remove('hidden');

    // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ í…ìŠ¤íŠ¸ ì„¤ì •
    const backBtn = document.getElementById('dynamicBackBtn');
    if(backBtn) {
        if(source === 'customer_detail') {
            backBtn.innerHTML = '&larr; ê³ ê° ìƒì„¸ë¡œ ëŒì•„ê°€ê¸°';
        } else {
            backBtn.innerHTML = '&larr; ê³„ì•½ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°';
        }
    }

    // ë°ì´í„° ë°”ì¸ë”© ë„ìš°ë¯¸
    const setTxt = (id, txt) => {
        const el = document.getElementById(id);
        if(el) el.textContent = txt || '-';
    };

    // 1. ê¸°ë³¸ ì •ë³´ ì±„ìš°ê¸°
    setTxt('viewContStatus', contractData.contract_status);
    setTxt('viewContDate', formatDate(contractData.contract_date));
    setTxt('viewContCar', contractData.contract_car_model);
    setTxt('viewContAmount', contractData.contract_amount ? Number(contractData.contract_amount).toLocaleString() + 'ì›' : '0ì›');
    setTxt('viewContTerm', contractData.contract_term);
    setTxt('viewContSummary', contractData.contract_summary);
    
    // 2. ëª…ì˜ì(ì‹¤ê³„ì•½ì) ì •ë³´ ì±„ìš°ê¸°
    // contractData.customersëŠ” í•­ìƒ assignment_id(ëª…ì˜ì)ì™€ ì¡°ì¸ëœ ì •ë³´ì…ë‹ˆë‹¤.
    const realContractorName = (contractData.customers && contractData.customers.customer_name) 
                               ? contractData.customers.customer_name 
                               : '(ì •ë³´ ì—†ìŒ)';
    const relation = contractData.relationship || 'ë³¸ì¸';

    setTxt('viewContRealName', realContractorName); 
    setTxt('viewContRelation', relation);           

    // 3. â˜… [ìˆ˜ì •ë¨] ì´ìš©ì(ìƒë‹´) ì´ë¦„ í‘œì‹œ ë¡œì§
    const contractorId = contractData.assignment_id; 
    const consultantId = contractData.consultant_id || contractData.assignment_id;

    // Case 1: ë³¸ì¸ ê³„ì•½ (ëª…ì˜ì = ìƒë‹´ì)
    if (contractorId === consultantId) {
        setTxt('viewContCustomerName', realContractorName);
    } 
    // Case 2: íƒ€ì¸ ëª…ì˜ ê³„ì•½
    else {
        // í˜„ì¬ ìƒì„¸ í™”ë©´ì— ë– ìˆëŠ” ê³ ê°ì´ 'ìƒë‹´ì' ë³¸ì¸ì¸ì§€ í™•ì¸
        // (currentAssignmentIdëŠ” í˜„ì¬ ìƒì„¸ íŒ¨ë„ì— ë¡œë“œëœ ê³ ê° IDì…ë‹ˆë‹¤)
        const isViewingConsultantPage = (currentAssignmentId === consultantId);

        if (source === 'customer_detail' && isViewingConsultantPage) {
             // ìƒí™©: ìƒë‹´ì ë³¸ì¸ì˜ ìƒì„¸ í˜ì´ì§€ì—ì„œ ë³´ê³  ìˆìŒ -> í˜„ì¬ í˜ì´ì§€ ì´ë¦„ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
             const currentCustName = document.getElementById('detailCustomerNameText').textContent;
             setTxt('viewContCustomerName', currentCustName);
        } else {
             // ìƒí™©: ì‹¤ê³„ì•½ì í˜ì´ì§€ì—ì„œ ë³´ê³  ìˆê±°ë‚˜, ì „ì²´ ë¦¬ìŠ¤íŠ¸ì—ì„œ ë“¤ì–´ì˜´ 
             // -> ìƒë‹´ì ì´ë¦„ì€ ë³„ë„ë¡œ ì¡°íšŒí•´ì•¼ í•¨
             setTxt('viewContCustomerName', '(ì¡°íšŒ ì¤‘...)');
             
             const { data: consultantData } = await supabase
                 .from('customers')
                 .select('customer_name')
                 .eq('assignment_id', consultantId)
                 .maybeSingle();
             
             if (consultantData) {
                 setTxt('viewContCustomerName', consultantData.customer_name);
             } else {
                 setTxt('viewContCustomerName', '(ì •ë³´ ì—†ìŒ)');
             }
        }
    }

    // 4. ë²„íŠ¼ ë¶„ê¸° ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
    const singleBtnArea = document.getElementById('singleButtonArea');
    const dualBtnArea = document.getElementById('dualButtonArea');
    
    if (contractorId !== consultantId) {
          singleBtnArea.classList.add('hidden');
          dualBtnArea.classList.remove('hidden');
          
          const contractorLabelName = (contractData.customers && contractData.customers.customer_name) ? contractData.customers.customer_name : 'ì‹¤ê³„ì•½ì';
          document.getElementById('goToContractorBtn').innerHTML = `ğŸ“‘ ì‹¤ê³„ì•½ì(${contractorLabelName}) &rarr;`;
          
          // ìƒë‹´ì ë²„íŠ¼ í…ìŠ¤íŠ¸ë„ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆì§€ë§Œ, ì´ë¦„ì„ ëª¨ë¥¼ ë• 'ìƒë‹´ ê³ ê°'ìœ¼ë¡œ ë‘¡ë‹ˆë‹¤.
    } else {
          singleBtnArea.classList.remove('hidden');
          dualBtnArea.classList.add('hidden');
    }
  }

  // [ìˆ˜ì •] ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ë¡œì§)
  // setupGlobalEventListeners í•¨ìˆ˜ ì•ˆì˜ ê¸°ì¡´ backToContractListBtn ë¦¬ìŠ¤ë„ˆë¥¼ ì´ê±¸ë¡œ êµì²´í•˜ì„¸ìš”.
  const backBtn = document.getElementById('dynamicBackBtn');
  if(backBtn) {
      backBtn.addEventListener('click', (e) => {
          e.preventDefault();
          document.getElementById('contractDetailPanel').classList.add('hidden');
          
          if(currentContractSource === 'customer_detail') {
              // ê³ ê° ìƒì„¸ë¡œ ë³µê·€
              document.getElementById('customerDetailPanel').classList.remove('hidden');
          } else {
              // ê³„ì•½ ëª©ë¡ìœ¼ë¡œ ë³µê·€
              document.getElementById('contractListPanel').classList.remove('hidden');
          }
      });
  }





// [JavaScript.html] Cloud Run ì£¼ì†Œ í™•ì¸
// â˜… ë’¤ì— ê²½ë¡œê°€ ë°”ë€Œì—ˆìŠµë‹ˆë‹¤ (ì£¼ì˜!)
// ì˜ˆ: https://...run.app  (ë’¤ì— /analyze ê°™ì€ê±° ë¶™ì´ì§€ ë§ˆì‹œê³  ë„ë©”ì¸ê¹Œì§€ë§Œ)
const CLOUD_RUN_BASE_URL = "https://rental-analyzer-812042135518.asia-northeast3.run.app"; 

const btnAnalyze = document.getElementById('btnAnalyzeVoice');
const fileInput = document.getElementById('voiceFileInput');

if (btnAnalyze && fileInput) {
  btnAnalyze.addEventListener('click', () => {
    fileInput.value = ''; 
    fileInput.click();
  });

  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!confirm(`'${file.name}' ë¶„ì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(1ì‹œê°„ ì´ìƒ íŒŒì¼ë„ ë¬´ë£Œë¡œ ì²˜ë¦¬ê°€ëŠ¥)`)) return;

    showLoader(); 
    
    try {
      // ê³ ìœ  ID ìƒì„±
      const fileId = `upload_${Date.now()}_${Math.floor(Math.random()*1000)}`;
      
      // 10MB ë‹¨ìœ„ë¡œ ìª¼ê°œê¸° (Cloud Run ì œí•œ 32MB íšŒí”¼ìš©)
      const CHUNK_SIZE = 10 * 1024 * 1024; 
      const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
      
      // 1. ì¡°ê° ì—…ë¡œë“œ (ë°˜ë³µ)
      for (let i = 0; i < totalChunks; i++) {
          const start = i * CHUNK_SIZE;
          const end = Math.min(file.size, start + CHUNK_SIZE);
          const chunk = file.slice(start, end);
          
          // ì§„í–‰ë¥  í‘œì‹œ
          const percent = Math.round(((i) / totalChunks) * 100);
          setStatusMessage(`ğŸ“¡ ì „ì†¡ ì¤‘... ${percent}% (${i+1}/${totalChunks})`);

          const formData = new FormData();
          formData.append("file", chunk);
          formData.append("file_id", fileId);
          formData.append("chunk_index", i);

          const res = await fetch(`${CLOUD_RUN_BASE_URL}/upload-chunk`, {
              method: "POST",
              body: formData
          });
          
          if (!res.ok) throw new Error(`Chunk ${i} upload failed`);
      }

      // 2. í•©ì²´ ë° ë¶„ì„ ìš”ì²­
      setStatusMessage("ğŸ¤– AI ë¶„ì„ ì¤‘... (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)");
      
      // íŒŒì¼ íƒ€ì… ì•ˆì „ì¥ì¹˜
      let mimeType = file.type;
      if (!mimeType && file.name.toLowerCase().endsWith('.m4a')) mimeType = 'audio/mp4';
      if (!mimeType) mimeType = 'audio/mp3';

      const finalForm = new FormData();
      finalForm.append("file_id", fileId);
      finalForm.append("total_chunks", totalChunks);
      finalForm.append("file_name", file.name);
      finalForm.append("mime_type", mimeType);

      const analyzeRes = await fetch(`${CLOUD_RUN_BASE_URL}/analyze-chunked`, {
          method: "POST",
          body: finalForm
      });

      const result = await analyzeRes.json();

      if (!result.success) {
        throw new Error(result.error);
      }
      
      const parsedData = result.data;
      onAnalysisSuccess({ success: true, data: parsedData });

    } catch (err) {
      alert("âŒ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
      console.error(err);
    } finally {
      hideLoader();
    }
  });
}

// [í—¬í¼] ë¡œë”© ë©”ì‹œì§€ ë³€ê²½ (loader ë‚´ë¶€ì— í…ìŠ¤íŠ¸ê°€ ìˆë‹¤ë©´)
function setStatusMessage(msg) {
  const loaderText = document.querySelector('#loader p');
  if(loaderText) loaderText.textContent = msg;
}

  // (onAnalysisSuccess í•¨ìˆ˜ëŠ” ì´ì „ ë‹µë³€ì— ë“œë¦° ê²ƒ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì‹œë©´ ë©ë‹ˆë‹¤.)

  // ============================================================================
  // [4] ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (API í˜¸ì¶œ)
  // ============================================================================
  
  // [JavaScript.html] fetchCustomers í•¨ìˆ˜ ì „ì²´ êµì²´ (ì •ë ¬ ë¡œì§ ê°œì„ )
  async function fetchCustomers(isNew = false) {
  if(isNew) {
    currentOffset = 0;
    const getSafeVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };
    currentFilters = {
      searchTerm: getSafeVal('filterSearchTerm'),
      dbType: getSafeVal('filterDbType'),
      status: getSafeVal('filterCustomerStatus'),
      dateFrom: getSafeVal('filterAssignmentDateFrom'),
      dateTo: getSafeVal('filterAssignmentDateTo')
    };
  } else {
    currentOffset += PAGE_SIZE;
  }

  showLoader();
  try {
    // â˜… [í•µì‹¬ ìˆ˜ì •] ì •ë ¬ ì˜µì…˜ ì„¤ì •
    // 'ìµœê·¼ìƒë‹´(last_log_date)'ìœ¼ë¡œ ì •ë ¬í•  ë•ŒëŠ” ê°’ì´ ì—†ëŠ” ì‚¬ëŒ(ìƒë‹´ ì•ˆ í•¨)ì„ ë¬´ì¡°ê±´ ë§¨ ìœ„ë¡œ(nullsFirst: true)
    // ê·¸ ì™¸(ë°°ì •ì¼ ë“±)ëŠ” ê¸°ë³¸ê°’(false) ì‚¬ìš©
    const isLastLogSort = (currentSortColumn === 'last_log_date');
    const nullsFirstOption = isLastLogSort ? true : false;

    let query = supabase.from('customers').select('*', { count: 'exact' })
      .range(currentOffset, currentOffset + PAGE_SIZE - 1)
      .order(currentSortColumn, { ascending: currentSortAscending, nullsFirst: nullsFirstOption });

    if (currentUserName) {
      query = query.eq('assigned_to', currentUserName);
    }

    // ê²€ìƒ‰ ë¡œì§
    if(currentFilters.searchTerm) {
       const term = currentFilters.searchTerm;
       const cleanTerm = term.replace(/-/g, ''); 

       const searchConditions = [
          `customer_name.ilike.%${term}%`,
          `customer_phone.ilike.%${cleanTerm}%`, 
          `customer_phone.ilike.%${term}%`,
          `customer_memo.ilike.%${term}%`,
          `interested_car_model.ilike.%${term}%`
       ].join(',');

       query = query.or(searchConditions);
    }
    
    if(currentFilters.status) query = query.eq('customer_status', currentFilters.status);
    if(currentFilters.dbType) query = query.eq('db_type', currentFilters.dbType);
    if(currentFilters.dateFrom) query = query.gte('assignment_date', currentFilters.dateFrom);
    if(currentFilters.dateTo) {
      const d = new Date(currentFilters.dateTo); d.setDate(d.getDate()+1);
      query = query.lt('assignment_date', d.toISOString());
    }

    const { data, count, error } = await query;
    if(error) throw error;
    
    totalCustomerCount = count;
    displayAssignedCustomers(data.map(toUiData), isNew);
  } catch(e) {
    handleFailure(e);
  } finally {
    hideLoader();
  }
}

  // 4-2. ê³„ì•½ ëª©ë¡ ì¡°íšŒ (ë‚´ ë‹´ë‹¹ ê³ ê°ì˜ ê³„ì•½ë§Œ í•„í„°ë§)
  // [ìˆ˜ì •] í˜ì´ì§• ê¸°ëŠ¥ ì¶”ê°€
  async function fetchGlobalContracts(isNew = false) {
    if (isNew) {
      currentContractOffset = 0; // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™” í•„ìš”
    } else {
      currentContractOffset += PAGE_SIZE;
    }

    showLoader();
    try {
      // â˜… [í•µì‹¬ ìˆ˜ì •] 
      // 1. customers!inner(...) : ê³„ì•½ì— ì—°ê²°ëœ ê³ ê° ì •ë³´ê°€ ë°˜ë“œì‹œ ìˆì–´ì•¼ í•˜ë©°, ê·¸ ê³ ê°ì˜ ì¡°ê±´ìœ¼ë¡œ í•„í„°ë§í•˜ê² ë‹¤ëŠ” ëœ»
      // 2. .eq('customers.assigned_to', currentUserName) : ê³ ê°ì˜ ë‹´ë‹¹ìê°€ 'ë‚˜(currentUserName)'ì¸ ê²ƒë§Œ ê°€ì ¸ì˜´
      let query = supabase
        .from('contracts')
        .select('*, customers!inner(customer_name, customer_phone, assigned_to)')
        .eq('customers.assigned_to', currentUserName) // ë‚´ ë‹´ë‹¹ ê³ ê°ì˜ ê³„ì•½ë§Œ!
        .order('contract_date', { ascending: false });

      // í•„í„° ì ìš©
      const statusEl = document.getElementById('filterContractStatus');
      const termEl = document.getElementById('contractSearchTerm');
      const dateEl = document.getElementById('filterContractDateFrom');
      
      if (statusEl && statusEl.value) query = query.eq('contract_status', statusEl.value);
      
      // ê²€ìƒ‰ì–´ (ì°¨ì¢… or ê³ ê°ëª…)
      if (termEl && termEl.value) {
        // ê³ ê°ëª…ì€ customers í…Œì´ë¸”ì— ìˆìœ¼ë¯€ë¡œ ê²€ìƒ‰ ë¡œì§ì´ ì¡°ê¸ˆ ë³µì¡í•©ë‹ˆë‹¤.
        // ìš°ì„ ì€ ê°€ì¥ í™•ì‹¤í•œ 'ì°¨ì¢…' ê²€ìƒ‰ê³¼ 'ê³ ê°ëª…(ì¡°ì¸ëœ)' ê²€ìƒ‰ì„ ì‹œë„í•©ë‹ˆë‹¤.
        // Supabaseì—ì„œ ì¡°ì¸ëœ í…Œì´ë¸” ì»¬ëŸ¼ ê²€ìƒ‰ì€ ì œì•½ì´ ì¢€ ìˆì–´ì„œ, 
        // ì—¬ê¸°ì„œëŠ” 'ì°¨ì¢…' ê²€ìƒ‰ë§Œ ìš°ì„  ì ìš©í•˜ê±°ë‚˜, ì•„ë˜ì²˜ëŸ¼ or ì¡°ê±´ì„ ì”ë‹ˆë‹¤.
        // (ë‹¨, ì¡°ì¸ í•„í„°ë§ê³¼ or ê²€ìƒ‰ì„ ì„ìœ¼ë©´ ë³µì¡í•´ì§ˆ ìˆ˜ ìˆì–´ ì°¨ì¢… ê²€ìƒ‰ ìœ„ì£¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤)
        query = query.ilike('contract_car_model', `%${termEl.value}%`);
      }
      
      if (dateEl && dateEl.value) query = query.gte('contract_date', dateEl.value);

      const { data, count, error } = await query; // countë„ ë°›ìŒ
      if (error) throw error;

      // isNew ì—¬ë¶€ì— ë”°ë¼ ë®ì–´ì“°ê±°ë‚˜ ì´ì–´ë¶™ì´ê¸°
      if (isNew) {
          renderGlobalContracts(data, true); // true í”Œë˜ê·¸ ì „ë‹¬ (render í•¨ìˆ˜ ìˆ˜ì • í•„ìš”)
      } else {
          renderGlobalContracts(data, false);
      }
      
      // (ì„ íƒ ì‚¬í•­) 'ë”ë³´ê¸°' ë²„íŠ¼ ë¡œì§ì„ ê³„ì•½ íƒ­ì—ë„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    } catch (e) {
      handleFailure(e);
    } finally {
      hideLoader();
    }
}
  async function selectCustomer(id) {
    showLoader();
    try {
      // â˜… [ìˆ˜ì • 1] .single() -> .maybeSingle()ë¡œ ë³€ê²½í•˜ì—¬ ì—ëŸ¬ ë°©ì§€
      const { data: cust, error: e1 } = await supabase.from('customers').select('*').eq('assignment_id', id).maybeSingle();
      
      if (e1) throw e1;
      // â˜… [ìˆ˜ì • 2] ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
      if (!cust) throw new Error("ì‚­ì œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê³ ê°ì…ë‹ˆë‹¤.");
      
      const { data: logs, error: e2 } = await supabase.from('consultation_logs').select('*').eq('assignment_id', id).order('log_timestamp', {ascending:false});
      if(e2) throw e2;

      const { data: contracts, error: e3 } = await supabase.from('contracts')
        .select('*, customers(customer_name)') 
        .or(`assignment_id.eq.${id},consultant_id.eq.${id}`)
        .order('contract_date', {ascending:false});
      if(e3) throw e3;

      // â˜… [í™”ë©´ ì „í™˜ ë¡œì§ ìˆ˜ì •] 
      // ê¸°ì¡´ì— ì¼œì ¸ ìˆì„ ìˆ˜ ìˆëŠ” ëª¨ë“  íŒ¨ë„ì„ í™•ì‹¤í•˜ê²Œ ìˆ¨ê²¨ì•¼ í•©ë‹ˆë‹¤.
      document.getElementById('listPanel').classList.add('hidden');
      if(document.getElementById('contractListPanel')) document.getElementById('contractListPanel').classList.add('hidden');
      
      // [ì¶”ê°€] ê³„ì•½ ìƒì„¸ íŒ¨ë„ë„ ìˆ¨ê¹€ ì²˜ë¦¬
      const contractPanel = document.getElementById('contractDetailPanel');
      if(contractPanel) contractPanel.classList.add('hidden');

      // ê³ ê° ìƒì„¸ íŒ¨ë„ë§Œ í‘œì‹œ
      document.getElementById('customerDetailPanel').classList.remove('hidden');

      displayAssignmentDetails({ assignment: toUiData(cust) });
      // log_idì™€ user_name(ì‘ì„±ì) ì •ë³´ê¹Œì§€ í¬í•¨í•´ì„œ ì „ë‹¬
      renderLogs(logs.map(l => ({ 
          logId: l.log_id, 
          logTimestamp: l.log_timestamp, 
          logContent: l.log_content,
          userName: l.user_name 
      })));
      renderContracts(contracts);

    } catch(e) {
      handleFailure(e);
    } finally {
      hideLoader();
    }
  }

  // ============================================================================
  // [5] ë©”ì¸ ì‹¤í–‰ (DOMContentLoaded)
  // ============================================================================
  document.addEventListener('DOMContentLoaded', async () => {
    
    // URL í•´ì‹œ ì²´í¬ (ë¡œê·¸ì¸ íŒì—…)
    google.script.url.getLocation(async function(location) {
        const hash = location.hash; 
        
        if (hash && hash.includes('access_token')) {
            const loginModal = document.getElementById('loginModal');
            if(loginModal) loginModal.classList.add('hidden');

            const params = new URLSearchParams(hash.startsWith('#') ? hash.substring(1) : hash);
            const accessToken = params.get('access_token');
            const refreshToken = params.get('refresh_token');

            if (accessToken) {
                const { error } = await supabase.auth.setSession({
                    access_token: accessToken,
                    refresh_token: refreshToken || ''
                });

                if (!error) {
                    document.body.innerHTML = `
                        <div style="height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; font-family:sans-serif; background:#f9f9f9;">
                            <h2 style="color:#28a745;">âœ… ë¡œê·¸ì¸ ì„±ê³µ!</h2>
                            <p style="color:#555;">ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                            <p>ì´ íƒ­ì„ ë‹«ê³  <b>ì›ë˜ ì°½ì„ ìƒˆë¡œê³ ì¹¨</b> í•˜ì„¸ìš”.</p>
                            <button id="closeBtn" style="padding:12px 24px; background:#007bff; color:white; border:none; border-radius:5px; font-size:16px; cursor:pointer; margin-top:20px;">ì°½ ë‹«ê¸°</button>
                        </div>
                    `;
                    document.getElementById('closeBtn').onclick = function() {
                        window.open('', '_self').close(); 
                        alert("ì°½ì´ ë‹«íˆì§€ ì•Šìœ¼ë©´ ìˆ˜ë™ìœ¼ë¡œ ë‹«ì•„ì£¼ì„¸ìš”.");
                    };
                    setTimeout(() => window.open('', '_self').close(), 1000);
                    return; 
                }
            }
        }
        initApp();
    });
  });

  async function initApp() {
    await populateSelectOptions();
    
    // ê¸°ë³¸ ë‚ ì§œ ì„¤ì • (ìµœê·¼ 3ê°œì›”)
    const dateFromEl = document.getElementById('filterAssignmentDateFrom');
    if (dateFromEl) {
      const today = new Date();
      const prev = new Date(); prev.setMonth(today.getMonth()-3);
      dateFromEl.value = prev.toISOString().split('T')[0];
    }

    setupGlobalEventListeners();

    const { data } = await supabase.auth.getSession();
    if (data.session) onSessionValid(data.session);
    else document.getElementById('loginModal').classList.remove('hidden');

    supabase.auth.onAuthStateChange((event, sess) => {
        if (event === 'SIGNED_IN' && sess) onSessionValid(sess);
        else if (event === 'SIGNED_OUT') document.getElementById('loginModal').classList.remove('hidden');
    });
  }

  async function onSessionValid(sess) {
    session = sess;
    currentUserEmail = sess.user.email;
    document.getElementById('loginModal').classList.add('hidden');
    
    // â˜… [ìˆ˜ì •] .maybeSingle()ë¡œ ë³€ê²½í•˜ì—¬ 406 ì—ëŸ¬ ë°©ì§€
    const { data } = await supabase.from('profiles').select('korean_name').eq('email', currentUserEmail).maybeSingle();
    currentUserName = data ? data.korean_name : currentUserEmail;
    console.log("Logged in as:", currentUserName);
    
    fetchCustomers(true);
  }

  // ============================================================================
  // [6] ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ëª¨ìŒ
  // ============================================================================
  function setupGlobalEventListeners() {
    
    // íƒ­ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ
    const tabCustomerBtn = document.getElementById('tabCustomerBtn');
    const tabContractBtn = document.getElementById('tabContractBtn');
    
    if(tabCustomerBtn) {
        tabCustomerBtn.addEventListener('click', () => switchTab('customer'));
    }
    if(tabContractBtn) {
        tabContractBtn.addEventListener('click', () => switchTab('contract'));
    }
    
    // ê³„ì•½ ê²€ìƒ‰ ë²„íŠ¼
    const searchContractBtn = document.getElementById('searchContractBtn');
    if(searchContractBtn) {
        searchContractBtn.addEventListener('click', () => fetchGlobalContracts(true));
    }

    // êµ¬ê¸€ ë¡œê·¸ì¸ ë²„íŠ¼
    const loginBtn = document.getElementById('googleLoginBtn');
    if(loginBtn) {
      loginBtn.addEventListener('click', async () => {
        const redirectUrl = document.body.dataset.scriptUrl || "https://script.google.com/macros/s/AKfycbwV96l1hMuWCUMn4vLHPxvC6XM0NeKh1YREjZp1sYMgYqHL0F2JohW63NI0Rf5vWI5a/exec";
        const { data, error } = await supabase.auth.signInWithOAuth({
          provider: 'google',
          options: { 
            redirectTo: redirectUrl, 
            skipBrowserRedirect: true, 
            queryParams: { access_type: 'offline', prompt: 'consent' } 
          }
        });
        if (error) alert(error.message);
        else if (data.url) window.open(data.url, '_blank');
      });
    }
    
    // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
        const { error } = await supabase.auth.signOut();
        if (error) {
          alert("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: " + error.message);
        } else {
          alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
          window.location.reload(); 
        }
      });
    }

    // í•„í„° ê´€ë ¨ ë²„íŠ¼
    document.getElementById('applyFilterBtn').addEventListener('click', () => fetchCustomers(true));
    document.getElementById('loadMoreBtn').addEventListener('click', () => fetchCustomers(false));
    document.getElementById('resetFilterBtn').addEventListener('click', () => {
        const setVal = (id, v) => { const el = document.getElementById(id); if(el) el.value = v; };
        setVal('filterSearchTerm', '');
        setVal('filterDbType', '');
        setVal('filterCustomerStatus', '');
        setVal('filterAssignmentDateFrom', ''); 
        setVal('filterAssignmentDateTo', '');
        fetchCustomers(true);
    });

    // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ (ê³ ê° ìƒì„¸ -> ëª©ë¡)
    document.getElementById('backToListBtn').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('customerDetailPanel').classList.add('hidden');
      
      if (window.customerDetailSource === 'contractDetailPanel') {
          document.getElementById('contractDetailPanel').classList.remove('hidden');
      } else {
          document.getElementById('listPanel').classList.remove('hidden');
      }
    });

    // ìœ í‹¸ë¦¬í‹°: ê°’ ê°€ì ¸ì˜¤ê¸°
    const getVal = (id) => {
        const el = document.getElementById(id);
        return el ? el.value : ''; 
    };

    // ê³„ì•½ ìƒì„¸ í™”ë©´ -> ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
    const backToContListBtn = document.getElementById('backToContractListBtn');
    if(backToContListBtn) {
        backToContListBtn.addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('contractDetailPanel').classList.add('hidden');
            document.getElementById('contractListPanel').classList.remove('hidden');
        });
    }

    // ê³ ê° ì •ë³´ ì €ì¥ ë²„íŠ¼
    document.getElementById('saveCustomerDetailsBtn').addEventListener('click', async (e) => {
      if(!currentAssignmentId) return;
      
      const updates = {
        customer_type: getVal('customerType'),
        gender: getVal('gender'),
        age_group: getVal('ageGroup'),
        address_city: getVal('addressCity'),
        income_type: getVal('incomeType'),
        credit_info: getVal('creditInfo'),
        interested_car_model: getVal('interestedCarModel'),
        comparison_car_model: getVal('comparisonCarModel'),
        owned_car_model: getVal('ownedCarModel'),
        car_usage: getVal('carUsage'),
        driver_scope: getVal('driverScope'),
        driving_distance: getVal('drivingDistance'),
        expected_contract_timing: getVal('expectedContractTiming'),
        desired_contract_term: getVal('desiredContractTerm'),
        desired_initial_cost_type: getVal('desiredInitialCostType'),
        maintenance_service_level: getVal('maintenanceServiceLevel'),
        is_repurchase: getVal('isRepurchase'),
        payment_method: getVal('paymentMethod'),
        customer_status: getVal('customerStatus'),
        customer_memo: getVal('customerMemo'),
        quote_number: getVal('quoteNumber'),
        approval_number: getVal('approvalNumber'),
        lead_source: getVal('leadSource'),
        occupation: getVal('occupation'),
        updated_at: new Date().toISOString()
      };
      
      showLoader();
      const { error } = await supabase.from('customers').update(updates).eq('assignment_id', currentAssignmentId);
      hideLoader();
      if(error) handleFailure(error);
      else showSaveFeedback(e.target);
    });

    // â˜… [ìˆ˜ì •ë¨] ìƒë‹´ ë¡œê·¸ ì¶”ê°€ (ê³ ê° í…Œì´ë¸” ë‚ ì§œ ê°±ì‹  ë¡œì§ í¬í•¨)
    document.getElementById('addLogBtn').addEventListener('click', async () => {
      if(!currentAssignmentId) return;
      const txt = document.getElementById('newLogContent').value.trim();
      if(!txt) return alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
      
      showLoader();
      const nowISO = new Date().toISOString(); 

      // 1. ìƒë‹´ ë¡œê·¸ ì¶”ê°€
      const newLog = {
        log_id: 'LOG_' + Date.now(),
        assignment_id: currentAssignmentId,
        log_content: txt,
        user_name: currentUserName,
        log_timestamp: nowISO
      };
      
      const { error: logError } = await supabase.from('consultation_logs').insert([newLog]);

      if(logError) {
        handleFailure(logError);
        return; // ë¡œê·¸ ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨
      } 

      // 2. ê³ ê° í…Œì´ë¸”ì˜ last_log_date ê°±ì‹ 
      const { error: custError } = await supabase
        .from('customers')
        .update({ 
            last_log_date: nowISO,     
            updated_at: nowISO         
        })
        .eq('assignment_id', currentAssignmentId);

      if (custError) {
          console.warn("ë¡œê·¸ëŠ” ì €ì¥ë˜ì—ˆìœ¼ë‚˜ ê³ ê° ë‚ ì§œ ê°±ì‹  ì‹¤íŒ¨:", custError);
      }

      // 3. UI ê°±ì‹  ë° ì´ˆê¸°í™”
      hideLoader();
      document.getElementById('newLogContent').value = '';
      selectCustomer(currentAssignmentId); // ìƒì„¸ í™”ë©´ ë¦¬ë¡œë“œ
    });

    // ì „í™”ë²ˆí˜¸ ìˆ˜ì • (ìˆ«ìë§Œ ì €ì¥)
    document.getElementById('savePhoneNumberBtn').addEventListener('click', async(e) => {
      if(!currentAssignmentId) return;
      const ph = document.getElementById('detailCustomerPhoneNumber').value;
      const rawPhone = ph.replace(/\D/g, "");
      
      showLoader();
      const { error } = await supabase.from('customers').update({
          customer_phone: rawPhone 
      }).eq('assignment_id', currentAssignmentId);
      
      hideLoader();
      if(error) handleFailure(error);
      else showSaveFeedback(e.target);
    });

    // ì‹ ê·œ ê³ ê° ëª¨ë‹¬ ê´€ë ¨
    document.getElementById('openAddCustomerModalBtn').addEventListener('click', () => document.getElementById('addCustomerModal').classList.remove('hidden'));
    document.getElementById('cancelAddCustomerBtn').addEventListener('click', () => document.getElementById('addCustomerModal').classList.add('hidden'));
    
    // ì‹ ê·œ ê³ ê° ì €ì¥
    document.getElementById('saveNewCustomerBtn').addEventListener('click', async () => {
      const name = document.getElementById('newCustomerName').value;
      let phone = document.getElementById('newCustomerPhoneNumber').value;
      const dbType = document.getElementById('newDbType').value;
      
      if(!name) return alert('ì´ë¦„ í•„ìˆ˜');

      phone = phone.replace(/\D/g, ""); 

      showLoader();
      const ts = Date.now();
      const { error } = await supabase.from('customers').insert([{
        assignment_id: "A_" + ts,
        customer_id: "C_" + ts,
        customer_name: name,
        customer_phone: formatPhoneNumber_Client(phone),
        db_type: dbType,
        assigned_to: currentUserName,
        owner_email: currentUserEmail,
        assignment_date: new Date().toISOString(),
        customer_status: "ë°°ì •ë¨"
      }]);
      hideLoader();
      if(error) handleFailure(error);
      else {
        document.getElementById('addCustomerModal').classList.add('hidden');
        fetchCustomers(true);
      }
    });

    // ì‹ ê·œ ê³„ì•½ ëª¨ë‹¬ ê´€ë ¨
    document.getElementById('openAddContractModalBtn').addEventListener('click', () => {
        if(!currentAssignmentId) return;
        document.getElementById('addContractModal').classList.remove('hidden');
        document.getElementById('isDifferentContractor').checked = false;
        document.getElementById('realContractorForm').classList.add('hidden');
        document.getElementById('realContractorName').value = '';
        document.getElementById('realContractorPhone').value = '';
    });
    document.getElementById('cancelAddContractBtn').addEventListener('click', () => document.getElementById('addContractModal').classList.add('hidden'));

    document.getElementById('isDifferentContractor').addEventListener('change', (e) => {
        const form = document.getElementById('realContractorForm');
        if(e.target.checked) form.classList.remove('hidden');
        else form.classList.add('hidden');
    });

    // ì‹ ê·œ ê³„ì•½ ì €ì¥
    document.getElementById('saveNewContractBtn').addEventListener('click', async () => {
        const date = document.getElementById('modalContractDate').value;
        const car = document.getElementById('modalContractCarModel').value;
        if(!date || !car) return alert('ë‚ ì§œì™€ ì°¨ì¢…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');

        const isProxy = document.getElementById('isDifferentContractor').checked;
        const realName = document.getElementById('realContractorName').value.trim();
        const realPhone = document.getElementById('realContractorPhone').value.trim().replace(/\D/g, "");
        const relation = document.getElementById('contractorRelation').value;

        if(isProxy && (!realName || !realPhone)) return alert('ì‹¤ê³„ì•½ì ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

        showLoader();
        try {
            let targetAssignmentId = currentAssignmentId;
            let actualContractorId = currentAssignmentId;
            let consultantId = currentAssignmentId;
            let relationshipVal = 'ë³¸ì¸';

            if (isProxy) {
                relationshipVal = relation;
                
                // ë©”ëª¨ ë¬¸êµ¬ ìƒì„± (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
                let memoSuffix = "ì†Œê°œê±´"; 
                if (relation !== 'ì§€ì¸/ì†Œê°œ') {
                    memoSuffix = "íƒ€ì¸ëª…ì˜ ì§„í–‰ê±´"; 
                }
                const autoMemo = `[ìë™ìƒì„±] ${document.getElementById('detailCustomerNameText').textContent}ë‹˜ì˜ ${memoSuffix}`;

                // ì‹¤ê³„ì•½ì ì¡´ì¬ ì—¬ë¶€ í™•ì¸
                const { data: existUser } = await supabase.from('customers').select('assignment_id').eq('customer_phone', realPhone).maybeSingle();
                
                if (existUser) {
                    // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê³ ê°ì´ë©´ IDë§Œ ê°€ì ¸ë‹¤ ì”€
                    // (ì„ íƒ ì‚¬í•­: ê¸°ì¡´ ê³ ê°ì´ë¼ë„ ì´ë²ˆì— ê³„ì•½í–ˆìœ¼ë‹ˆ ì‹œê°„ì„ ê°±ì‹ í•´ì£¼ê³  ì‹¶ë‹¤ë©´ updateë¥¼ ì—¬ê¸°ì„œ ì¹  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤)
                    targetAssignmentId = existUser.assignment_id;
                    actualContractorId = existUser.assignment_id;
                    
                    // â˜… (ì¶”ê°€ ì¶”ì²œ) ê¸°ì¡´ ê³ ê°ì´ë¼ë„ 'ìµœê·¼ í™œë™'ì„ ê°±ì‹ í•´ì£¼ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
                    await supabase.from('customers').update({
                        last_log_date: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }).eq('assignment_id', existUser.assignment_id);

                } else {
                    // [ì‹ ê·œ ìƒì„±] ì´ ë¶€ë¶„ì´ í•µì‹¬ì…ë‹ˆë‹¤.
                    const ts = Date.now();
                    const newId = "A_" + ts;
                    const nowISO = new Date().toISOString(); // í˜„ì¬ ì‹œê°„ ìƒì„±

                    await supabase.from('customers').insert([{
                        assignment_id: newId,
                        customer_id: "C_" + ts,
                        customer_name: realName,
                        customer_phone: realPhone,
                        assigned_to: currentUserName,
                        owner_email: currentUserEmail,
                        customer_status: 'ê³„ì•½ ì™„ë£Œ',     // ìƒíƒœë„ 'ê³„ì•½ ì™„ë£Œ'ë¡œ ì‹œì‘
                        lead_source: relationshipVal,
                        customer_memo: autoMemo,
                        
                        // â˜… [í•µì‹¬ ìˆ˜ì •] ìƒì„±ê³¼ ë™ì‹œì— 'ë§ˆì§€ë§‰ ìƒë‹´ì¼'ì„ í˜„ì¬ë¡œ ì±„ì›Œì¤ë‹ˆë‹¤.
                        // ê³„ì•½ ìƒì„± ìì²´ê°€ ê°€ì¥ ê°•ë ¥í•œ 'ìƒë‹´/ì˜ì—… í™œë™'ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
                        last_log_date: nowISO,
                        updated_at: nowISO
                    }]);
                    targetAssignmentId = newId;
                    actualContractorId = newId;
                }
            }

            const { error } = await supabase.from('contracts').insert([{
                contract_id: "CN_" + Date.now(),
                assignment_id: targetAssignmentId,
                contract_date: date,
                contract_car_model: car,
                contract_amount: document.getElementById('modalContractAmount').value || 0,
                contract_term: document.getElementById('modalContractTerm').value,
                contract_summary: document.getElementById('modalContractSummary').value,
                contract_status: 'ì§„í–‰ì¤‘',
                actual_contractor_id: actualContractorId,
                consultant_id: consultantId,
                relationship: relationshipVal
            }]);

            if(error) throw error;

            hideLoader();
            document.getElementById('addContractModal').classList.add('hidden');
            selectCustomer(currentAssignmentId); 
            alert("ê³„ì•½ ì €ì¥ ì™„ë£Œ");

        } catch(e) {
            handleFailure(e);
        }
    });
    
    document.getElementById('newCustomerPhoneNumber').addEventListener('blur', (e) => {
      e.target.value = formatPhoneNumber_Client(e.target.value);
    });

    // â˜… [ì¶”ê°€] ê³„ì•½ ìƒì„¸ -> í•´ë‹¹ ê³ ê° ìƒì„¸ (ë‹¨ì¼ ë²„íŠ¼)
    const goToCustBtn = document.getElementById('goToCustomerDetailBtn');
    if (goToCustBtn) {
        goToCustBtn.addEventListener('click', () => {
             if (currentViewingContract && currentViewingContract.assignment_id) {
                 window.customerDetailSource = 'contractDetailPanel';
                 selectCustomer(currentViewingContract.assignment_id);
             } else {
                 alert("ì´ ê³„ì•½ì— ì—°ê²°ëœ ê³ ê° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
             }
        });
    }

    // â˜… [ì‹ ê·œ] ì‹¤ê³„ì•½ì ì •ë³´ ë³´ëŸ¬ê°€ê¸°
    const goToContractorBtn = document.getElementById('goToContractorBtn');
    if(goToContractorBtn) {
        goToContractorBtn.addEventListener('click', () => {
            if (currentViewingContract && currentViewingContract.assignment_id) {
                window.customerDetailSource = 'contractDetailPanel';
                selectCustomer(currentViewingContract.assignment_id);
            } else {
                alert("ì—°ê²°ëœ ì‹¤ê³„ì•½ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            }
        });
    }

    // â˜… [ì‹ ê·œ] ìƒë‹´ ê³ ê° ì •ë³´ ë³´ëŸ¬ê°€ê¸°
    const goToConsultantBtn = document.getElementById('goToConsultantBtn');
    if(goToConsultantBtn) {
        goToConsultantBtn.addEventListener('click', () => {
            if (currentViewingContract && currentViewingContract.consultant_id) {
                window.customerDetailSource = 'contractDetailPanel';
                selectCustomer(currentViewingContract.consultant_id);
            } else {
                alert("ì—°ê²°ëœ ìƒë‹´ ê³ ê° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            }
        });
    }

    // ì •ë ¬ ì²˜ë¦¬ í—¬í¼ í•¨ìˆ˜
    const handleSort = (column, iconId) => {
    // 1. ê°™ì€ ì»¬ëŸ¼ì„ ë˜ í´ë¦­í–ˆìœ¼ë©´ ì •ë ¬ ìˆœì„œ ë°˜ì „, ì•„ë‹ˆë©´ ë‚´ë¦¼ì°¨ìˆœ(ìµœì‹ ìˆœ)ìœ¼ë¡œ ì´ˆê¸°í™”
    if (currentSortColumn === column) {
        currentSortAscending = !currentSortAscending;
    } else {
        currentSortColumn = column;
        currentSortAscending = false; // ìƒˆ í•­ëª© í´ë¦­ ì‹œ ë³´í†µ ìµœì‹ ìˆœ(ë‚´ë¦¼ì°¨ìˆœ)ë¶€í„° ë³´ì—¬ì¤Œ
    }

    // 2. ì•„ì´ì½˜ ì—…ë°ì´íŠ¸ (ì‹œê°ì  í”¼ë“œë°±)
    document.getElementById('sortIconLastLog').textContent = '';
    document.getElementById('sortIconAssignmentDate').textContent = '';
    
    const iconChar = currentSortAscending ? 'â–²' : 'â–¼';
    document.getElementById(iconId).textContent = iconChar;

    // 3. ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸° (ì²« í˜ì´ì§€ë¶€í„°)
    fetchCustomers(true);
    };

    // 'ìµœê·¼ìƒë‹´' í—¤ë” í´ë¦­ ì´ë²¤íŠ¸
    const btnLastLog = document.getElementById('sortLastLogBtn');
    if (btnLastLog) {
        btnLastLog.addEventListener('click', () => {
            // DB ì»¬ëŸ¼ëª…: last_log_date
            handleSort('last_log_date', 'sortIconLastLog');
        });
    }

    // 'ë°°ì •ì¼' í—¤ë” í´ë¦­ ì´ë²¤íŠ¸
    const btnAssignDate = document.getElementById('sortAssignmentDateBtn');
    if (btnAssignDate) {
        btnAssignDate.addEventListener('click', () => {
            // DB ì»¬ëŸ¼ëª…: assignment_date
            handleSort('assignment_date', 'sortIconAssignmentDate');
        });
    }

  }


function onAnalysisSuccess(response) {
  hideLoader();

  if (!response.success) {
    alert("âŒ ë¶„ì„ ì‹¤íŒ¨:\n" + response.error);
    return;
  }

  let data = response.data;
  // ë°ì´í„°ê°€ ë°°ì—´([])ë¡œ ì˜¤ë©´ ì²« ë²ˆì§¸ ê²ƒì„ êº¼ë‚´ëŠ” ì•ˆì „ì¥ì¹˜
  if (Array.isArray(data)) {
      console.log("ë°°ì—´ ë°ì´í„° ê°ì§€ë¨, ì²« ë²ˆì§¸ í•­ëª© ì¶”ì¶œ");
      data = data[0];
  }
  
  // ë°ì´í„°ê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
  if (!data || Object.keys(data).length === 0) {
      alert("âš ï¸ ë¶„ì„ì€ ì„±ê³µí–ˆìœ¼ë‚˜ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
      return;
  }

  console.log("ìµœì¢… ì²˜ë¦¬ ë°ì´í„°:", data); // ë””ë²„ê¹…ìš© ë¡œê·¸
  
  const fileUrl = "ì—…ë¡œë“œ ë° ë¶„ì„ ì™„ë£Œ"; 

  alert("âœ… ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\në‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");

  // [JavaScript.html] ë‚´ë¶€ smartFill í•¨ìˆ˜ ìˆ˜ì •

  const smartFill = (id, newVal) => {
    const el = document.getElementById(id);
    if (!el) return;
    
    // ê°’ì´ ì—†ê±°ë‚˜ ê³µë°±ì´ë©´ íŒ¨ìŠ¤
    if (newVal === undefined || newVal === null || String(newVal).trim() === "") return;

    const currentVal = el.value.trim();
    
    // ì´ë¯¸ ê°’ì´ ì±„ì›Œì ¸ ìˆìœ¼ë©´ ê±´ë„ˆë›°ê¸°
    const isPlaceholder = currentVal === '' || 
                          currentVal.includes('í™•ì¸') || 
                          currentVal.includes('ë¯¸ì •') || 
                          currentVal.includes('ì¶”ì •');
    
    if (!isPlaceholder) return; 

    // â˜… [í•µì‹¬ ìˆ˜ì • 1] AIê°€ ì¤€ ê°’ì„ 'NFC(ì™„ì„±í˜•)'ë¡œ í†µì¼í•˜ê³  ê³µë°± ì œê±°
    const normalizeStr = (str) => String(str).normalize("NFC").replace(/\s+/g, '').toLowerCase();
    const cleanNewVal = normalizeStr(newVal);

    // 1. SELECT íƒœê·¸ (ë“œë¡­ë°•ìŠ¤) ì²˜ë¦¬
    if (el.tagName.toUpperCase() === 'SELECT') {
        let bestMatch = "";
        
        for (let i = 0; i < el.options.length; i++) {
            const optVal = el.options[i].value;
            const optText = el.options[i].text;
            
            // â˜… [í•µì‹¬ ìˆ˜ì • 2] ë¹„êµ ëŒ€ìƒë„ 'NFC'ë¡œ í†µì¼
            const cleanOptVal = normalizeStr(optVal);
            const cleanOptText = normalizeStr(optText);

            // ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜ í¬í•¨ ê´€ê³„ë©´ ì„ íƒ
            if (cleanOptVal === cleanNewVal || 
                cleanOptText === cleanNewVal ||
                (cleanOptVal.length > 0 && cleanNewVal.includes(cleanOptVal)) || 
                (cleanOptText.length > 0 && cleanNewVal.includes(cleanOptText))) {
                
                bestMatch = optVal;
                break; // ì°¾ì•˜ìœ¼ë©´ ë£¨í”„ ì¢…ë£Œ
            }
        }
        
        if (bestMatch) {
            el.value = bestMatch; // ê¸°ì¡´ ì˜µì…˜ ì„ íƒ (Clean Data)
        } else {
            // ì •ê·œí™”ë¥¼ í–ˆëŠ”ë°ë„ ë„ì €íˆ ëª» ì°¾ì€ ê²½ìš°ì—ë§Œ ê°•ì œ ì£¼ì… (ìµœí›„ì˜ ìˆ˜ë‹¨)
            console.warn(`[ë§¤ì¹­ ì‹¤íŒ¨] ì •ê·œí™” í›„ì—ë„ ë¶ˆì¼ì¹˜: ${cleanNewVal}`);
            
            // (ì„ íƒ ì‚¬í•­) ê°•ì œ ì£¼ì…ì„ ë§‰ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ else ë¸”ë¡ì„ ì§€ìš°ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬í•˜ì„¸ìš”.
            // í•˜ì§€ë§Œ 'ì…€í† ìŠ¤' ì²˜ëŸ¼ DBì— ì—†ëŠ” ì°¨ì¢…ì´ ë‚˜ì˜¬ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ìœ ì§€í•˜ëŠ” ê²Œ ë‚«ìŠµë‹ˆë‹¤.
            let optExists = false;
            for(let j=0; j<el.options.length; j++) {
                if(el.options[j].value == newVal) { optExists = true; break; }
            }
            
            if (!optExists) {
                const newOpt = document.createElement('option');
                newOpt.value = newVal;
                newOpt.text = newVal; 
                newOpt.style.color = "blue"; 
                el.add(newOpt);
            }
            el.value = newVal;
        }
        highlight(el);

    } else {
        // INPUT, TEXTAREA ë“±
        el.value = newVal;
        highlight(el);
    }
  };

  // ì‹œê°ì  íš¨ê³¼ (ì´ˆë¡ìƒ‰ ê¹œë¹¡ì„)
  const highlight = (el) => {
      el.style.backgroundColor = "#d1e7dd"; 
      setTimeout(() => el.style.backgroundColor = "", 3000);
  };

  // -------------------------------------------------------
  // [ë°ì´í„° ë§¤í•‘ ì‹¤í–‰] 
  // -------------------------------------------------------
  smartFill('customerType', data.customer_type);
  smartFill('gender', data.gender);
  smartFill('ageGroup', data.age_group);
  smartFill('addressCity', data.address_city);
  smartFill('incomeType', data.income_type);
  smartFill('creditInfo', data.credit_info);
  smartFill('occupation', data.occupation);
  
  smartFill('interestedCarModel', data.interested_car_model);
  smartFill('comparisonCarModel', data.comparison_car_model);
  smartFill('ownedCarModel', data.owned_car_model);
  smartFill('carUsage', data.car_usage);
  smartFill('drivingDistance', data.driving_distance);
  smartFill('driverScope', data.driver_scope);
  smartFill('expectedContractTiming', data.expected_contract_timing);
  smartFill('desiredContractTerm', data.desired_contract_term);
  smartFill('desiredInitialCostType', data.desired_initial_cost_type);
  smartFill('maintenanceServiceLevel', data.maintenance_service_level);

  // ì „í™”ë²ˆí˜¸ í¬ë§·íŒ…
  if (data.customer_phone) {
      const formatted = typeof formatPhoneNumber_Client === 'function' 
                        ? formatPhoneNumber_Client(data.customer_phone) 
                        : data.customer_phone;
      smartFill('detailCustomerPhoneNumber', formatted);
  }

  // ê³ ê° ë©”ëª¨
  const memoEl = document.getElementById('customerMemo');
  if (memoEl && data.summary) {
    const currentMemo = memoEl.value;
    if (!currentMemo.includes(data.summary)) {
        const prefix = currentMemo ? " | " : "";
        memoEl.value += prefix + "[AIìš”ì•½] " + data.summary;
        highlight(memoEl);
    }
  }

  // ìƒë‹´ ë¡œê·¸
  const logEl = document.getElementById('newLogContent');
  if (logEl && data.summary) {
    logEl.value = `[ğŸ™ï¸ ë…¹ìŒ ë¶„ì„ ê²°ê³¼]\n\nğŸ“„ í•µì‹¬ìš”ì•½:\n${data.summary}\n\nğŸ“ ìƒì„¸ë‚´ìš©:\n${data.details || '(ë‚´ìš© ì—†ìŒ)'}`;
    highlight(logEl);
    
    const addLogBtn = document.getElementById('addLogBtn');
    if(addLogBtn) addLogBtn.focus();
  }
}

// [ì‹ ê·œ ê¸°ëŠ¥] ë¡œê·¸ ì‚­ì œ í•¨ìˆ˜
async function deleteLog(logId) {
    if (!confirm("ì •ë§ ì´ ìƒë‹´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    showLoader();
    const { error } = await supabase
        .from('consultation_logs')
        .delete()
        .eq('log_id', logId);
    
    hideLoader();

    if (error) {
        alert("ì‚­ì œ ì‹¤íŒ¨: " + error.message);
    } else {
        // í™”ë©´ ê°±ì‹  (í˜„ì¬ ë³´ê³  ìˆëŠ” ê³ ê° ìƒì„¸ ë‹¤ì‹œ ë¡œë“œ)
        if(currentAssignmentId) selectCustomer(currentAssignmentId);
    }
}

// [ì‹ ê·œ ê¸°ëŠ¥] ë¡œê·¸ ìˆ˜ì • í•¨ìˆ˜
async function editLog(logId, btnElement) {
    // 1. í˜„ì¬ ë‚´ìš©ì„ ê°€ì ¸ì˜´
    const contentDiv = document.getElementById(`content-${logId}`);
    const currentContent = contentDiv.textContent;

    // 2. ê°„ë‹¨í•˜ê²Œ prompt ì°½ìœ¼ë¡œ ìˆ˜ì • ì…ë ¥ ë°›ê¸° (UIë¥¼ ë” ì˜ˆì˜ê²Œ í•˜ë ¤ë©´ ëª¨ë‹¬ ì‚¬ìš©)
    //    ì¤„ë°”ê¿ˆì´ ë§ì€ ê¸´ ê¸€ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ textareaê°€ ë‚«ì§€ë§Œ, ë¹ ë¥¸ êµ¬í˜„ì„ ìœ„í•´ prompt ì‚¬ìš© ì˜ˆì‹œì…ë‹ˆë‹¤.
    //    (ê¸´ ê¸€ ìˆ˜ì •ì´ ë¶ˆí¸í•˜ë‹¤ë©´ ë³„ë„ ëª¨ë‹¬ UIê°€ í•„ìš”í•©ë‹ˆë‹¤.)
    
    // 2-1. [ê°œì„ ] Prompt ëŒ€ì‹  ê·¸ ìë¦¬ë¥¼ textareaë¡œ ë°”ê¿”ì¹˜ê¸° (ì¸ë¼ì¸ ìˆ˜ì •)
    const card = btnElement.closest('.log-entry-card');
    const actionsDiv = btnElement.closest('.log-actions');
    
    // ì´ë¯¸ ìˆ˜ì • ëª¨ë“œë¼ë©´ ì¤‘ë‹¨
    if (card.querySelector('textarea')) return;

    // ê¸°ì¡´ ë·° ìˆ¨ê¸°ê³  ì—ë””í„° í‘œì‹œ
    contentDiv.style.display = 'none';
    actionsDiv.style.display = 'none';

    const editorDiv = document.createElement('div');
    editorDiv.innerHTML = `
        <textarea style="width:100%; height:100px; margin:5px 0;">${currentContent}</textarea>
        <div style="text-align:right; gap:5px; display:flex; justify-content:flex-end;">
            <button id="save-${logId}" style="padding:4px 10px; font-size:0.8rem;">ì €ì¥</button>
            <button id="cancel-${logId}" class="secondary" style="padding:4px 10px; font-size:0.8rem;">ì·¨ì†Œ</button>
        </div>
    `;
    card.appendChild(editorDiv);

    // ì €ì¥ ë²„íŠ¼ í´ë¦­
    document.getElementById(`save-${logId}`).onclick = async () => {
        const newText = editorDiv.querySelector('textarea').value;
        if (!newText.trim()) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

        showLoader();
        const { error } = await supabase
            .from('consultation_logs')
            .update({ log_content: newText, updated_at: new Date().toISOString() }) // updated_at ì»¬ëŸ¼ì´ ìˆë‹¤ë©´ ì—…ë°ì´íŠ¸
            .eq('log_id', logId);
        hideLoader();

        if (error) {
            alert("ìˆ˜ì • ì‹¤íŒ¨: " + error.message);
        } else {
            // ì„±ê³µ ì‹œ ëª©ë¡ ê°±ì‹ 
            if(currentAssignmentId) selectCustomer(currentAssignmentId);
        }
    };

    // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­
    document.getElementById(`cancel-${logId}`).onclick = () => {
        editorDiv.remove();
        contentDiv.style.display = 'block';
        actionsDiv.style.display = 'flex';
    };
}

// [ì‹ ê·œ ê¸°ëŠ¥] ë¡œê·¸ ìˆ˜ì • í•¨ìˆ˜ (ì—ëŸ¬ ìˆ˜ì •ë¨)
async function editLog(logId, btnElement) {
    // 1. í˜„ì¬ ë‚´ìš©ì„ ê°€ì ¸ì˜´
    const contentDiv = document.getElementById(`content-${logId}`);
    const currentContent = contentDiv.textContent;

    const card = btnElement.closest('.log-entry-card');
    const actionsDiv = btnElement.closest('.log-actions');
    
    // ì´ë¯¸ ìˆ˜ì • ëª¨ë“œë¼ë©´ ì¤‘ë‹¨
    if (card.querySelector('textarea')) return;

    // ê¸°ì¡´ ë·° ìˆ¨ê¸°ê³  ì—ë””í„° í‘œì‹œ
    contentDiv.style.display = 'none';
    actionsDiv.style.display = 'none';

    const editorDiv = document.createElement('div');
    editorDiv.innerHTML = `
        <textarea style="width:100%; height:100px; margin:5px 0; border:1px solid #ccc; padding:5px;">${currentContent}</textarea>
        <div style="text-align:right; gap:5px; display:flex; justify-content:flex-end;">
            <button id="save-${logId}" style="padding:4px 10px; font-size:0.8rem;">ì €ì¥</button>
            <button id="cancel-${logId}" class="secondary" style="padding:4px 10px; font-size:0.8rem;">ì·¨ì†Œ</button>
        </div>
    `;
    card.appendChild(editorDiv);

    // ì €ì¥ ë²„íŠ¼ í´ë¦­
    document.getElementById(`save-${logId}`).onclick = async () => {
        const newText = editorDiv.querySelector('textarea').value;
        if (!newText.trim()) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

        showLoader();
        
        // â˜… [ìˆ˜ì •ë¨] updated_at ì œê±° (í…Œì´ë¸”ì— ì—†ìœ¼ë¯€ë¡œ ë‚´ìš©ë§Œ ìˆ˜ì •)
        const { error } = await supabase
            .from('consultation_logs')
            .update({ log_content: newText }) 
            .eq('log_id', logId);
            
        hideLoader();

        if (error) {
            alert("ìˆ˜ì • ì‹¤íŒ¨: " + error.message);
        } else {
            // ì„±ê³µ ì‹œ ëª©ë¡ ê°±ì‹ 
            if(currentAssignmentId) selectCustomer(currentAssignmentId);
        }
    };

    // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­
    document.getElementById(`cancel-${logId}`).onclick = () => {
        editorDiv.remove();
        contentDiv.style.display = 'block';
        actionsDiv.style.display = 'flex';
    };
}
