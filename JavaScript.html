
  // ============================================================================
  // [1] Supabase ì„¤ì • ë° ì‚¬ìš©ì ì •ë³´
  // ============================================================================
  // ğŸš¨ ëŒ€ì‹œë³´ë“œ > Project Settings > API ì—ì„œ ë³µì‚¬í•œ ê°’ì„ ì•„ë˜ì— ë„£ì–´ì£¼ì„¸ìš”.
  const SUPABASE_URL = 'https://chooqydalmudfaprrevg.supabase.co'; 
  const SUPABASE_KEY = 'sb_publishable_Sdl561keRe4k7fXKU64QNA_PjWxf60I'; 
  
  // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // [ì„ì‹œ ì‚¬ìš©ì ì„¤ì •] ë¡œê·¸ì¸ ê¸°ëŠ¥ êµ¬í˜„ ì „ê¹Œì§€ ì‚¬ìš©í•  ì‚¬ìš©ì ì •ë³´
  // [ê¸°ì¡´]
// const CURRENT_USER_NAME = "í…ŒìŠ¤íŠ¸ì˜ì—…ì";

// [ë³€ê²½] ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ë¥¼ ë‹´ì„ ë³€ìˆ˜ ì¤€ë¹„
let session = null; 
let currentUserEmail = null;

  // ============================================================================
  // [2] ì„¤ì • ë°ì´í„° (ê¸°ì¡´ Code.gsì—ì„œ ê°€ì ¸ì˜¤ë˜ ìƒìˆ˜ê°’ë“¤)
  // ============================================================================
  const CONFIG = {
    dbTypes: ['í™ˆí˜ì´ì§€ë¬¸ì˜', 'ì§€ì¸ì†Œê°œ', 'ë¸”ë¡œê·¸', 'ê¸°íƒ€'], 
    selectOptions: {
      leadSource: ['í™ˆí˜ì´ì§€', 'ë„¤ì´ë²„ê²€ìƒ‰', 'ë‹¤ìŒê²€ìƒ‰', 'êµ¬ê¸€ê²€ìƒ‰', 'SNS ê´‘ê³ ', 'ìœ íŠœë¸Œ ê´‘ê³ ', 'ì†Œê°œ', 'ê¸°ì¡´ê³ ê° ì¬ë ŒíŠ¸', 'íŒŒíŠ¸ë„ˆì‚¬ ì „ë‹¬', 'ì˜¤í”„ë¼ì¸ ê´‘ê³ ', 'ê¸°íƒ€'],
      ageGroup: ['20ëŒ€(ë§Œ21~25)', '20ëŒ€(ë§Œ26~)', '30ëŒ€', '40ëŒ€', '50ëŒ€', '60ëŒ€ ì´ìƒ', 'ë¯¸í™•ì¸'],
      incomeType: ['4ëŒ€ë³´í—˜ ì§ì¥ì¸', '4ëŒ€ë³´í—˜ ì œì™¸ ì§ì¥ì¸', 'ì „ë¬¸ì§', 'í”„ë¦¬ëœì„œ', 'ì¼ìš©ì§', 'ë¬´ì§/í•™ìƒ', 'ë¯¸í™•ì¸'],
      creditInfo: ['1~3 ë“±ê¸‰(ìƒ)', '4~6 ë“±ê¸‰(ì¤‘)', '7~9 ë“±ê¸‰(í•˜)', 'ì‹¬ì‚¬ ë¶ˆê°€', 'ì‹¬ì‚¬ ì „', 'ë¯¸í™•ì¸'],
      carUsage: ['ì¶œí‡´ê·¼ìš©', 'ì—…ë¬´ìš©(ì˜ì—…/ì¶œì¥)', 'ë ˆì €/íŒ¨ë°€ë¦¬ìš©', 'ë²•ì¸ ì„ì›ìš©', 'ê°œì¸ ì‚¬ì—…ì¥ ìš´ì˜', 'ê¸°íƒ€', 'ë¯¸í™•ì¸'],
      drivingDistance: ['1ë§Œkm', '1.5ë§Œkm', '2ë§Œkm', '2.5ë§Œkm', '3ë§Œkm', '3.5ë§Œkm', '4ë§Œkm', '4.5ë§Œkm', '5ë§Œkm', '5ë§Œkm ì´ìƒ', 'ë¯¸ì •'],
      expectedContractTiming: ['ì¦‰ì‹œ(1ê°œì›” ë‚´)', '3ê°œì›” ë‚´', '6ê°œì›” ë‚´', 'ë¯¸ì •'],
      desiredContractTerm: ['12ê°œì›”', '24ê°œì›”', '36ê°œì›”', '48ê°œì›”', '60ê°œì›”','ë¯¸ì •'],
      desiredInitialCostType: ['ë¬´ë³´ì¦', 'ë³´ì¦ê¸ˆ', 'ì„ ë‚©ê¸ˆ', 'ë³´ì¦ì¦ê¶Œ', 'ë¯¸ì •'],
      maintenanceServiceLevel: ['ë¯¸í¬í•¨(Self)', 'í¬í•¨(ê¸°ë³¸)', 'í¬í•¨(ê³ ê¸‰)', 'ë¯¸ì •'],
      customerStatus: ['ë°°ì •ë¨', 'ì—°ë½ ì‹œë„ ì¤‘', 'ìƒë‹´ ì§„í–‰ ì¤‘', 'ê²¬ì  ë°œì†¡', 'ì¶”ê°€ ì •ë³´ ìš”ì²­', 'ê°€ë§ ê³ ê°', 'ì‹¬ì‚¬ ì§„í–‰ì¤‘', 'ì‹¬ì‚¬ ì™„ë£Œ', 'ê³„ì•½ ì§„í–‰ì¤‘', 'ê³„ì•½ ì™„ë£Œ', 'ì¶œê³  ì™„ë£Œ', 'ê¸°ì¡´ ê³ ê°', 'ìƒë‹´ ë³´ë¥˜', 'ìƒë‹´ ì´íƒˆ'],
      // ì‹œ/ë„ ëª©ë¡
      addressCities: ['ì„œìš¸íŠ¹ë³„ì‹œ', 'ë¶€ì‚°ê´‘ì—­ì‹œ', 'ëŒ€êµ¬ê´‘ì—­ì‹œ', 'ì¸ì²œê´‘ì—­ì‹œ', 'ê´‘ì£¼ê´‘ì—­ì‹œ', 'ëŒ€ì „ê´‘ì—­ì‹œ', 'ìš¸ì‚°ê´‘ì—­ì‹œ', 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ', 'ê²½ê¸°ë„', 'ê°•ì›íŠ¹ë³„ìì¹˜ë„', 'ì¶©ì²­ë¶ë„', 'ì¶©ì²­ë‚¨ë„', 'ì „ë¶íŠ¹ë³„ìì¹˜ë„', 'ì „ë¼ë‚¨ë„', 'ê²½ìƒë¶ë„', 'ê²½ìƒë‚¨ë„', 'ì œì£¼íŠ¹ë³„ìì¹˜ë„']
    }
  };

  // ì‹œ/êµ°/êµ¬ ë°ì´í„° ë§¤í•‘ (ì„œë²„ ì—†ì´ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì²˜ë¦¬)
  const DISTRICTS_MAP = {
    'ì„œìš¸íŠ¹ë³„ì‹œ': ['ê°•ë‚¨êµ¬', 'ê°•ë™êµ¬', 'ê°•ë¶êµ¬', 'ê°•ì„œêµ¬', 'ê´€ì•…êµ¬', 'ê´‘ì§„êµ¬', 'êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬', 'ë…¸ì›êµ¬', 'ë„ë´‰êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ë™ì‘êµ¬', 'ë§ˆí¬êµ¬', 'ì„œëŒ€ë¬¸êµ¬', 'ì„œì´ˆêµ¬', 'ì„±ë™êµ¬', 'ì„±ë¶êµ¬', 'ì†¡íŒŒêµ¬', 'ì–‘ì²œêµ¬', 'ì˜ë“±í¬êµ¬', 'ìš©ì‚°êµ¬', 'ì€í‰êµ¬', 'ì¢…ë¡œêµ¬', 'ì¤‘êµ¬', 'ì¤‘ë‘êµ¬'],
    'ê²½ê¸°ë„': ['ìˆ˜ì›ì‹œ', 'ì„±ë‚¨ì‹œ', 'ì˜ì •ë¶€ì‹œ', 'ì•ˆì–‘ì‹œ', 'ë¶€ì²œì‹œ', 'ê´‘ëª…ì‹œ', 'í‰íƒì‹œ', 'ë™ë‘ì²œì‹œ', 'ì•ˆì‚°ì‹œ', 'ê³ ì–‘ì‹œ', 'ê³¼ì²œì‹œ', 'êµ¬ë¦¬ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ', 'ì˜¤ì‚°ì‹œ', 'ì‹œí¥ì‹œ', 'êµ°í¬ì‹œ', 'ì˜ì™•ì‹œ', 'í•˜ë‚¨ì‹œ', 'ìš©ì¸ì‹œ', 'íŒŒì£¼ì‹œ', 'ì´ì²œì‹œ', 'ì•ˆì„±ì‹œ', 'ê¹€í¬ì‹œ', 'í™”ì„±ì‹œ', 'ê´‘ì£¼ì‹œ', 'ì–‘ì£¼ì‹œ', 'í¬ì²œì‹œ', 'ì—¬ì£¼ì‹œ', 'ì—°ì²œêµ°', 'ê°€í‰êµ°', 'ì–‘í‰êµ°'],
    'ë¶€ì‚°ê´‘ì—­ì‹œ': ['ì¤‘êµ¬', 'ì„œêµ¬', 'ë™êµ¬', 'ì˜ë„êµ¬', 'ë¶€ì‚°ì§„êµ¬', 'ë™ë˜êµ¬', 'ë‚¨êµ¬', 'ë¶êµ¬', 'í•´ìš´ëŒ€êµ¬', 'ì‚¬í•˜êµ¬', 'ê¸ˆì •êµ¬', 'ê°•ì„œêµ¬', 'ì—°ì œêµ¬', 'ìˆ˜ì˜êµ¬', 'ì‚¬ìƒêµ¬', 'ê¸°ì¥êµ°']
    // (í•„ìš”ì‹œ ë‹¤ë¥¸ ì§€ì—­ ë°ì´í„° ì¶”ê°€)
  };

  // ============================================================================
  // [3] ì „ì—­ ë³€ìˆ˜ ë° UI ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
  // ============================================================================
  const loader = document.getElementById('loader');
  let currentAssignmentId = null; 
  const PAGE_SIZE = 30;
  let currentFilters = {};
  let currentOffset = 0;
  let totalCustomerCount = 0;

  // ì´ˆê¸°í™” ì‹œ ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬
async function checkSession() {
  const { data } = await supabase.auth.getSession();
  session = data.session;

  if (session) {
    currentUserEmail = session.user.email;
    console.log("ë¡œê·¸ì¸ ë¨:", currentUserEmail);
    // ë¡œê·¸ì¸ ë˜ì—ˆìœ¼ë‹ˆ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    fetchCustomers(true); 
  } else {
    console.log("ë¡œê·¸ì¸ ì•ˆ ë¨");
    // ë¡œê·¸ì¸ ë²„íŠ¼ ë³´ì—¬ì£¼ê¸° ë“±ì˜ UI ì²˜ë¦¬
    showLoginModal(); 
  }
}

// êµ¬ê¸€ ë¡œê·¸ì¸ í•¨ìˆ˜
async function signInWithGoogle() {
  const { data, error } = await supabase.auth.signInWithOAuth({
    provider: 'google',
  });
}

// ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
async function signOut() {
  const { error } = await supabase.auth.signOut();
  window.location.reload(); // ìƒˆë¡œê³ ì¹¨
}

  // ë¡œë”© í™”ë©´ ì œì–´
  function showLoader() { 
    loader.classList.remove('hidden'); 
    document.querySelectorAll('button, input, select, textarea').forEach(el => {
      if (el.closest('.modal-content') || el.closest('.error-modal-content')) return; 
      el.disabled = true;
    });
  }

  function hideLoader() { 
    loader.classList.add('hidden'); 
    document.querySelectorAll('button, input, select, textarea').forEach(el => {
      el.disabled = false;
    });
  }

  // HTML ì´ìŠ¤ì¼€ì´í”„ (ë³´ì•ˆ)
  function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    const str = String(text);
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // ì „í™”ë²ˆí˜¸ í¬ë§·íŒ…
  function formatPhoneNumber_Client(phone) {
    if (!phone) return "";
    const digits = phone.replace(/\D/g, "");
    if (digits.length === 11) return `${digits.substring(0, 3)}-${digits.substring(3, 7)}-${digits.substring(7)}`;
    if (digits.length === 10) return `${digits.substring(0, 3)}-${digits.substring(3, 6)}-${digits.substring(6)}`;
    return phone;
  }

  // ì—ëŸ¬ ëª¨ë‹¬ í‘œì‹œ
  function showErrorModal(message, actions) {
    const existingErrorModal = document.querySelector('.error-modal-overlay');
    if (existingErrorModal) existingErrorModal.remove();

    const modal = document.createElement('div');
    modal.className = 'modal-overlay error-modal-overlay';
    modal.style.zIndex = '100003';

    const contentDiv = document.createElement('div');
    contentDiv.className = 'error-modal-content';
    contentDiv.innerHTML = `<h3>âš ï¸ ì•Œë¦¼</h3>`;
    
    const messageP = document.createElement('p');
    messageP.textContent = message; 
    messageP.style.margin = '20px 0';
    messageP.style.fontSize = '1.1rem';
    contentDiv.appendChild(messageP);

    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'modal-actions';
    actionsDiv.style.justifyContent = 'flex-end';
    actionsDiv.style.gap = '10px'; 

    if (!actions || actions.length === 0) {
      const okButton = document.createElement('button');
      okButton.className = 'error-modal-btn'; 
      okButton.textContent = 'í™•ì¸';
      okButton.onclick = () => modal.remove();
      actionsDiv.appendChild(okButton);
    } else {
      actions.forEach(action => {
        const button = document.createElement('button');
        button.textContent = action.text;
        button.className = action.isPrimary ? 'error-modal-btn' : 'secondary';
        button.onclick = () => {
          if (action.action) action.action(); 
          modal.remove(); 
        };
        actionsDiv.appendChild(button);
      });
    }
    contentDiv.appendChild(actionsDiv);
    modal.appendChild(contentDiv);
    document.body.appendChild(modal);
  }

  function handleFailure(error) {
    hideLoader();
    console.error("System Error:", error);
    showErrorModal(`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message || error}`);
  }

  function showSaveFeedback(buttonElement) {
    const originalText = buttonElement.textContent;
    buttonElement.textContent = "âœ… ì €ì¥ ì™„ë£Œ";
    buttonElement.disabled = true;
    setTimeout(() => {
      buttonElement.textContent = originalText;
      buttonElement.disabled = false;
    }, 2000);
  }

  // ============================================================================
  // [4] ë°ì´í„° ë³€í™˜ê¸° (DB SnakeCase <-> UI CamelCase)
  // ============================================================================
  function toUiData(dbData) {
    if (!dbData) return null;
    return {
      assignmentId: dbData.assignment_id,
      customerName: dbData.customer_name,
      customerPhoneNumber: dbData.customer_phone,
      assignedTo: dbData.assigned_to,
      dbType: dbData.db_type,
      assignmentDate: dbData.assignment_date,
      customerStatus: dbData.customer_status,
      leadSource: dbData.lead_source,
      customerType: dbData.customer_type,
      gender: dbData.gender,
      ageGroup: dbData.age_group,
      addressCity: dbData.address_city,
      addressDistrict: dbData.address_district,
      incomeType: dbData.income_type,
      creditInfo: dbData.credit_info,
      interestedCarModel: dbData.interested_car_model,
      comparisonCarModel: dbData.comparison_car_model,
      ownedCarModel: dbData.owned_car_model,
      carUsage: dbData.car_usage,
      driverScope: dbData.driver_scope,
      drivingDistance: dbData.driving_distance,
      expectedContractTiming: dbData.expected_contract_timing,
      desiredContractTerm: dbData.desired_contract_term,
      desiredInitialCostType: dbData.desired_initial_cost_type,
      maintenanceServiceLevel: dbData.maintenance_service_level,
      salesCondition: dbData.sales_condition,
      isRepurchase: dbData.is_repurchase,
      paymentMethod: dbData.payment_method,
      customerMemo: dbData.customer_memo,
      quoteNumber: dbData.quote_number,
      approvalNumber: dbData.approval_number,
      // ì§ì—…(occupation) ì¶”ê°€
      occupation: dbData.occupation
    };
  }

  // ============================================================================
  // [5] UI ë Œë”ë§ í•¨ìˆ˜ë“¤
  // ============================================================================
  function populateSelectOptions(config) {
    const optionsMap = config.selectOptions; 
    const populate = (elementId, optionsArray) => {
      const selectElement = document.getElementById(elementId);
      if (selectElement) {
        const firstOption = selectElement.options[0]; // ì²«ë²ˆì§¸ ì˜µì…˜(placeholder) ìœ ì§€
        selectElement.innerHTML = ''; 
        if (firstOption) selectElement.appendChild(firstOption); 
        
        optionsArray.forEach(optionValue => {
          const option = document.createElement('option');
          option.value = optionValue;
          option.textContent = optionValue;
          selectElement.appendChild(option);
        });
      }
    };

    populate('filterDbType', config.dbTypes || []); 
    populate('newDbType', config.dbTypes || []);
    populate('leadSource', optionsMap.leadSource || []);
    populate('ageGroup', optionsMap.ageGroup || []);
    populate('addressCity', optionsMap.addressCities || []); 
    populate('incomeType', optionsMap.incomeType || []);
    populate('creditInfo', optionsMap.creditInfo || []);
    populate('carUsage', optionsMap.carUsage || []);
    populate('drivingDistance', optionsMap.drivingDistance || []);
    populate('expectedContractTiming', optionsMap.expectedContractTiming || []);
    populate('desiredContractTerm', optionsMap.desiredContractTerm || []);
    populate('desiredInitialCostType', optionsMap.desiredInitialCostType || []);
    populate('maintenanceServiceLevel', optionsMap.maintenanceServiceLevel || []);
    populate('customerStatus', optionsMap.customerStatus || []);
    populate('filterCustomerStatus', optionsMap.customerStatus || []);
  }

  function loadDistricts(selectedCity, valueToSelect) {
    const districtSelect = document.getElementById('addressDistrict');
    // HTMLì— í•´ë‹¹ IDê°€ ì—†ì„ ê²½ìš° ë¬´ì‹œ (ì´ì „ ë²„ì „ í˜¸í™˜)
    if (!districtSelect) return; 

    districtSelect.innerHTML = '<option value="">-- ì„ íƒ --</option>';
    
    if (!selectedCity) {
      districtSelect.disabled = true;
      return;
    }

    const districts = DISTRICTS_MAP[selectedCity] || [];
    
    if (districts.length > 0) {
      districts.forEach(d => {
        const option = document.createElement('option');
        option.value = d;
        option.textContent = d;
        districtSelect.appendChild(option);
      });
      if (valueToSelect) districtSelect.value = valueToSelect;
      districtSelect.disabled = false;
    } else {
      districtSelect.innerHTML = '<option value="">ì •ë³´ ì—†ìŒ</option>';
      districtSelect.disabled = true;
    }
  }

  function getStatusClass(status) {
    if (status === 'ìƒë‹´ ì™„ë£Œ') return 'completed';
    if (status === 'ìƒë‹´ ì§„í–‰ ì¤‘' || status === 'ì—°ë½ ì‹œë„ ì¤‘') return 'consulting';
    return '';
  }

  function buildCustomerLi(customer) {
    const li = document.createElement('li');
    li.tabIndex = 0;
    li.dataset.assignmentId = customer.assignmentId;
    
    const phone = customer.customerPhoneNumber ? formatPhoneNumber_Client(customer.customerPhoneNumber) : 'ë²ˆí˜¸ ì—†ìŒ';
    const dbType = customer.dbType || 'ê¸°íƒ€';
    const statusName = customer.customerStatus || 'ë¯¸ì •';
    const statusClass = getStatusClass(statusName);
    
    const carModel = customer.interestedCarModel || ''; 
    const memo = customer.customerMemo || '...'; 
    let combinedMemo = '...';
    if (carModel && memo !== '...') combinedMemo = `${carModel} | ${memo}`;
    else if (carModel) combinedMemo = carModel;
    else if (memo !== '...') combinedMemo = memo;

    // ìµœê·¼ ìƒë‹´ì¼ (Supabase join êµ¬í˜„ ì „ì´ë¼ ì¼ë‹¨ ìƒëµí•˜ê±°ë‚˜ ì¶”í›„ êµ¬í˜„)
    const lastLogText = ''; 

    li.innerHTML = `
      <span class="li-item dbtype" title="${escapeHtml(dbType)}">${escapeHtml(dbType)}</span>
      <span class="li-item status"><span class="status-badge ${statusClass}">${escapeHtml(statusName)}</span></span>
      <span class="li-item name" title="${escapeHtml(customer.customerName)}">${escapeHtml(customer.customerName)}</span>
      <span class="li-item phone" title="${escapeHtml(phone)}">${escapeHtml(phone)}</span>
      <span class="li-item memo" title="${escapeHtml(combinedMemo)}">${escapeHtml(combinedMemo)}</span>
      <span class="li-item log">${escapeHtml(lastLogText)}</span>
    `;
    return li;
  }

  function displayAssignedCustomers(customers, isNewSearch) {
    const ul = document.getElementById('assignedCustomersList');
    if (!ul) return; 
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    
    if (isNewSearch) ul.innerHTML = '';
    
    if (customers.length === 0 && isNewSearch) {
      ul.innerHTML = '<li>ì¡°ê±´ì— ë§ëŠ” ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
    } else {
      customers.forEach(customer => {
        ul.appendChild(buildCustomerLi(customer));
      });
    }

    if (totalCustomerCount > (currentOffset + customers.length)) {
      loadMoreBtn.classList.remove('hidden');
    } else {
      loadMoreBtn.classList.add('hidden');
    }
    loadMoreBtn.disabled = false;
  }

  function renderConsultationLogs_Dynamic(logs, rootElement) {
    const logsDiv = rootElement.querySelector('#consultationLogs');
    if (!logsDiv) return;
    
    logsDiv.innerHTML = (!logs || logs.length === 0) ? '<p style="padding: 20px; text-align: center; color: #777;">ìƒë‹´ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>' : '';
    if (!logs) return;

    logs.forEach(log => {
      const logEntryDiv = document.createElement('div');
      logEntryDiv.className = 'log-entry';
      
      const dateStrong = document.createElement('strong');
      dateStrong.textContent = log.logTimestamp ? new Date(log.logTimestamp).toLocaleString('ko-KR') : 'ë‚ ì§œ ì—†ìŒ'; 
      
      const contentDiv = document.createElement('div');
      contentDiv.textContent = log.logContent || ''; 
      contentDiv.style.whiteSpace = 'pre-wrap'; 

      logEntryDiv.appendChild(dateStrong);
      logEntryDiv.appendChild(document.createElement('br'));
      logEntryDiv.appendChild(contentDiv);
      logsDiv.appendChild(logEntryDiv);
    });
  }

  function renderContractList(contracts, panelElement) {
    const ul = panelElement.querySelector('#contractList');
    if (!ul) return;

    if (!contracts || contracts.length === 0) {
      ul.innerHTML = '<li style="padding: 10px; text-align: center; color: #777;">(ê³„ì•½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.)</li>';
      return;
    }

    ul.innerHTML = ''; 
    contracts.forEach(contract => {
      const li = document.createElement('li');
      li.style.cssText = "padding: 10px 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; gap: 10px;";
      
      const dateStr = contract.contractDate ? contract.contractDate : 'ë‚ ì§œ ë¯¸ì •';
      const car = contract.contractCarModel || 'ì°¨ì¢… ë¯¸ì…ë ¥';
      const amount = contract.contractAmount ? `${Number(contract.contractAmount).toLocaleString('ko-KR')} ì›` : 'ê¸ˆì•¡ ë¯¸ì…ë ¥';
      const status = contract.contractStatus || 'ìƒíƒœ ë¯¸ì…ë ¥';

      li.innerHTML = `
        <div style="flex: 1; display: flex; flex-direction: column;">
          <span style="font-weight: bold; font-size: 1.05rem;">${escapeHtml(car)}</span>
          <span style="font-size: 0.9rem; color: #555;">${escapeHtml(dateStr)} | ${escapeHtml(amount)}</span>
        </div>
        <div style="flex-shrink: 0;">
           <span class="status-badge" style="font-size: 0.9rem;">${escapeHtml(status)}</span>
        </div>
      `;
      ul.appendChild(li);
    });
  }

  function showSkeletonLoader() {
    const ul = document.getElementById('assignedCustomersList');
    if (!ul) return; 
    ul.innerHTML = ''; 
    for (let i = 0; i < 5; i++) { 
      const li = document.createElement('li');
      li.className = 'skeleton-li';
      li.innerHTML = `<div class="skeleton-item line-1" style="height:20px; width:100%"></div>`;
      ul.appendChild(li);
    }
  }

  function displayAssignmentDetails_Dynamic(result, panelElement) {
    if (!panelElement || !result || !result.assignment) return;
    const assignment = result.assignment;
    currentAssignmentId = assignment.assignmentId; 

    const setElementValue = (id, value) => {
      const element = panelElement.querySelector('#' + id);
      if (element) {
        if (element.type === 'date' && value) {
           try { element.value = value.split('T')[0]; } catch (e) { element.value = ''; }
        } else if (element.tagName === 'SPAN') {
          element.textContent = value || ''; 
        } else {
          element.value = value || '';
        }
        if (element.tagName === 'SELECT') {
           element.classList.toggle('placeholder', element.value === "");
        }
      }
    };

    setElementValue('detailAssignmentId', assignment.assignmentId);
    setElementValue('detailCustomerPhoneNumber', assignment.customerPhoneNumber ? formatPhoneNumber_Client(assignment.customerPhoneNumber) : ''); 
    setElementValue('detailDbType', assignment.dbType); 
    setElementValue('detailAssignmentDate', assignment.assignmentDate ? assignment.assignmentDate.split('T')[0] : '');
    setElementValue('leadSource', assignment.leadSource);
    setElementValue('customerType', assignment.customerType);
    setElementValue('gender', assignment.gender);
    setElementValue('ageGroup', assignment.ageGroup);
    
    setElementValue('addressCity', assignment.addressCity);
    loadDistricts(assignment.addressCity, assignment.addressDistrict); // District ë¡œë“œ
    
    setElementValue('incomeType', assignment.incomeType);
    setElementValue('creditInfo', assignment.creditInfo);
    setElementValue('occupation', assignment.occupation); // ì¶”ê°€ë¨

    setElementValue('interestedCarModel', assignment.interestedCarModel);
    setElementValue('comparisonCarModel', assignment.comparisonCarModel);
    setElementValue('ownedCarModel', assignment.ownedCarModel);
    setElementValue('carUsage', assignment.carUsage);
    setElementValue('drivingDistance', assignment.drivingDistance);
    setElementValue('driverScope', assignment.driverScope);

    setElementValue('expectedContractTiming', assignment.expectedContractTiming);
    setElementValue('desiredContractTerm', assignment.desiredContractTerm);
    setElementValue('desiredInitialCostType', assignment.desiredInitialCostType);
    setElementValue('maintenanceServiceLevel', assignment.maintenanceServiceLevel);
    setElementValue('salesCondition', assignment.salesCondition);
    setElementValue('isRepurchase', assignment.isRepurchase);
    setElementValue('paymentMethod', assignment.paymentMethod);

    setElementValue('customerStatus', assignment.customerStatus);
    setElementValue('customerMemo', assignment.customerMemo);
    setElementValue('quoteNumber', assignment.quoteNumber);
    setElementValue('approvalNumber', assignment.approvalNumber);

    const detailTitleText = panelElement.querySelector('#detailCustomerNameText');
    if (detailTitleText) {
      detailTitleText.textContent = assignment.customerName ? `${assignment.customerName}` : 'ê³ ê° ìƒì„¸ ì •ë³´';
    }
  }

  // ============================================================================
  // [6] Supabase API ì—°ë™ í•¨ìˆ˜ (Core Logic)
  // ============================================================================

  async function fetchCustomers(isNewSearch = false) {
    if (!document.getElementById('loadMoreBtn')) return;

    if (isNewSearch) {
      currentOffset = 0; 
      document.getElementById('loadMoreBtn').classList.add('hidden'); 
      showSkeletonLoader(); 
      currentFilters = {
        searchTerm: document.getElementById('filterSearchTerm').value,
        dateFrom: document.getElementById('filterAssignmentDateFrom').value,
        dateTo: document.getElementById('filterAssignmentDateTo').value,
        customerStatus: document.getElementById('filterCustomerStatus').value,
        dbType: document.getElementById('filterDbType').value
      };
    } else {
      currentOffset += PAGE_SIZE;
      document.getElementById('loadMoreBtn').disabled = true; 
    }

    try {
      if (!isNewSearch) showLoader();

      let query = supabase
        .from('customers')
        .select('*', { count: 'exact' })
        .range(currentOffset, currentOffset + PAGE_SIZE - 1)
        .order('assignment_date', { ascending: false });

      // í•„í„° ì ìš©
      if (currentFilters.searchTerm) {
        const term = currentFilters.searchTerm;
        query = query.or(`customer_name.ilike.%${term}%,customer_phone.ilike.%${term}%`);
      }
      if (currentFilters.customerStatus) {
        query = query.eq('customer_status', currentFilters.customerStatus);
      }
      if (currentFilters.dbType) {
        query = query.eq('db_type', currentFilters.dbType);
      }
      if (currentFilters.dateFrom) {
        query = query.gte('assignment_date', currentFilters.dateFrom);
      }
      if (currentFilters.dateTo) {
        const nextDay = new Date(currentFilters.dateTo);
        nextDay.setDate(nextDay.getDate() + 1);
        query = query.lt('assignment_date', nextDay.toISOString());
      }
      
      // ë‚´ ë‹´ë‹¹ ê³ ê°ë§Œ ì¡°íšŒ
      // query = query.eq('assigned_to', CURRENT_USER_NAME);

      const { data, error, count } = await query;
      if (error) throw error;

      if (!isNewSearch) hideLoader();
      totalCustomerCount = count;
      
      const uiCustomers = data.map(toUiData);
      displayAssignedCustomers(uiCustomers, isNewSearch);

    } catch (error) {
      handleFailure(error);
      if (isNewSearch) document.getElementById('assignedCustomersList').innerHTML = '<li>ì¡°íšŒ ì‹¤íŒ¨</li>';
      if (!isNewSearch) document.getElementById('loadMoreBtn').disabled = false;
    }
  }

  async function selectCustomer(assignmentId) {
    showLoader();
    try {
      // 1. ê³ ê° ìƒì„¸
      const { data: customerData, error: custError } = await supabase
        .from('customers').select('*').eq('assignment_id', assignmentId).single();
      if (custError) throw custError;

      // 2. ìƒë‹´ ë¡œê·¸
      const { data: logsData, error: logError } = await supabase
        .from('consultation_logs').select('*').eq('assignment_id', assignmentId).order('log_timestamp', { ascending: false });
      if (logError) throw logError;

      // 3. ê³„ì•½ ì´ë ¥
      const { data: contractsData, error: contError } = await supabase
        .from('contracts').select('*').eq('assignment_id', assignmentId).order('contract_date', { ascending: false });
      if (contError) throw contError;

      const result = {
        assignment: toUiData(customerData),
        logs: logsData.map(log => ({
          logId: log.log_id,
          assignmentId: log.assignment_id,
          logContent: log.log_content,
          logTimestamp: log.log_timestamp,
          userName: log.user_name
        })),
        contracts: contractsData.map(c => ({
          contractId: c.contract_id,
          contractDate: c.contract_date,
          contractCarModel: c.contract_car_model,
          contractAmount: c.contract_amount,
          contractStatus: c.contract_status,
          contractSummary: c.contract_summary
        }))
      };

      // ë·° ì „í™˜ ë° ë°ì´í„° í‘œì‹œ
      document.getElementById('listPanel').classList.add('hidden');
      const panelElement = document.getElementById('customerDetailPanel');
      
      displayAssignmentDetails_Dynamic(result, panelElement); 
      
      const logPanel = panelElement.querySelector('.detail-log-pane');
      if(logPanel) {
        renderConsultationLogs_Dynamic(result.logs, logPanel);
        const newLogContentEl = logPanel.querySelector('#newLogContent');
        if (newLogContentEl) newLogContentEl.value = '';
      }
      
      renderContractList(result.contracts, panelElement);
      panelElement.classList.remove('hidden');
      
      document.querySelectorAll('#assignedCustomersList li').forEach(item => {
        item.classList.toggle('active', item.dataset.assignmentId === assignmentId);
      });
      
      const infoPane = panelElement.querySelector('.detail-info-pane');
      if (infoPane) infoPane.scrollTop = 0;
      
      hideLoader();

    } catch (error) {
      handleFailure(error);
    }
  }

  // 7.1 ê³ ê° ì •ë³´ ì—…ë°ì´íŠ¸
  async function handleSaveCustomerDetails(panelElement, assignmentId, saveBtn) {
    if (!assignmentId) return;
    const getVal = (id) => {
      const el = panelElement.querySelector('#' + id);
      return el ? el.value.trim() : null;
    };

    const updates = {
      customer_type: getVal('customerType'),
      gender: getVal('gender'),
      age_group: getVal('ageGroup'),
      address_city: getVal('addressCity'),
      address_district: getVal('addressDistrict'),
      income_type: getVal('incomeType'),
      credit_info: getVal('creditInfo'),
      interested_car_model: getVal('interestedCarModel'),
      comparison_car_model: getVal('comparisonCarModel'),
      owned_car_model: getVal('ownedCarModel'),
      car_usage: getVal('carUsage'),
      driver_scope: getVal('driverScope'),
      driving_distance: getVal('drivingDistance'),
      expected_contract_timing: getVal('expectedContractTiming'),
      desired_contract_term: getVal('desiredContractTerm'),
      desired_initial_cost_type: getVal('desiredInitialCostType'),
      maintenance_service_level: getVal('maintenanceServiceLevel'),
      is_repurchase: getVal('isRepurchase'),
      payment_method: getVal('paymentMethod'),
      customer_status: getVal('customerStatus'),
      customer_memo: getVal('customerMemo'),
      quote_number: getVal('quoteNumber'),
      approval_number: getVal('approvalNumber'),
      lead_source: getVal('leadSource'),
      occupation: getVal('occupation'),
      updated_at: new Date().toISOString()
    };

    showLoader();
    try {
      const { error } = await supabase.from('customers').update(updates).eq('assignment_id', assignmentId);
      if (error) throw error;
      
      await selectCustomer(assignmentId); // UI ê°±ì‹ 
      showSaveFeedback(saveBtn);
    } catch (error) {
      handleFailure(error);
    }
  }

  // 7.2 ì „í™”ë²ˆí˜¸ ì €ì¥ (ê°œë³„ ì €ì¥ ë²„íŠ¼ìš©)
  async function handleSavePhoneNumber(panelElement, assignmentId, saveBtn) {
    if (!assignmentId) return;
    const phoneInput = panelElement.querySelector('#detailCustomerPhoneNumber');
    const newPhone = formatPhoneNumber_Client(phoneInput.value);

    showLoader();
    try {
      const { error } = await supabase.from('customers')
        .update({ customer_phone: newPhone }).eq('assignment_id', assignmentId);
      if (error) throw error;
      
      await selectCustomer(assignmentId);
      showSaveFeedback(saveBtn);
    } catch (error) {
      handleFailure(error);
    }
  }

  // 7.3 ìƒë‹´ ë¡œê·¸ ì¶”ê°€
  async function handleAddLog(panelElement, assignmentId) {
    if (!assignmentId) return;
    const contentEl = panelElement.querySelector('#newLogContent');
    const content = contentEl.value.trim();
    if (!content) {
      showErrorModal("ê¸°ë¡ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    
    showLoader();
    try {
      const newLog = {
        log_id: 'LOG_' + Date.now() + Math.random().toString(36).substr(2,5),
        assignment_id: assignmentId,
        log_content: content,
        user_name: CURRENT_USER_NAME,
        log_timestamp: new Date().toISOString()
      };

      const { error } = await supabase.from('consultation_logs').insert([newLog]);
      if (error) throw error;

      contentEl.value = '';
      // ë¡œê·¸ ë¶€ë¶„ ìƒˆë¡œê³ ì¹¨
      const { data: logsData } = await supabase.from('consultation_logs')
        .select('*').eq('assignment_id', assignmentId).order('log_timestamp', { ascending: false });
        
      const uiLogs = logsData.map(log => ({
          logId: log.log_id,
          assignmentId: log.assignment_id,
          logContent: log.log_content,
          logTimestamp: log.log_timestamp,
          userName: log.user_name
      }));
      
      renderConsultationLogs_Dynamic(uiLogs, panelElement);
      hideLoader();
    } catch (error) {
      handleFailure(error);
    }
  }

  // ============================================================================
  // [8] ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (DOMContentLoaded)
  // ============================================================================
  document.addEventListener('DOMContentLoaded', () => {
    // 1. ìƒì„¸ íŒ¨ë„ ì´ë²¤íŠ¸ ìœ„ì„
    const detailPanel = document.getElementById('customerDetailPanel');
    if (detailPanel) {
      detailPanel.addEventListener('click', e => {
        const target = e.target;
        const targetButton = target.closest('button');
        const targetId = targetButton ? targetButton.id : target.id;
        
        if (!targetId) return;
        if (targetId === 'backToListBtn') {
          e.preventDefault();
          detailPanel.classList.add('hidden');
          document.getElementById('listPanel').classList.remove('hidden');
          document.querySelectorAll('#assignedCustomersList li.active').forEach(li => li.classList.remove('active'));
          currentAssignmentId = null;
          return;
        }
        if (targetId === 'toggleCustomerInfoBtn') {
          e.preventDefault();
          const group = detailPanel.querySelector('#customerInfoGroup');
          if(group) {
            const isHidden = group.classList.toggle('hidden');
            targetButton.textContent = isHidden ? 'ìƒì„¸ ì •ë³´ ë³´ì´ê¸°' : 'ìƒì„¸ ì •ë³´ ìˆ¨ê¸°ê¸°';
          }
          return;
        }

        if (!currentAssignmentId) return;

        // ì €ì¥ ë¡œì§
        if (targetId === 'saveCustomerDetailsBtn') handleSaveCustomerDetails(detailPanel, currentAssignmentId, targetButton);
        else if (targetId === 'savePhoneNumberBtn') handleSavePhoneNumber(detailPanel, currentAssignmentId, targetButton);
        else if (targetId === 'addLogBtn') {
          const logPanel = detailPanel.querySelector('.detail-log-pane');
          if(logPanel) handleAddLog(logPanel, currentAssignmentId);
        }
      });
      
      // ì‹œ/ë„ ì„ íƒ ì´ë²¤íŠ¸
      const citySelect = document.getElementById('addressCity');
      if (citySelect) {
        citySelect.addEventListener('change', (e) => loadDistricts(e.target.value));
      }
    }

    // 2. ëª©ë¡ í™”ë©´ ì´ë²¤íŠ¸
    const listUl = document.getElementById('assignedCustomersList');
    listUl.addEventListener('click', e => {
      const li = e.target.closest('li');
      if (li && li.dataset.assignmentId) selectCustomer(li.dataset.assignmentId);
    });

    // 3. í•„í„° ë° ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('applyFilterBtn').addEventListener('click', () => fetchCustomers(true));
    document.getElementById('loadMoreBtn').addEventListener('click', () => fetchCustomers(false));
    
    document.getElementById('resetFilterBtn').addEventListener('click', () => {
      document.getElementById('filterSearchTerm').value = '';
      document.getElementById('filterDbType').value = '';
      document.getElementById('filterCustomerStatus').value = '';
      const today = new Date();
      const threeMonthsAgo = new Date(new Date().setMonth(today.getMonth() - 3)).toISOString().split('T')[0];
      document.getElementById('filterAssignmentDateFrom').value = threeMonthsAgo;
      document.getElementById('filterAssignmentDateTo').value = '';
      fetchCustomers(true);
    });

    // 4. ì‹ ê·œ ê³ ê° ì¶”ê°€ (ëª¨ë‹¬)
    const addCustomerModal = document.getElementById('addCustomerModal');
    document.getElementById('openAddCustomerModalBtn').addEventListener('click', () => addCustomerModal.classList.remove('hidden'));
    document.getElementById('cancelAddCustomerBtn').addEventListener('click', () => {
      addCustomerModal.classList.add('hidden');
      document.getElementById('newCustomerName').value = '';
      document.getElementById('newCustomerPhoneNumber').value = '';
    });

    document.getElementById('saveNewCustomerBtn').addEventListener('click', async () => {
      const name = document.getElementById('newCustomerName').value.trim();
      const phone = document.getElementById('newCustomerPhoneNumber').value.trim();
      const dbType = document.getElementById('newDbType').value;
      
      if (!name) { showErrorModal("ê³ ê°ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }
      
      showLoader();
      try {
        const timestamp = Date.now();
        const newCustomer = {
          assignment_id: "A_" + timestamp,
          customer_id: "C_" + timestamp,
          customer_name: name,
          customer_phone: phone,
          db_type: dbType,
          assigned_to: CURRENT_USER_NAME,
          assignment_date: new Date().toISOString(),
          customer_status: "ë°°ì •ë¨"
        };
        
        const { error } = await supabase.from('customers').insert([newCustomer]);
        if (error) throw error;
        
        hideLoader();
        addCustomerModal.classList.add('hidden');
        document.getElementById('newCustomerName').value = '';
        fetchCustomers(true); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      } catch (error) {
        handleFailure(error);
      }
    });

    // 5. ì‹ ê·œ ê³„ì•½ ì¶”ê°€ (ëª¨ë‹¬)
    const addContractModal = document.getElementById('addContractModal');
    document.getElementById('openAddContractModalBtn').addEventListener('click', (e) => {
      e.preventDefault(); e.stopPropagation();
      if (!currentAssignmentId) { showErrorModal("ê³ ê°ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return; }
      addContractModal.classList.remove('hidden');
      // ì´ˆê¸°í™”
      document.getElementById('modalContractDate').value = '';
      document.getElementById('modalContractCarModel').value = '';
      document.getElementById('modalContractAmount').value = '';
      document.getElementById('modalContractTerm').value = '';
      document.getElementById('modalContractSummary').value = '';
    });
    document.getElementById('cancelAddContractBtn').addEventListener('click', () => addContractModal.classList.add('hidden'));

    document.getElementById('saveNewContractBtn').addEventListener('click', async () => {
      const date = document.getElementById('modalContractDate').value;
      const car = document.getElementById('modalContractCarModel').value.trim();
      const amount = document.getElementById('modalContractAmount').value;
      const term = document.getElementById('modalContractTerm').value.trim();
      const summary = document.getElementById('modalContractSummary').value.trim();

      if (!date || !car) { showErrorModal("ê³„ì•½ì¼ê³¼ ì°¨ì¢…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }

      showLoader();
      try {
        const newContract = {
          contract_id: "CN_" + Date.now(),
          assignment_id: currentAssignmentId,
          contract_date: date,
          contract_car_model: car,
          contract_amount: Number(amount) || 0,
          contract_term: term,
          contract_summary: summary,
          contract_status: 'ì§„í–‰ì¤‘'
        };
        const { error } = await supabase.from('contracts').insert([newContract]);
        if (error) throw error;
        
        hideLoader();
        addContractModal.classList.add('hidden');
        
        // ê³„ì•½ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ì „ì²´ ê°±ì‹  ëŒ€ì‹  ê³„ì•½ë§Œ)
        const { data: contractsData } = await supabase.from('contracts')
          .select('*').eq('assignment_id', currentAssignmentId).order('contract_date', { ascending: false });
        
        const uiContracts = contractsData.map(c => ({
          contractId: c.contract_id,
          contractDate: c.contract_date,
          contractCarModel: c.contract_car_model,
          contractAmount: c.contract_amount,
          contractStatus: c.contract_status,
          contractSummary: c.contract_summary
        }));
        renderContractList(uiContracts, document.getElementById('customerDetailPanel'));

      } catch (error) {
        handleFailure(error);
      }
    });

    // 6. í‚¤ë³´ë“œ ì´ë²¤íŠ¸
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (!addContractModal.classList.contains('hidden')) addContractModal.classList.add('hidden');
        else if (!addCustomerModal.classList.contains('hidden')) addCustomerModal.classList.add('hidden');
        else if (!document.getElementById('customerDetailPanel').classList.contains('hidden')) {
          document.getElementById('backToListBtn').click();
        }
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        const searchBox = document.getElementById('filterSearchTerm');
        if (searchBox) searchBox.focus(); 
      }
    });

    // í•„í„° ì—”í„°í‚¤ ì²˜ë¦¬
    const filterPanel = document.querySelector('.filter-panel');
    if (filterPanel) {
      filterPanel.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT')) {
          e.preventDefault();
          document.getElementById('applyFilterBtn').click();
        }
      });
    }

    // ì „í™”ë²ˆí˜¸ ìë™ í¬ë§·
    document.getElementById('newCustomerPhoneNumber').addEventListener('blur', (e) => {
      e.target.value = formatPhoneNumber_Client(e.target.value);
    });

    // 7. ì´ˆê¸°í™” ì‹¤í–‰
    populateSelectOptions(CONFIG);
    const today = new Date();
    const threeMonthsAgo = new Date(new Date().setMonth(today.getMonth() - 3)).toISOString().split('T')[0];
    document.getElementById('filterAssignmentDateFrom').value = threeMonthsAgo;
    document.getElementById('filterLastLogDateFrom').value = threeMonthsAgo;

    console.log("ğŸš€ App Initialized with Supabase");
    fetchCustomers(true);
  });
