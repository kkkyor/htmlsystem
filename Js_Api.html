
  // ============================================================================
  // [4] ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (API í˜¸ì¶œ ë° ë°ì´í„° ê´€ë¦¬)
  // ============================================================================

  // ----------------------------------------------------------------------------
  // 4-1. ê³ ê° ëª©ë¡ ì¡°íšŒ (í•„í„° ë° ì •ë ¬ ì ìš©)
  // ----------------------------------------------------------------------------
  async function fetchCustomers(isNew = false) {
    if(isNew) {
      currentOffset = 0;
      const getSafeVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };
      currentFilters = {
        searchTerm: getSafeVal('filterSearchTerm'),
        dbType: getSafeVal('filterDbType'),
        status: getSafeVal('filterCustomerStatus'),
        dateFrom: getSafeVal('filterAssignmentDateFrom'),
        dateTo: getSafeVal('filterAssignmentDateTo')
      };
    } else {
      currentOffset += PAGE_SIZE;
    }

    showLoader();
    try {
      // ì •ë ¬ ì˜µì…˜ ì„¤ì •: 'ìµœê·¼ìƒë‹´'ì¼ ê²½ìš° NULL ê°’ì„ ë§¨ ìœ„ë¡œ(í• ì¼ ìš°ì„ )
      const isLastLogSort = (currentSortColumn === 'last_log_date');
      const nullsFirstOption = isLastLogSort ? true : false;

      let query = supabase.from('customers').select('*', { count: 'exact' })
        .range(currentOffset, currentOffset + PAGE_SIZE - 1)
        .order(currentSortColumn, { ascending: currentSortAscending, nullsFirst: nullsFirstOption });

      if (currentUserName) {
        query = query.eq('assigned_to', currentUserName);
      }

      // ê²€ìƒ‰ ë¡œì§
      if(currentFilters.searchTerm) {
         const term = currentFilters.searchTerm;
         const cleanTerm = term.replace(/-/g, ''); 

         const searchConditions = [
            `customer_name.ilike.%${term}%`,
            `customer_phone.ilike.%${cleanTerm}%`, 
            `customer_phone.ilike.%${term}%`,
            `customer_memo.ilike.%${term}%`,
            `interested_car_model.ilike.%${term}%`
         ].join(',');

         query = query.or(searchConditions);
      }
      
      if(currentFilters.status) query = query.eq('customer_status', currentFilters.status);
      if(currentFilters.dbType) query = query.eq('db_type', currentFilters.dbType);
      if(currentFilters.dateFrom) query = query.gte('assignment_date', currentFilters.dateFrom);
      if(currentFilters.dateTo) {
        const d = new Date(currentFilters.dateTo); d.setDate(d.getDate()+1);
        query = query.lt('assignment_date', d.toISOString());
      }

      const { data, count, error } = await query;
      if(error) throw error;
      
      totalCustomerCount = count;
      displayAssignedCustomers(data.map(toUiData), isNew);
    } catch(e) {
      handleFailure(e);
    } finally {
      hideLoader();
    }
  }

  // ----------------------------------------------------------------------------
  // 4-2. ê³„ì•½ ëª©ë¡ ì¡°íšŒ (ì „ì²´ ê³„ì•½ íƒ­)
  // ----------------------------------------------------------------------------
  async function fetchGlobalContracts(isNew = false) {
    if (isNew) {
      currentContractOffset = 0;
    } else {
      currentContractOffset += PAGE_SIZE;
    }

    showLoader();
    try {
      // ë‚´ ë‹´ë‹¹ ê³ ê°ì˜ ê³„ì•½ë§Œ í•„í„°ë§ (customers!inner ì¡°ì¸)
      let query = supabase
        .from('contracts')
        .select('*, customers!inner(customer_name, customer_phone, assigned_to)')
        .eq('customers.assigned_to', currentUserName)
        .order('contract_date', { ascending: false });

      // í•„í„° ì ìš©
      const statusEl = document.getElementById('filterContractStatus');
      const termEl = document.getElementById('contractSearchTerm');
      const dateEl = document.getElementById('filterContractDateFrom');
      
      if (statusEl && statusEl.value) query = query.eq('contract_status', statusEl.value);
      
      if (termEl && termEl.value) {
        query = query.ilike('contract_car_model', `%${termEl.value}%`);
      }
      
      if (dateEl && dateEl.value) query = query.gte('contract_date', dateEl.value);

      const { data, count, error } = await query; 
      if (error) throw error;

      if (isNew) {
          renderGlobalContracts(data, true); 
      } else {
          renderGlobalContracts(data, false);
      }
    } catch (e) {
      handleFailure(e);
    } finally {
      hideLoader();
    }
  }

  // ----------------------------------------------------------------------------
  // 4-3. ë‹¨ì¼ ê³ ê° ìƒì„¸ ì¡°íšŒ (ìƒë‹´ ë¡œê·¸, ê³„ì•½ ì´ë ¥ í¬í•¨)
  // ----------------------------------------------------------------------------
  async function selectCustomer(id) {
    showLoader();
    try {
      const { data: cust, error: e1 } = await supabase.from('customers').select('*').eq('assignment_id', id).maybeSingle();
      
      if (e1) throw e1;
      if (!cust) throw new Error("ì‚­ì œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê³ ê°ì…ë‹ˆë‹¤.");
      
      const { data: logs, error: e2 } = await supabase.from('consultation_logs').select('*').eq('assignment_id', id).order('log_timestamp', {ascending:false});
      if(e2) throw e2;

      const { data: contracts, error: e3 } = await supabase.from('contracts')
        .select('*, customers(customer_name)') 
        .or(`assignment_id.eq.${id},consultant_id.eq.${id}`)
        .order('contract_date', {ascending:false});
      if(e3) throw e3;

      // íŒ¨ë„ ì œì–´
      document.getElementById('listPanel').classList.add('hidden');
      if(document.getElementById('contractListPanel')) document.getElementById('contractListPanel').classList.add('hidden');
      const contractPanel = document.getElementById('contractDetailPanel');
      if(contractPanel) contractPanel.classList.add('hidden');

      document.getElementById('customerDetailPanel').classList.remove('hidden');

      displayAssignmentDetails({ assignment: toUiData(cust) });
      
      renderLogs(logs.map(l => ({ 
          logId: l.log_id, 
          logTimestamp: l.log_timestamp, 
          logContent: l.log_content,
          userName: l.user_name 
      })));
      renderContracts(contracts);

    } catch(e) {
      handleFailure(e);
    } finally {
      hideLoader();
    }
  }

  // ----------------------------------------------------------------------------
  // 4-4. ìƒë‹´ ë¡œê·¸ ê´€ë¦¬ (ì‚­ì œ/ìˆ˜ì •)
  // ----------------------------------------------------------------------------
  async function deleteLog(logId) {
    if (!confirm("ì •ë§ ì´ ìƒë‹´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    showLoader();
    const { error } = await supabase
        .from('consultation_logs')
        .delete()
        .eq('log_id', logId);
    
    hideLoader();
    if (error) {
        alert("ì‚­ì œ ì‹¤íŒ¨: " + error.message);
    } else {
        if(currentAssignmentId) selectCustomer(currentAssignmentId);
    }
  }

  async function editLog(logId, btnElement) {
    const contentDiv = document.getElementById(`content-${logId}`);
    const currentContent = contentDiv.textContent;
    const card = btnElement.closest('.log-entry-card');
    const actionsDiv = btnElement.closest('.log-actions');
    
    if (card.querySelector('textarea')) return;

    contentDiv.style.display = 'none';
    actionsDiv.style.display = 'none';

    const editorDiv = document.createElement('div');
    editorDiv.innerHTML = `
        <textarea style="width:100%; height:100px; margin:5px 0; border:1px solid #ccc; padding:5px;">${currentContent}</textarea>
        <div style="text-align:right; gap:5px; display:flex; justify-content:flex-end;">
            <button id="save-${logId}" style="padding:4px 10px; font-size:0.8rem;">ì €ì¥</button>
            <button id="cancel-${logId}" class="secondary" style="padding:4px 10px; font-size:0.8rem;">ì·¨ì†Œ</button>
        </div>
    `;
    card.appendChild(editorDiv);

    document.getElementById(`save-${logId}`).onclick = async () => {
        const newText = editorDiv.querySelector('textarea').value;
        if (!newText.trim()) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

        showLoader();
        const { error } = await supabase
            .from('consultation_logs')
            .update({ log_content: newText }) 
            .eq('log_id', logId);
            
        hideLoader();
        if (error) {
            alert("ìˆ˜ì • ì‹¤íŒ¨: " + error.message);
        } else {
            if(currentAssignmentId) selectCustomer(currentAssignmentId);
        }
    };

    document.getElementById(`cancel-${logId}`).onclick = () => {
        editorDiv.remove();
        contentDiv.style.display = 'block';
        actionsDiv.style.display = 'flex';
    };
  }

  // ----------------------------------------------------------------------------
  // 4-5. Cloud Run AI ë¶„ì„ (ìŒì„± íŒŒì¼ ì—…ë¡œë“œ)
  // ----------------------------------------------------------------------------
  const CLOUD_RUN_BASE_URL = "https://rental-analyzer-812042135518.asia-northeast3.run.app"; 

  const btnAnalyze = document.getElementById('btnAnalyzeVoice');
  const fileInput = document.getElementById('voiceFileInput');

  // HTML ìš”ì†Œê°€ ë¡œë“œëœ í›„ ì´ë²¤íŠ¸ ë°”ì¸ë”© (DOMì´ ì¡´ì¬í•  ë•Œë§Œ)
  if (btnAnalyze && fileInput) {
    btnAnalyze.addEventListener('click', () => {
      fileInput.value = ''; 
      fileInput.click();
    });

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      if (!confirm(`'${file.name}' ë¶„ì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n`)) return;

      showLoader(); 
      
      try {
        const fileId = `upload_${Date.now()}_${Math.floor(Math.random()*1000)}`;
        const CHUNK_SIZE = 10 * 1024 * 1024; 
        const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
        
        // 1. ì²­í¬ ì—…ë¡œë“œ
        for (let i = 0; i < totalChunks; i++) {
            const start = i * CHUNK_SIZE;
            const end = Math.min(file.size, start + CHUNK_SIZE);
            const chunk = file.slice(start, end);
            
            const percent = Math.round(((i) / totalChunks) * 100);
            setStatusMessage(`ğŸ“¡ ì „ì†¡ ì¤‘... ${percent}% (${i+1}/${totalChunks})`);

            const formData = new FormData();
            formData.append("file", chunk);
            formData.append("file_id", fileId);
            formData.append("chunk_index", i);

            const res = await fetch(`${CLOUD_RUN_BASE_URL}/upload-chunk`, {
                method: "POST",
                body: formData
            });
            
            if (!res.ok) throw new Error(`Chunk ${i} upload failed`);
        }

        // 2. í•©ì²´ ë° ë¶„ì„ ìš”ì²­
        setStatusMessage("ğŸ¤– AI ë¶„ì„ ì¤‘... (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)");
        
        let mimeType = file.type;
        if (!mimeType && file.name.toLowerCase().endsWith('.m4a')) mimeType = 'audio/mp4';
        if (!mimeType) mimeType = 'audio/mp3';

        const finalForm = new FormData();
        finalForm.append("file_id", fileId);
        finalForm.append("total_chunks", totalChunks);
        finalForm.append("file_name", file.name);
        finalForm.append("mime_type", mimeType);

        const analyzeRes = await fetch(`${CLOUD_RUN_BASE_URL}/analyze-chunked`, {
            method: "POST",
            body: finalForm
        });

        const result = await analyzeRes.json();
        if (!result.success) throw new Error(result.error);
        
        onAnalysisSuccess({ success: true, data: result.data });

      } catch (err) {
        alert("âŒ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
        console.error(err);
      } finally {
        hideLoader();
      }
    });
  }

  // AI ë¶„ì„ ì„±ê³µ ì‹œ ë°ì´í„° ì±„ìš°ê¸° (Smart Fill)
  function onAnalysisSuccess(response) {
    hideLoader();

    if (!response.success) {
      alert("âŒ ë¶„ì„ ì‹¤íŒ¨:\n" + response.error);
      return;
    }

    let data = response.data;
    if (Array.isArray(data)) data = data[0];
    
    if (!data || Object.keys(data).length === 0) {
        alert("âš ï¸ ë¶„ì„ì€ ì„±ê³µí–ˆìœ¼ë‚˜ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
        return;
    }

    alert("âœ… ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\në‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");

    const smartFill = (id, newVal) => {
      const el = document.getElementById(id);
      if (!el) return;
      if (newVal === undefined || newVal === null || String(newVal).trim() === "") return;

      const currentVal = el.value.trim();
      const isPlaceholder = currentVal === '' || currentVal.includes('í™•ì¸') || currentVal.includes('ë¯¸ì •') || currentVal.includes('ì¶”ì •');
      if (!isPlaceholder) return; 

      const normalizeStr = (str) => String(str).normalize("NFC").replace(/\s+/g, '').toLowerCase();
      const cleanNewVal = normalizeStr(newVal);

      if (el.tagName.toUpperCase() === 'SELECT') {
          let bestMatch = "";
          for (let i = 0; i < el.options.length; i++) {
              const optVal = el.options[i].value;
              const optText = el.options[i].text;
              const cleanOptVal = normalizeStr(optVal);
              const cleanOptText = normalizeStr(optText);

              if (cleanOptVal === cleanNewVal || cleanOptText === cleanNewVal ||
                 (cleanOptVal.length > 0 && cleanNewVal.includes(cleanOptVal)) || 
                 (cleanOptText.length > 0 && cleanNewVal.includes(cleanOptText))) {
                  bestMatch = optVal;
                  break;
              }
          }
          
          if (bestMatch) {
              el.value = bestMatch; 
          } else {
              // ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ ê°•ì œ ì¶”ê°€ ì˜µì…˜ (ì„ íƒì‚¬í•­)
              let optExists = false;
              for(let j=0; j<el.options.length; j++) {
                  if(el.options[j].value == newVal) { optExists = true; break; }
              }
              if (!optExists) {
                  const newOpt = document.createElement('option');
                  newOpt.value = newVal;
                  newOpt.text = newVal; 
                  newOpt.style.color = "blue"; 
                  el.add(newOpt);
              }
              el.value = newVal;
          }
          highlight(el);

      } else {
          el.value = newVal;
          highlight(el);
      }
    };

    const highlight = (el) => {
        el.style.backgroundColor = "#d1e7dd"; 
        setTimeout(() => el.style.backgroundColor = "", 3000);
    };

    // ë°ì´í„° ë§¤í•‘
    smartFill('customerType', data.customer_type);
    smartFill('gender', data.gender);
    smartFill('ageGroup', data.age_group);
    smartFill('addressCity', data.address_city);
    smartFill('incomeType', data.income_type);
    smartFill('creditInfo', data.credit_info);
    smartFill('occupation', data.occupation);
    
    smartFill('interestedCarModel', data.interested_car_model);
    smartFill('comparisonCarModel', data.comparison_car_model);
    smartFill('ownedCarModel', data.owned_car_model);
    smartFill('carUsage', data.car_usage);
    smartFill('drivingDistance', data.driving_distance);
    smartFill('driverScope', data.driver_scope);
    smartFill('expectedContractTiming', data.expected_contract_timing);
    smartFill('desiredContractTerm', data.desired_contract_term);
    smartFill('desiredInitialCostType', data.desired_initial_cost_type);
    smartFill('maintenanceServiceLevel', data.maintenance_service_level);

    if (data.customer_phone) {
        const formatted = typeof formatPhoneNumber_Client === 'function' ? formatPhoneNumber_Client(data.customer_phone) : data.customer_phone;
        smartFill('detailCustomerPhoneNumber', formatted);
    }

    const memoEl = document.getElementById('customerMemo');
    if (memoEl && data.summary) {
      const currentMemo = memoEl.value;
      if (!currentMemo.includes(data.summary)) {
          const prefix = currentMemo ? " | " : "";
          memoEl.value += prefix + "[AIìš”ì•½] " + data.summary;
          highlight(memoEl);
      }
    }

    const logEl = document.getElementById('newLogContent');
    if (logEl && data.summary) {
      logEl.value = `[ğŸ™ï¸ ë…¹ìŒ ë¶„ì„ ê²°ê³¼]\n\nğŸ“„ í•µì‹¬ìš”ì•½:\n${data.summary}\n\nğŸ“ ìƒì„¸ë‚´ìš©:\n${data.details || '(ë‚´ìš© ì—†ìŒ)'}`;
      highlight(logEl);
      const addLogBtn = document.getElementById('addLogBtn');
      if(addLogBtn) addLogBtn.focus();
    }
  }
