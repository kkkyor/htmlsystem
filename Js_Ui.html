
  // ============================================================================
  // [Js_Ui.html]
  // ============================================================================
  
  function toUiData(dbData) {
    if (!dbData) return null;
    return {
      assignmentId: dbData.assignment_id,
      customerName: dbData.customer_name,
      customerPhoneNumber: dbData.customer_phone,
      assignedTo: dbData.assigned_to,
      dbType: dbData.db_type,
      assignmentDate: dbData.assignment_date,
      customerStatus: dbData.customer_status,
      // ìƒì„¸ ì •ë³´ë“¤
      leadSource: dbData.lead_source,
      customerType: dbData.customer_type,
      gender: dbData.gender,
      ageGroup: dbData.age_group,
      addressCity: dbData.address_city,
      incomeType: dbData.income_type,
      creditInfo: dbData.credit_info,
      interestedCarModel: dbData.interested_car_model,
      comparisonCarModel: dbData.comparison_car_model,
      ownedCarModel: dbData.owned_car_model,
      carUsage: dbData.car_usage,
      driverScope: dbData.driver_scope,
      driving_distance: dbData.driving_distance,
      expectedContractTiming: dbData.expected_contract_timing,
      desiredContractTerm: dbData.desired_contract_term,
      desiredInitialCostType: dbData.desired_initial_cost_type,
      maintenanceServiceLevel: dbData.maintenance_service_level,
      salesCondition: dbData.sales_condition,
      isRepurchase: dbData.is_repurchase,
      paymentMethod: dbData.payment_method,
      customerMemo: dbData.customer_memo,
      quoteNumber: dbData.quote_number,
      approvalNumber: dbData.approval_number,
      occupation: dbData.occupation,
      lastLogDate: dbData.last_log_date,
      updatedAt: dbData.updated_at 
    };
  }

  async function populateSelectOptions() {
    const populate = (id, opts) => {
      const el = document.getElementById(id);
      if (!el || el.tagName !== 'SELECT') return;
      
      if(id.startsWith('filter')) {
           el.innerHTML = '<option value="">ì „ì²´</option>';
      } else {
           el.innerHTML = '<option value=""></option>';
      }

      if(opts) { 
          opts.forEach(v => { 
            const op = document.createElement('option'); 
            op.value = v; 
            op.textContent = v; 
            el.appendChild(op); 
          });
      }
    };

    const opts = CONFIG.selectOptions;

    // 1. DB ìœ í˜•
    const dbTypeList = opts.dbTypes || [];
    populate('filterDbType', dbTypeList);
    populate('newDbType', dbTypeList);
    populate('detailDbType', dbTypeList);

    // 2. ìœ ì… ê²½ë¡œ
    const { data: dbData } = await supabase.from('db_types').select('type_name').eq('is_active', true).order('sort_order', { ascending: true });
    const leadSourceList = dbData ? dbData.map(i => i.type_name) : [];
    
    populate('filterLeadSource', leadSourceList);
    populate('leadSource', leadSourceList);
    populate('newLeadSource', leadSourceList);
    populate('filterContractLeadSource', leadSourceList);
    populate('modalLeadSource', leadSourceList);

    // 3. ê³„ì•½ ì ‘ìˆ˜ì²˜
    const receiptSources = opts.contractReceiptSource || [];
    populate('filterContractReceiptSource', receiptSources);
    populate('modalContractReceiptSource', receiptSources);

    // 4. ê³„ì•½ ì§„í–‰ ìƒíƒœ
    const contStatusList = opts.contractStatus || [];
    populate('filterContractStatus', contStatusList);
    populate('detailContractStatus', contStatusList);

    // 5. ê³ ê° ì§„í–‰ ìƒíƒœ
    populate('filterCustomerStatus', opts.customerStatus);

    // 6. ì§€ì—­
    populate('addressCity', opts.addressCities);

    // 7. ë‚˜ë¨¸ì§€ í•­ëª©ë“¤
    Object.keys(opts).forEach(key => {
        if(['dbTypes', 'contractReceiptSource', 'addressCities', 'contractStatus'].includes(key)) return;
        populate(key, opts[key]);
    });
  }

  function getStatusClass(status) {
    if (!status) return '';
    
    // 1. ì„±ê³µ/ì™„ë£Œ -> ì´ˆë¡ìƒ‰
    const successList = ['ê³„ì•½ ì™„ë£Œ', 'ì¶œê³  ì™„ë£Œ', 'ì´ìš©ì¤‘', 'ìƒë‹´ ì™„ë£Œ', 'ì‹¬ì‚¬ ì™„ë£Œ'];
    if (successList.includes(status)) return 'success';
    
    // 2. ì§„í–‰ì¤‘/ëŒ€ê¸° -> ë…¸ë€/ì£¼í™©ìƒ‰
    const warningList = ['ìƒë‹´ ì§„í–‰ ì¤‘', 'ì—°ë½ ì‹œë„ ì¤‘', 'ì§„í–‰ì¤‘', 'ê²¬ì  ë°œì†¡', 'ì¶”ê°€ ì •ë³´ ìš”ì²­', 'ì‹¬ì‚¬ ì§„í–‰ì¤‘', 'ì¶œê³  ëŒ€ê¸°'];
    if (warningList.includes(status)) return 'warning';
    
    // 3. ìœ„í—˜/ì·¨ì†Œ -> ë¹¨ê°„ìƒ‰
    const dangerList = ['ì·¨ì†Œ', 'ì¤‘ë„ í•´ì§€', 'ìƒë‹´ ì´íƒˆ', 'ìƒë‹´ ë³´ë¥˜', 'ì¡°ê¸° ë°˜ë‚©', 'ì‹¬ì‚¬ ë¶€ê²°', 'ì·¨ì†Œ/í•´ì§€'];
    if (dangerList.includes(status)) return 'danger';
    
    // 4. ì •ë³´/ìŠ¹ì¸ -> íŒŒë€ìƒ‰
    // [ìˆ˜ì •] 'ë°°ì •ë¨'ì„ ì—¬ê¸°ì„œ ì œê±°í•˜ê³  darkListë¡œ ì´ë™
    const infoList = ['ê°€ë§ ê³ ê°', 'ì‹¬ì‚¬ ìŠ¹ì¸'];
    if (infoList.includes(status)) return 'info';
    
    // 5. ì¢…ë£Œ/ë§Œê¸°/ë°°ì • -> ì§™ì€ íšŒìƒ‰
    // [ìˆ˜ì •] 'ë°°ì •ë¨'ì„ ì—¬ê¸°ì— ì¶”ê°€í•˜ì—¬ íšŒìƒ‰ìœ¼ë¡œ í‘œì‹œ
    const darkList = ['ë§Œê¸° ë°˜ë‚©', 'ë§Œê¸° ì¸ê³„', 'ê¸°ì¡´ ê³ ê°', 'ë°°ì •ë¨'];
    if (darkList.includes(status)) return 'dark';

    return ''; 
  }

  function displayAssignedCustomers(customers, isNew) {
    const ul = document.getElementById('assignedCustomersList');
    const btn = document.getElementById('loadMoreBtn');
    if (isNew) ul.innerHTML = '';
    
    if (customers.length === 0 && isNew) {
      ul.innerHTML = '<li style="padding:20px; justify-content:center; color:#666;">ì¡°ê±´ì— ë§ëŠ” ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
    } else {
      customers.forEach(c => {
        const li = document.createElement('li');
        li.onclick = () => {
            window.customerDetailSource = 'listPanel'; 
            selectCustomer(c.assignmentId);
        };
        const statusClass = getStatusClass(c.customerStatus);
        let combinedMemo = c.interestedCarModel || '';
        if(c.customerMemo) combinedMemo = combinedMemo ? `${combinedMemo} | ${c.customerMemo}` : c.customerMemo;
        if(!combinedMemo) combinedMemo = ''; 

        const dateStr = formatDate(c.assignmentDate);
        const lastLogStr = c.lastLogDate ? formatDate(c.lastLogDate) : '-';

        li.innerHTML = `
          <span class="col-status"><span class="status-badge ${statusClass}">${escapeHtml(c.customerStatus)}</span></span>
          <span class="col-db">${escapeHtml(c.dbType)}</span>
          <span class="col-source" title="${escapeHtml(c.leadSource)}">${escapeHtml(c.leadSource)}</span>
          <span class="col-name" title="${escapeHtml(c.customerName)}">${escapeHtml(c.customerName)}</span>
          <span class="col-phone">${escapeHtml(formatPhoneNumber_Client(c.customerPhoneNumber))}</span>
          <span class="col-memo" title="${escapeHtml(combinedMemo)}">${escapeHtml(combinedMemo)}</span>
          <span class="col-last">${lastLogStr}</span>
          <span class="col-date">${dateStr}</span>
        `;
        ul.appendChild(li);
      });
    }
    
    if (totalCustomerCount > (currentOffset + customers.length)) btn.classList.remove('hidden');
    else btn.classList.add('hidden');
    btn.disabled = false;
  }

  function displayAssignmentDetails(result) {
    const data = result.assignment;
    currentAssignmentId = data.assignmentId;
    
    const setVal = (id, v) => {
      const el = document.getElementById(id);
      if(el) {
        if(el.type === 'date' && v) el.value = formatDate(v);
        else if(el.tagName === 'SPAN') {
            if(id.includes('Date') || id.includes('Time')) el.textContent = formatDate(v);
            else el.textContent = v || '';
        }
        else el.value = v || '';
      }
    };

    setVal('detailAssignmentId', data.assignmentId);
    setVal('detailDbType', data.dbType);
    setVal('detailAssignmentDate', data.assignmentDate);
    setVal('detailCustomerPhoneNumber', data.customerPhoneNumber);
    
    setVal('leadSource', data.leadSource);
    setVal('customerType', data.customerType);
    setVal('gender', data.gender);
    setVal('ageGroup', data.ageGroup);
    setVal('addressCity', data.addressCity);
    
    setVal('incomeType', data.incomeType);
    setVal('creditInfo', data.creditInfo);
    setVal('occupation', data.occupation);
    setVal('interestedCarModel', data.interestedCarModel);
    setVal('comparisonCarModel', data.comparisonCarModel);
    setVal('ownedCarModel', data.ownedCarModel);
    setVal('carUsage', data.carUsage);
    setVal('driverScope', data.driverScope);
    setVal('drivingDistance', data.drivingDistance);
    setVal('expectedContractTiming', data.expectedContractTiming);
    setVal('desiredContractTerm', data.desiredContractTerm);
    setVal('desiredInitialCostType', data.desiredInitialCostType);
    setVal('maintenanceServiceLevel', data.maintenanceServiceLevel);
    setVal('customerStatus', data.customerStatus);
    setVal('customerMemo', data.customerMemo);
    setVal('quoteNumber', data.quoteNumber);
    setVal('approvalNumber', data.approvalNumber);

    document.getElementById('detailCustomerNameText').textContent = data.customerName;
    currentDataTimestamp = data.updatedAt;
  }

  function renderLogs(logs) {
    const div = document.getElementById('consultationLogs');
    div.innerHTML = '';
    
    if(!logs || logs.length === 0) {
      div.innerHTML = '<p style="text-align:center; padding:20px; color:#777;">ê¸°ë¡ ì—†ìŒ</p>';
      return;
    }

    logs.forEach(l => {
      const card = document.createElement('div');
      card.className = 'log-entry-card';
      const timeStr = new Date(l.logTimestamp).toLocaleString();
      const writer = l.userName || 'ìƒë‹´ì›'; 
      const isMyLog = (l.userName === currentUserName);
      
      let buttonsHtml = '';
      if (isMyLog) {
          buttonsHtml = `
            <div class="log-actions" style="display:flex; gap:8px; margin-top:8px; justify-content:flex-end;">
                <button onclick="editLog('${l.logId}', this)" class="secondary" style="padding:2px 8px; font-size:0.8rem;">ìˆ˜ì •</button>
                <button class="secondary" disabled style="padding:2px 8px; font-size:0.8rem; background:#ccc; cursor:not-allowed;">ì‚­ì œ</button>
            </div>
          `;
      }

      card.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
            <span class="log-time" style="color:#007bff; font-weight:bold; font-size:0.8rem;">${timeStr}</span>
            <span style="font-size:0.75rem; color:#999;">${escapeHtml(writer)}</span>
        </div>
        <div class="log-content" id="content-${l.logId}" style="white-space: pre-wrap; line-height:1.4;">${escapeHtml(l.logContent)}</div>
        ${buttonsHtml}
      `;
      div.appendChild(card);
    });
  }

  function renderContracts(contracts) {
    const ul = document.getElementById('contractList');
    ul.innerHTML = '';
    if(!contracts || contracts.length === 0) {
      ul.innerHTML = '<li style="text-align:center; padding:15px; color:#999; font-size:0.9rem;">ê³„ì•½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
      return;
    }
    contracts.forEach(c => {
      const li = document.createElement('li');
      li.onclick = (e) => {
         e.stopPropagation();
         const currentName = document.getElementById('detailCustomerNameText').textContent;
         const contractData = { ...c, customers: c.customers || { customer_name: currentName } };
         viewContractDetail(contractData, 'customer_detail');
      };

      const cDate = formatDate(c.contract_date);
      const cModel = c.contract_car_model || '-';
      const cStatus = c.contract_status || '-';
      const statusClass = getStatusClass(cStatus);
      
      // [ì¶”ê°€] í‘œì‹œí•  ë°ì´í„° ë³€ìˆ˜ ì¤€ë¹„
      // ëª…ì˜ì: ê³ ê° ì •ë³´ê°€ ìˆìœ¼ë©´ ì´ë¦„ í‘œì‹œ, ì—†ìœ¼ë©´ 'ë¯¸í™•ì¸'
      const custName = c.customers ? c.customers.customer_name : '(ë¯¸í™•ì¸)';
      // ê³„ì•½ ê¸°ê°„: ìˆ«ì ë’¤ì— 'ê°œì›”' ë¶™ì„ (ì—†ìœ¼ë©´ ë¹ˆì¹¸)
      const cTerm = c.contract_term ? c.contract_term + '' : '';
      // ê³„ì•½ ë²ˆí˜¸
      const cNo = c.contract_number || '-';

      // [ìˆ˜ì •] ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ë ˆì´ì•„ì›ƒ (index.html í—¤ë”ì™€ flex ë¹„ìœ¨ì„ ë§ì¶°ì•¼ í•¨)
      li.innerHTML = `
        <span class="col-cont-status" style="flex:0 0 70px; text-align:center;"><span class="status-badge ${statusClass}">${escapeHtml(cStatus)}</span></span>
        <span class="col-cont-date" style="flex:0 0 85px; text-align:center;">${cDate}</span>
        <span class="col-cont-term" style="flex:0 0 40px; text-align:center;">${cTerm}</span>
        <span class="col-cont-cust" style="flex:0 0 100px; text-align:center; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${escapeHtml(custName)}">${escapeHtml(custName)}</span>
        <span class="col-cont-car" style="flex:1; padding-left:5px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${escapeHtml(cModel)}">${escapeHtml(cModel)}</span>
        <span class="col-cont-no" style="flex:0 0 70px; text-align:center; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${escapeHtml(cNo)}">${escapeHtml(cNo)}</span>
      `;
      ul.appendChild(li);
    });
  }

  function renderGlobalContracts(contracts, isNew) {
    const div = document.getElementById('globalContractList');
    if (!div) return;

    if (isNew) {
        div.innerHTML = '';
    }

    if ((!contracts || contracts.length === 0) && isNew) {
        div.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">ì¡°íšŒëœ ê³„ì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    contracts.forEach(c => {
        const custName = (c.customers && c.customers.customer_name) ? c.customers.customer_name : '(ë¯¸í™•ì¸)';
        const dbType = (c.customers && c.customers.db_type) ? c.customers.db_type : '-';
        const cDate = formatDate(c.contract_date);
        const cStatus = c.contract_status || '-';
        
        // [ìˆ˜ì •] ê³„ì•½ ëª©ë¡ì—ë„ ìƒ‰ìƒ ë¡œì§ ì ìš© (ëˆ„ë½ë˜ì—ˆë˜ ë¶€ë¶„)
        const statusClass = getStatusClass(cStatus);

        const row = document.createElement('div');
        row.className = 'contract-row';
        row.onclick = () => viewContractDetail(c, 'contract_list');

        row.innerHTML = `
          <span class="col-cont-status"><span class="status-badge ${statusClass}">${escapeHtml(cStatus)}</span></span>
          <span class="col-cont-date">${cDate}</span>
          <span class="col-cont-term">${escapeHtml(c.contract_term)}</span>
          <span class="col-cont-cust">${escapeHtml(custName)}</span>
          <span class="col-cont-car" title="${escapeHtml(c.contract_car_model)}">${escapeHtml(c.contract_car_model)}</span>
          <span class="col-cont-receipt">${escapeHtml(c.contract_receipt_source)}</span>
          <span class="col-cont-source">${escapeHtml(c.lead_source)}</span>
          <span class="col-cont-db">${escapeHtml(dbType)}</span>
        `;
        div.appendChild(row);
    });
  }

  async function viewContractDetail(contractData, source = 'contract_list') {
    currentViewingContract = contractData;
    currentContractSource = source;

    document.getElementById('listPanel').classList.add('hidden');
    if(document.getElementById('contractListPanel')) document.getElementById('contractListPanel').classList.add('hidden');
    document.getElementById('customerDetailPanel').classList.add('hidden');
    document.getElementById('contractDetailPanel').classList.remove('hidden');

    const backBtn = document.getElementById('dynamicBackBtn');
    if(backBtn) {
        if(source === 'customer_detail') {
            backBtn.innerHTML = '&larr; ê³ ê° ìƒì„¸ë¡œ ëŒì•„ê°€ê¸°';
        } else {
            backBtn.innerHTML = '&larr; ê³„ì•½ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°';
        }
    }

    const setTxt = (id, txt) => {
        const el = document.getElementById(id);
        if(el) el.textContent = (txt === undefined || txt === null || txt === '') ? '-' : txt;
    };

    const setVal = (id, val) => {
        const el = document.getElementById(id);
        if(el) el.value = val || '';
    };

    const formatMoney = (val) => val ? Number(val).toLocaleString() + 'ì›' : '0ì›';

    setVal('detailContractStatus', contractData.contract_status);

    setTxt('viewContStatus', contractData.contract_status);
    setTxt('viewContDate', formatDate(contractData.contract_date));
    setTxt('viewContCar', contractData.contract_car_model);
    setTxt('viewContProductName', contractData.product_name);
    setTxt('viewContTerm', contractData.contract_term ? contractData.contract_term + 'ê°œì›”' : '-');
    setTxt('viewContAmount', formatMoney(contractData.contract_amount));
    
    setTxt('viewContCarPrice', formatMoney(contractData.car_price));
    setTxt('viewContColors', `${contractData.exterior_color || '-'} / ${contractData.interior_color || '-'}`);
    setTxt('viewContDeposit', contractData.deposit_info);
    setTxt('viewContAcquisition', contractData.acquisition_price ? formatMoney(contractData.acquisition_price) : '-');
    setTxt('viewContMileage', contractData.agreed_mileage);
    setTxt('viewContMaintPenalty', `${contractData.maintenance_product || '-'} / ${contractData.penalty_rate || '-'}`);

    setTxt('viewContNumber', contractData.contract_number);
    setTxt('viewContApproval', contractData.approval_number);
    setTxt('viewContInputDate', contractData.input_date);
    setTxt('viewContReceiptSource', contractData.contract_receipt_source || contractData.contract_receipt_date); 
    setTxt('viewContLeadSource', contractData.lead_source);
    setTxt('viewContCommission', formatMoney(contractData.commission));

    setTxt('viewContSummary', contractData.contract_summary);
    
    const realContractorName = (contractData.customers && contractData.customers.customer_name) 
                               ? contractData.customers.customer_name 
                               : '(ì •ë³´ ì—†ìŒ)';
    const relation = contractData.relationship || 'ë³¸ì¸';

    setTxt('viewContRealName', realContractorName); 
    setTxt('viewContRelation', relation);           

    const contractorId = contractData.assignment_id; 
    const consultantId = contractData.consultant_id || contractData.assignment_id;

    if (contractorId === consultantId) {
        setTxt('viewContCustomerName', realContractorName);
    } else {
        const isViewingConsultantPage = (currentAssignmentId === consultantId);
        if (source === 'customer_detail' && isViewingConsultantPage) {
             const currentCustName = document.getElementById('detailCustomerNameText').textContent;
             setTxt('viewContCustomerName', currentCustName);
        } else {
             setTxt('viewContCustomerName', '(ì¡°íšŒ ì¤‘...)');
             const { data: consultantData } = await supabase.from('customers').select('customer_name').eq('assignment_id', consultantId).maybeSingle();
             if (consultantData) setTxt('viewContCustomerName', consultantData.customer_name);
             else setTxt('viewContCustomerName', '(ì •ë³´ ì—†ìŒ)');
        }
    }

    const singleBtnArea = document.getElementById('singleButtonArea');
    const dualBtnArea = document.getElementById('dualButtonArea');
    
    if (contractorId !== consultantId) {
          singleBtnArea.classList.add('hidden');
          dualBtnArea.classList.remove('hidden');
          const contractorLabelName = (contractData.customers && contractData.customers.customer_name) ? contractData.customers.customer_name : 'ì‹¤ê³„ì•½ì';
          document.getElementById('goToContractorBtn').innerHTML = `ğŸ“‘ ì‹¤ê³„ì•½ì(${contractorLabelName}) &rarr;`;
    } else {
          singleBtnArea.classList.remove('hidden');
          dualBtnArea.classList.add('hidden');
    }
  }

  function switchTab(mode) {
    const customerPanel = document.getElementById('listPanel');
    const contractPanel = document.getElementById('contractListPanel');
    const custDetailPanel = document.getElementById('customerDetailPanel');
    const contDetailPanel = document.getElementById('contractDetailPanel');
    const addContractPanel = document.getElementById('addContractPanel');
    
    custDetailPanel.classList.add('hidden');
    contDetailPanel.classList.add('hidden');
    if(addContractPanel) addContractPanel.classList.add('hidden');
    
    const btnCust = document.getElementById('tabCustomerBtn');
    const btnCont = document.getElementById('tabContractBtn');

    window.customerDetailSource = null;
    currentContractSource = 'contract_list';

    if (mode === 'customer') {
      customerPanel.classList.remove('hidden');
      if(contractPanel) contractPanel.classList.add('hidden');
      btnCust.classList.add('active'); 
      btnCont.classList.remove('active');
      fetchCustomers(true);
    } else {
      customerPanel.classList.add('hidden');
      if(contractPanel) contractPanel.classList.remove('hidden');
      btnCust.classList.remove('active');
      btnCont.classList.add('active');
      fetchGlobalContracts(true);
    }
  }

  function openAddContractScreen(source) {
    window.contractAddSource = source; 
    if (!currentAssignmentId) {
        alert("ê³„ì•½ì„ ì¶”ê°€í•  ê³ ê°ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return; 
    }
    
    document.getElementById('isDifferentContractor').checked = false;
    document.getElementById('realContractorForm').classList.add('hidden');
    
    const inputs = document.querySelectorAll('#addContractPanel input, #addContractPanel textarea');
    inputs.forEach(el => {
        if(el.type !== 'button' && el.type !== 'file' && el.type !== 'checkbox') el.value = '';
    });
    
    document.getElementById('listPanel').classList.add('hidden');
    document.getElementById('contractListPanel').classList.add('hidden');
    document.getElementById('customerDetailPanel').classList.add('hidden');
    document.getElementById('contractDetailPanel').classList.add('hidden');
    
    document.getElementById('addContractPanel').classList.remove('hidden');
  }

  function closeAddContractScreen() {
    document.getElementById('addContractPanel').classList.add('hidden');
    
    if (window.contractAddSource === 'customer_detail') {
        document.getElementById('customerDetailPanel').classList.remove('hidden');
    } else if (window.contractAddSource === 'contract_list') {
        document.getElementById('contractListPanel').classList.remove('hidden');
    } else {
        document.getElementById('listPanel').classList.remove('hidden');
    }
  }

  function fillContractModal(data) {
    if(!data) return;
    const item = Array.isArray(data) ? data[0] : data;
    
    const setVal = (id, val) => {
        const el = document.getElementById(id);
        if(!el) return;
        if(val !== undefined && val !== null) {
            el.value = val;
            el.style.backgroundColor = "#e8f0fe"; 
            setTimeout(() => el.style.backgroundColor = "", 2000);
        }
    };
    
    setVal('modalContractDate', item.contract_date);
    setVal('modalContractAmount', item.contract_amount);
    setVal('modalContractCarModel', item.contract_car_model);
    setVal('modalContractTerm', item.contract_term);
    setVal('modalContractSummary', item.contract_summary);
    
    setVal('modalProductName', item.product_name);
    setVal('modalExteriorColor', item.exterior_color);
    setVal('modalInteriorColor', item.interior_color);
    setVal('modalCarPrice', item.car_price);
    setVal('modalAgreedMileage', item.agreed_mileage);
    setVal('modalAcquisitionPrice', item.acquisition_price);
    setVal('modalDepositInfo', item.deposit_info);
    setVal('modalPenaltyRate', item.penalty_rate);
    setVal('modalMaintenanceProduct', item.maintenance_product);
    
    if(item.contract_receipt_source) setVal('modalContractReceiptSource', item.contract_receipt_source);

    if (item.real_contractor_name) {
        const chk = document.getElementById('isDifferentContractor');
        if(chk && !chk.checked) chk.click(); 
        setVal('realContractorName', item.real_contractor_name);
        setVal('realContractorPhone', item.real_contractor_phone);
    }
  }

  // ============================================================================
  // [6] ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ëª¨ìŒ
  // ============================================================================
  function setupGlobalEventListeners() {
    
    const tabCustomerBtn = document.getElementById('tabCustomerBtn');
    const tabContractBtn = document.getElementById('tabContractBtn');
    if(tabCustomerBtn) tabCustomerBtn.addEventListener('click', () => switchTab('customer'));
    if(tabContractBtn) tabContractBtn.addEventListener('click', () => switchTab('contract'));
    
    const searchContractBtn = document.getElementById('searchContractBtn');
    if(searchContractBtn) searchContractBtn.addEventListener('click', () => fetchGlobalContracts(true));

    const openBtnDetail = document.getElementById('openAddContractModalBtn');
    if(openBtnDetail) {
        openBtnDetail.addEventListener('click', () => {
             openAddContractScreen('customer_detail');
        });
    }

    const openBtnList = document.getElementById('openAddContractPageFromListBtn');
    if(openBtnList) {
        openBtnList.addEventListener('click', () => {
             openAddContractScreen('contract_list');
        });
    }

    document.getElementById('backFromAddContractBtn').addEventListener('click', (e) => {
        e.preventDefault();
        closeAddContractScreen();
    });
    document.getElementById('cancelAddContractPageBtn').addEventListener('click', () => {
        closeAddContractScreen();
    });

    document.getElementById('isDifferentContractor').addEventListener('change', (e) => {
        const form = document.getElementById('realContractorForm');
        if(e.target.checked) form.classList.remove('hidden'); else form.classList.add('hidden');
    });

    document.getElementById('saveNewContractPageBtn').addEventListener('click', async () => {
        saveNewContractLogic(); 
    });

    // 1. ìŒì„± ë¶„ì„
    const btnAnalyze = document.getElementById('btnAnalyzeVoice');
    const fileInput = document.getElementById('voiceFileInput');
    if (btnAnalyze && fileInput) {
        btnAnalyze.addEventListener('click', () => {
             fileInput.value = ''; 
             fileInput.click();
        });
        fileInput.addEventListener('change', async (e) => {
             const file = e.target.files[0];
             if (!file) return;
             if (!confirm(`'${file.name}' ìŒì„± ë¶„ì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
             
             showLoader();
             try {
                 const data = await uploadAndAnalyzeFile(file, 'consultation');
                 onAnalysisSuccess({ success: true, data: data });
             } catch (err) {
                 alert("âŒ ì˜¤ë¥˜: " + err.message);
             } finally {
                 hideLoader();
             }
        });
    }

    // 2. ê³„ì•½ì„œ ë¶„ì„
    const btnContract = document.getElementById('btnAnalyzeContract');
    const inputContract = document.getElementById('contractFileInput');
    if(btnContract && inputContract) {
        btnContract.addEventListener('click', () => {
            inputContract.value = '';
            inputContract.click();
        });
        inputContract.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            if(!confirm(`'${file.name}' ê³„ì•½ì„œë¥¼ ë¶„ì„í•˜ì—¬ ë‚´ìš©ì„ ìë™ìœ¼ë¡œ ì±„ìš¸ê¹Œìš”?`)) return;
            
            showLoader();
            try {
                const data = await uploadAndAnalyzeFile(file, 'contract');
                fillContractModal(data); 
                alert("âœ… ê³„ì•½ì„œ ë¶„ì„ ì™„ë£Œ!");
            } catch(err) {
                alert("âŒ ë¶„ì„ ì‹¤íŒ¨: " + err.message);
            } finally {
                hideLoader();
            }
        });
    }

    const loginBtn = document.getElementById('googleLoginBtn');
    if(loginBtn) {
      loginBtn.addEventListener('click', async () => {
        const redirectUrl = document.body.dataset.scriptUrl || "https://script.google.com/macros/s/AKfycbwV96l1hMuWCUMn4vLHPxvC6XM0NeKh1YREjZp1sYMgYqHL0F2JohW63NI0Rf5vWI5a/exec";
        const { data, error } = await supabase.auth.signInWithOAuth({
          provider: 'google',
          options: { redirectTo: redirectUrl, skipBrowserRedirect: true, queryParams: { access_type: 'offline', prompt: 'consent' } }
        });
        if (error) alert(error.message);
        else if (data.url) window.open(data.url, '_blank');
      });
    }
    
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
        const { error } = await supabase.auth.signOut();
        if (error) alert("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: " + error.message);
        else { alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤."); window.location.reload(); }
      });
    }

    document.getElementById('applyFilterBtn').addEventListener('click', () => fetchCustomers(true));
    document.getElementById('loadMoreBtn').addEventListener('click', () => fetchCustomers(false));
    document.getElementById('resetFilterBtn').addEventListener('click', () => {
        const setVal = (id, v) => { const el = document.getElementById(id); if(el) el.value = v; };
        setVal('filterSearchTerm', '');
        setVal('filterDbType', '');
        setVal('filterLeadSource', '');
        setVal('filterCustomerStatus', '');
        setVal('filterAssignmentDateFrom', ''); 
        setVal('filterAssignmentDateTo', '');
        setVal('filterLastLogDateFrom', '');
        setVal('filterLastLogDateTo', '');
        fetchCustomers(true);
    });

    document.getElementById('backToListBtn').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('customerDetailPanel').classList.add('hidden');
      if (window.customerDetailSource === 'contractDetailPanel') {
          document.getElementById('contractDetailPanel').classList.remove('hidden');
      } else {
          document.getElementById('listPanel').classList.remove('hidden');
          // [ìˆ˜ì •] ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°ˆ ë•Œ ë°ì´í„° ê°±ì‹  (ì €ì¥ ë‚´ìš© ë°˜ì˜)
          fetchCustomers(true);
      }
    });

    const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };

    document.getElementById('saveCustomerDetailsBtn').addEventListener('click', async (e) => {
      if(!currentAssignmentId) return;
      const updates = {
        customer_type: getVal('customerType'),
        gender: getVal('gender'),
        age_group: getVal('ageGroup'),
        address_city: getVal('addressCity'),
        income_type: getVal('incomeType'),
        credit_info: getVal('creditInfo'),
        interested_car_model: getVal('interestedCarModel'),
        comparison_car_model: getVal('comparisonCarModel'),
        owned_car_model: getVal('ownedCarModel'),
        car_usage: getVal('carUsage'),
        driver_scope: getVal('driverScope'),
        driving_distance: getVal('drivingDistance'),
        expected_contract_timing: getVal('expectedContractTiming'),
        desired_contract_term: getVal('desiredContractTerm'),
        desired_initial_cost_type: getVal('desiredInitialCostType'),
        maintenance_service_level: getVal('maintenanceServiceLevel'),
        customer_status: getVal('customerStatus'),
        customer_memo: getVal('customerMemo'),
        quote_number: getVal('quoteNumber'),
        approval_number: getVal('approvalNumber'),
        lead_source: getVal('leadSource'),
        occupation: getVal('occupation'),
        updated_at: new Date().toISOString()
      };
      
      showLoader();
      const { data, error } = await supabase
          .from('customers')
          .update(updates)
          .eq('assignment_id', currentAssignmentId)
          .eq('updated_at', currentDataTimestamp) 
          .select();

      hideLoader();
      if (error) {
        handleFailure(error);
      } else if (!data || data.length === 0) {
          alert("ğŸš¨ ë°ì´í„° ì¶©ëŒ ë°œìƒ! (ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ìˆ˜ì •í•¨)");
      } else {
        showSaveFeedback(e.target);
        currentDataTimestamp = data[0].updated_at;
      }
    });

    document.getElementById('addLogBtn').addEventListener('click', async () => {
      if(!currentAssignmentId) return;
      const txt = document.getElementById('newLogContent').value.trim();
      if(!txt) return alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
      
      showLoader();
      const nowISO = new Date().toISOString(); 
      const newLog = {
        log_id: 'LOG_' + Date.now(),
        assignment_id: currentAssignmentId,
        log_content: txt,
        user_name: currentUserName,
        log_timestamp: nowISO
      };
      const { error: logError } = await supabase.from('consultation_logs').insert([newLog]);
      if(logError) { handleFailure(logError); return; } 
      await supabase.from('customers').update({ last_log_date: nowISO, updated_at: nowISO }).eq('assignment_id', currentAssignmentId);
      hideLoader();
      document.getElementById('newLogContent').value = '';
      selectCustomer(currentAssignmentId); 
    });

    document.getElementById('savePhoneNumberBtn').addEventListener('click', async(e) => {
      if(!currentAssignmentId) return;
      const rawPhone = document.getElementById('detailCustomerPhoneNumber').value.replace(/\D/g, "");
      showLoader();
      const { error } = await supabase.from('customers').update({ customer_phone: rawPhone }).eq('assignment_id', currentAssignmentId);
      hideLoader();
      if(error) handleFailure(error);
      else showSaveFeedback(e.target);
    });

    document.getElementById('openAddCustomerModalBtn').addEventListener('click', () => document.getElementById('addCustomerModal').classList.remove('hidden'));
    document.getElementById('cancelAddCustomerBtn').addEventListener('click', () => document.getElementById('addCustomerModal').classList.add('hidden'));
    
    document.getElementById('saveNewCustomerBtn').addEventListener('click', async () => {
      const name = document.getElementById('newCustomerName').value;
      let phone = document.getElementById('newCustomerPhoneNumber').value.replace(/\D/g, "");
      const dbType = document.getElementById('newDbType').value;
      const leadSourceVal = document.getElementById('newLeadSource').value; 

      if(!name) return alert('ì´ë¦„ í•„ìˆ˜');

      showLoader();
      const ts = Date.now();
      const nowISO = new Date().toISOString();
      const { error } = await supabase.from('customers').insert([{
        assignment_id: "A_" + ts,
        customer_id: "C_" + ts,
        customer_name: name,
        customer_phone: formatPhoneNumber_Client(phone),
        db_type: dbType,
        lead_source: leadSourceVal, 
        assigned_to: currentUserName,
        owner_email: currentUserEmail,
        assignment_date: nowISO,
        customer_status: "ë°°ì •ë¨",
        updated_at: nowISO 
      }]);
      hideLoader();
      if(error) handleFailure(error);
      else {
        document.getElementById('addCustomerModal').classList.add('hidden');
        fetchCustomers(true);
      }
    });
    
    document.getElementById('newCustomerPhoneNumber').addEventListener('blur', (e) => { e.target.value = formatPhoneNumber_Client(e.target.value); });

    const goToCustBtn = document.getElementById('goToCustomerDetailBtn');
    if (goToCustBtn) {
        goToCustBtn.addEventListener('click', () => {
             if (currentViewingContract && currentViewingContract.assignment_id) {
                 window.customerDetailSource = 'contractDetailPanel';
                 selectCustomer(currentViewingContract.assignment_id);
             } else { alert("ì´ ê³„ì•½ì— ì—°ê²°ëœ ê³ ê° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
        });
    }

    const goToContractorBtn = document.getElementById('goToContractorBtn');
    if(goToContractorBtn) {
        goToContractorBtn.addEventListener('click', () => {
            if (currentViewingContract && currentViewingContract.assignment_id) {
                window.customerDetailSource = 'contractDetailPanel';
                selectCustomer(currentViewingContract.assignment_id);
            } else { alert("ì—°ê²°ëœ ì‹¤ê³„ì•½ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."); }
        });
    }

    const goToConsultantBtn = document.getElementById('goToConsultantBtn');
    if(goToConsultantBtn) {
        goToConsultantBtn.addEventListener('click', () => {
            if (currentViewingContract && currentViewingContract.consultant_id) {
                window.customerDetailSource = 'contractDetailPanel';
                selectCustomer(currentViewingContract.consultant_id);
            } else { alert("ì—°ê²°ëœ ìƒë‹´ ê³ ê° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."); }
        });
    }

    const handleSort = (column, iconId) => {
        if (currentSortColumn === column) currentSortAscending = !currentSortAscending;
        else { currentSortColumn = column; currentSortAscending = false; }
        document.getElementById('sortIconLastLog').textContent = '';
        document.getElementById('sortIconAssignmentDate').textContent = '';
        document.getElementById(iconId).textContent = currentSortAscending ? 'â–²' : 'â–¼';
        fetchCustomers(true);
    };

    const btnLastLog = document.getElementById('sortLastLogBtn');
    if (btnLastLog) btnLastLog.addEventListener('click', () => handleSort('last_log_date', 'sortIconLastLog'));

    const btnAssignDate = document.getElementById('sortAssignmentDateBtn');
    if (btnAssignDate) btnAssignDate.addEventListener('click', () => handleSort('assignment_date', 'sortIconAssignmentDate'));

    const backBtn = document.getElementById('dynamicBackBtn');
    if(backBtn) {
        backBtn.addEventListener('click', (e) => {
            e.preventDefault(); 
            document.getElementById('contractDetailPanel').classList.add('hidden');
            if(currentContractSource === 'customer_detail') {
                document.getElementById('customerDetailPanel').classList.remove('hidden');
            } else {
                document.getElementById('contractListPanel').classList.remove('hidden');
            }
        });
    }

    const btnUpdateStatus = document.getElementById('btnUpdateContractStatus');
    if(btnUpdateStatus) {
        btnUpdateStatus.addEventListener('click', async () => {
            if(!currentViewingContract || !currentViewingContract.contract_id) return;
            
            const newStatus = document.getElementById('detailContractStatus').value;
            if(!newStatus) return alert("ë³€ê²½í•  ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            
            if(!confirm(`ê³„ì•½ ìƒíƒœë¥¼ '[${newStatus}]'ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            showLoader();
            try {
                const { error } = await supabase
                    .from('contracts')
                    .update({ contract_status: newStatus })
                    .eq('contract_id', currentViewingContract.contract_id);

                if(error) throw error;

                alert("âœ… ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                currentViewingContract.contract_status = newStatus;
                
                if(currentContractSource === 'contract_list') fetchGlobalContracts(false);
                else if(currentAssignmentId) selectCustomer(currentAssignmentId);

            } catch(e) {
                handleFailure(e);
            } finally {
                hideLoader();
            }
        });
    }

    setupContractAnalysisListener();
  }

  // DOMContentLoaded & Init
  document.addEventListener('DOMContentLoaded', async () => {
    google.script.url.getLocation(async function(location) {
        const hash = location.hash; 
        if (hash && hash.includes('access_token')) {
            const loginModal = document.getElementById('loginModal');
            if(loginModal) loginModal.classList.add('hidden');
            const params = new URLSearchParams(hash.startsWith('#') ? hash.substring(1) : hash);
            const accessToken = params.get('access_token');
            const refreshToken = params.get('refresh_token');
            if (accessToken) {
                const { error } = await supabase.auth.setSession({ access_token: accessToken, refresh_token: refreshToken || '' });
                if (!error) {
                    document.body.innerHTML = `<div style="height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center;"><h2>âœ… ë¡œê·¸ì¸ ì„±ê³µ!</h2><button onclick="window.open('', '_self').close()">ì°½ ë‹«ê¸°</button></div>`;
                    setTimeout(() => window.open('', '_self').close(), 1000);
                    return; 
                }
            }
        }
        initApp();
    });
  });

  async function initApp() {
    await populateSelectOptions();
    const dateFromEl = document.getElementById('filterAssignmentDateFrom');
    if (dateFromEl) {
      const today = new Date();
      const prev = new Date(); prev.setMonth(today.getMonth()-3);
      dateFromEl.value = prev.toISOString().split('T')[0];
    }
    setupGlobalEventListeners();
    const { data } = await supabase.auth.getSession();
    if (data.session) onSessionValid(data.session);
    else document.getElementById('loginModal').classList.remove('hidden');
    
    supabase.auth.onAuthStateChange((event, sess) => {
        if (event === 'SIGNED_IN' && sess) onSessionValid(sess);
        else if (event === 'SIGNED_OUT') document.getElementById('loginModal').classList.remove('hidden');
    });
  }

  async function onSessionValid(sess) {
    session = sess;
    currentUserEmail = sess.user.email;
    document.getElementById('loginModal').classList.add('hidden');
    const { data } = await supabase.from('profiles').select('korean_name').eq('email', currentUserEmail).maybeSingle();
    currentUserName = data ? data.korean_name : currentUserEmail;
    fetchCustomers(true);
  }
